"use strict";(self.webpackChunkkubegems_docs=self.webpackChunkkubegems_docs||[]).push([[2372],{3905:function(e,n,t){t.d(n,{Zo:function(){return s},kt:function(){return m}});var r=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=r.createContext({}),p=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},s=function(e){var n=p(e.components);return r.createElement(l.Provider,{value:n},e.children)},_={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),u=p(t),m=i,f=u["".concat(l,".").concat(m)]||u[m]||_[m]||a;return t?r.createElement(f,o(o({ref:n},s),{},{components:t})):r.createElement(f,o({ref:n},s))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,o=new Array(a);o[0]=u;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c.mdxType="string"==typeof e?e:i,o[1]=c;for(var p=2;p<a;p++)o[p]=t[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},67146:function(e,n,t){t.r(n),t.d(n,{assets:function(){return s},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return c},metadata:function(){return p},toc:function(){return _}});var r=t(87462),i=t(63366),a=(t(67294),t(3905)),o=["components"],c={title:"\u914d\u7f6eLinux\u5185\u6838",hide_title:!0,sidebar_position:1},l=void 0,p={unversionedId:"installation/more-install-guides/kernel-optimize",id:"installation/more-install-guides/kernel-optimize",title:"\u914d\u7f6eLinux\u5185\u6838",description:"Linux\u5185\u6838\u4f18\u5316",source:"@site/docs/installation/more-install-guides/kernel-optimize.md",sourceDirName:"installation/more-install-guides",slug:"/installation/more-install-guides/kernel-optimize",permalink:"/docs/installation/more-install-guides/kernel-optimize",editUrl:"https://github.com/kubegems/kubegems.io/edit/main/docs/installation/more-install-guides/kernel-optimize.md",tags:[],version:"current",lastUpdatedBy:"Smlion",lastUpdatedAt:1646123745,formattedLastUpdatedAt:"2022/3/1",sidebarPosition:1,frontMatter:{title:"\u914d\u7f6eLinux\u5185\u6838",hide_title:!0,sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"\u4f7f\u7528 Kind \u5b89\u88c5",permalink:"/docs/installation/kubernetes-installation/kind"},next:{title:"\u914d\u7f6eInstaller",permalink:"/docs/installation/more-install-guides/installer-config"}},s={},_=[{value:"Linux\u5185\u6838\u4f18\u5316",id:"linux\u5185\u6838\u4f18\u5316",level:2},{value:"\u4fee\u6539sysctl.conf",id:"\u4fee\u6539sysctlconf",level:3},{value:"\u751f\u6548\u914d\u7f6e",id:"\u751f\u6548\u914d\u7f6e",level:3}],u={toc:_};function m(e){var n=e.components,t=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"linux\u5185\u6838\u4f18\u5316"},"Linux\u5185\u6838\u4f18\u5316"),(0,a.kt)("hr",null),(0,a.kt)("p",null,"Linux kernel\u53c2\u6570\u4f18\u5316\u662f\u4e3aKubeGems worker\u8282\u70b9\u66f4\u597d\u3001\u7a33\u5b9a\u7684\u670d\u52a1\u5bb9\u5668\u800c\u603b\u7ed3\u51fa\u6765\u7684\u4e00\u5957\u5185\u6838\u4f18\u5316\u57fa\u7ebf\u3002\u5176\u4e2d\u90e8\u5206\u53c2\u6570\u6d89\u53ca\u5230\u673a\u5668\u6027\u80fd\u7684\u52a8\u6001\u8c03\u6574\uff0c\u6587\u6863\u91cc\u4f1a\u7ed9\u51fa\u8ba1\u7b97\u516c\u5f0f\uff0c\u8bf7\u8bfb\u8005\u81ea\u884c\u6839\u636e\u60c5\u51b5\u8f6c\u6362\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# \u8ba1\u7b97\u5185\u5b58\u603b\u91cf\nmem_total_bytes = memtotal_mb * 1024 * 1024\n")),(0,a.kt)("h3",{id:"\u4fee\u6539sysctlconf"},"\u4fee\u6539sysctl.conf"),(0,a.kt)("p",null,"\u4f7f\u7528vim\u6253\u5f00\u5e76\u7f16\u8f91",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/sysctl.conf"),"\u6587\u4ef6"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'kernel.panic = 10\nkernel.panic_on_oops = 10\nkernel.sysrq=0\n# \u6700\u5927\u8fdb\u7a0b\u6570\n#\u7528\u547d\u4ee4ps -eLf | wc -l \u67e5\u770b\u5f53\u524d\u5b9e\u9645 PID \u6570\u91cf\uff0c\u68c0\u67e5\u5f53\u524d\u7528\u6237\u7684 PID \u6570\u91cf\nkernel.pid_max=196605\n#\u6700\u5927\u7ebf\u7a0b\u6570\nkernel.threads_max=196605\nkernel.ctrl-alt-del=1\n#\u6253\u5f00coredns\nkernel.core_pattern=/var/log/core.%e.%p.%t\nkernel.shmmax = {{ mem_total_bytes//2 }}\nkernel.shmall = {{ mem_total_bytes//2//4096 }}\nkernel.msgmnb = 65536\nkernel.msgmax = 65536\n\nfs.file-max = 1048576\n#\u6bcf\u4e2a linux \u8fdb\u7a0b\u53ef\u4ee5\u6301\u6709\u591a\u4e2a fd\uff0c\u6bcf\u4e2a inotify \u7c7b\u578b\u7684 fd \u53ef\u4ee5 watch \u591a\u4e2a\u76ee\u5f55\uff0c\u6bcf\u4e2a\u7528\u6237\u4e0b\u6240\u6709\u8fdb\u7a0b inotify \u7c7b\u578b\u7684 fd \u53ef\u4ee5 watch \u7684\u603b\u76ee\u5f55\u6570\u6709\u4e2a\u6700\u5927\u9650\u5236\nfs.inotify.max_user_instances=524288\nfs.inotify.max_user_watches=524288\n#\u5982\u679cwattch\u6570\u8fc7\u591a\u53ef\u4ee5\u6253\u5f00 inotify_add_watch \u8ddf\u8e2a\uff0c\u8fdb\u4e00\u6b65 debug inotify watch \u8017\u5c3d\u7684\u539f\u56e0:\n#echo 1 >> /sys/kernel/debug/tracing/events/syscalls/sys_exit_inotify_add_watch/enable\n\n#\u5173\u95edswap\u7a7a\u95f4\nvm.swappiness = 0\nvm.max_map_count=1048575\nvm.dirty_ratio = 60\nvm.dirty_background_ratio = 5\nvm.min_free_kbytes = {{ mem_total_bytes//1024//100*5 }}\n\nnet.ipv4.tcp_syncookies = 1\nnet.ipv4.tcp_synack_retries = 2\nnet.ipv4.tcp_dsack = 1\nnet.ipv4.tcp_sack = 0\nnet.ipv4.tcp_fack = 1\nnet.ipv4.conf.all.forwarding = 1\nnet.ipv4.conf.default.forwarding = 1\nnet.ipv4.ip_forward = 1\nnet.ipv4.conf.all.send_redirects = 0\nnet.ipv4.conf.default.send_redirects = 0\nnet.ipv4.conf.all.accept_source_route = 0\nnet.ipv4.conf.default.accept_source_route = 0\nnet.ipv4.conf.all.rp_filter = 0\nnet.ipv4.conf.default.rp_filter = 0\nnet.ipv4.conf.all.accept_redirects = 0\nnet.ipv4.conf.default.accept_redirects = 0\nnet.ipv4.conf.all.secure_redirects = 0\nnet.ipv4.conf.default.secure_redirects = 0\nnet.ipv4.conf.all.bootp_relay = 0\nnet.ipv4.conf.all.proxy_arp = 0\nnet.ipv4.icmp_echo_ignore_broadcasts = 1\nnet.ipv4.icmp_ignore_bogus_error_responses = 1\n\nnet.ipv4.tcp_rfc1337 = 1\nnet.ipv4.tcp_congestion_control = cubic\nnet.core.default_qdisc = pfifo_fast\nnet.ipv4.tcp_ecn = 2\nnet.ipv4.tcp_reordering = 3\nnet.ipv4.tcp_retries2 = 8\nnet.ipv4.tcp_retries1 = 3\nnet.ipv4.tcp_no_metrics_save = 1\nnet.ipv4.tcp_slow_start_after_idle = 0\nnet.ipv4.tcp_fin_timeout = 10\n#tcp_keepalive_time\u9700\u8981\u4f4e\u4e8eipvs\u4e2d\u7684tcp_timeout\u65f6\u957f\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u8981\u4f4e\u4e8ekube-proxy lvs\u7684900s\nnet.ipv4.tcp_keepalive_time = 600\nnet.ipv4.tcp_keepalive_probes = 5\nnet.ipv4.tcp_keepalive_intvl = 15\nnet.ipv4.ip_local_port_range = 20000 65535\n#\u9884\u7559\u7ed9kubernetes service\u7684nodeport\u7aef\u53e3\u8303\u56f4\uff0c\u4e0d\u8bbe\u7f6e\u53ef\u80fd\u4f1a\u9020\u6210\n#kubernetes\u5728\u505a\u670d\u52a1\u63a2\u9488\u65f6\u4f7f\u7528\u4e0b\u5217\u8303\u56f4\u7aef\u53e3\uff0c\u9020\u6210\u8fde\u63a5\u88ab\u5360\u7528\u800c\u5931\u8d25\uff0c\u5f15\u8d77\u63a2\u9488\u5931\u6548\nnet.ipv4.ip_local_reserved_ports = 30000-32768\n\n# \u6bcf\u4e2a\u7f51\u7edc\u63a5\u53e3\u63a5\u6536\u6570\u636e\u5305\u7684\u901f\u7387\u6bd4\u5185\u6838\u5904\u7406\u8fd9\u4e9b\u5305\u7684\u901f\u7387\u5feb\u65f6\uff0c\u5141\u8bb8\u9001\u5230\u961f\u5217\u7684\u6570\u636e\u5305\u7684\u6700\u5927\u6570\u76ee\nnet.core.netdev_max_backlog = 16384\n#\u6ca1\u6709\u542f\u7528syncookies\u7684\u60c5\u51b5\u4e0b\uff0csyn queue(\u534a\u8fde\u63a5\u961f\u5217)\u5927\u5c0f\u9664\u4e86\u53d7somaxconn\u9650\u5236\u5916\uff0c\u4e5f\u53d7\u8fd9\u4e2a\u53c2\u6570\u7684\u9650\u5236\uff0c\u9ed8\u8ba41024\uff0c\u4f18\u5316\u523065535\uff0c\u907f\u514d\u5728\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b\u4e22\u5305\nnet.ipv4.tcp_max_syn_backlog = 65535\n# \u8868\u793asocket\u76d1\u542c(listen)\u7684backlog\u4e0a\u9650\uff0c\u4e5f\u5c31\u662f\u5c31\u662fsocket\u7684\u76d1\u542c\u961f\u5217(accept queue)\uff0c\u5f53\u4e00\u4e2atcp\u8fde\u63a5\u5c1a\u672a\u88ab\u5904\u7406\u6216\u5efa\u7acb\u65f6(\u534a\u8fde\u63a5\u72b6\u6001)\n#\u4f1a\u4fdd\u5b58\u5728\u8fd9\u4e2a\u76d1\u542c\u961f\u5217\uff0c\u9ed8\u8ba4\u4e3a 128\uff0c\u5728\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b\u504f\u5c0f\uff0c\u4f18\u5316\u5230 16384\u3002\u53c2\u8003 https://imroc.io/posts/kubernetes-overflow-and-drop/\nnet.core.somaxconn = 16384\nnet.ipv4.tcp_window_scaling = 1\nnet.ipv4.tcp_adv_win_scale = 2\nnet.ipv4.tcp_rmem = 4096 524287 16777216\nnet.core.rmem_default = 524287\nnet.core.rmem_max = 16777216\nnet.ipv4.tcp_wmem = 4096 524287 16777216\nnet.core.wmem_default = 524287\nnet.core.wmem_max = 16777216\nnet.core.optmem_max = 524287\nnet.ipv4.tcp_fastopen = 3\nnet.ipv4.tcp_timestamps = 1\nnet.ipv4.tcp_tw_recycle = 0\nnet.ipv4.tcp_tw_reuse = 0\nnet.ipv4.tcp_max_tw_buckets = 360000\n\n# \u5f53\u524d arp \u8bb0\u5f55\u6570\u63a5\u8fd1 gc_thresh3 \u6bd4\u8f83\u5bb9\u6613 overflow\uff0c\u56e0\u4e3a\u5f53 arp \u8bb0\u5f55\u8fbe\u5230 gc_thresh3 \u65f6\u4f1a\u5f3a\u5236\u89e6\u53d1 gc \u6e05\u7406\n#\u5f53\u8fd9\u65f6\u53c8\u6709\u6570\u636e\u5305\u8981\u53d1\u9001\uff0c\u5e76\u4e14\u6839\u636e\u76ee\u7684 IP \u5728 arp cache \u4e2d\u6ca1\u627e\u5230 mac \u5730\u5740\uff0c\u8fd9\u65f6\u4f1a\u5224\u65ad\u5f53\u524d arp cache \u8bb0\u5f55\u6570\u52a0 1 \u662f\u5426\u5927\u4e8e gc_thresh3\n#\u5982\u679c\u6ca1\u6709\u5927\u4e8e\u5c31\u4f1a \u65f6\u5c31\u4f1a\u62a5\u9519: arp_cache: neighbor table overflow!\n# arp -an | wc -l\u53c2\u770barp\u8bb0\u5f55\u6570\nnet.ipv4.neigh.default.gc_thresh3 = 2048\nnet.ipv4.neigh.default.gc_thresh2 = 1024\nnet.ipv4.neigh.default.gc_thresh1 = 128\n#\u5206\u6790\u5982\u679c\u662f\u4e1a\u52a1\u670d\u52a1\u5e38\u89c1\u6027\u7684\u51fa\u73b0"arp_cache: neighbor table overflow!"\uff0c\u5219\u8003\u8651\u63a8\u9001\u5c06\u4e0b\u5217\u6ce8\u91ca\u7684\u53c2\u6570\u63a8\u5012\u6240\u6709Node\u8282\u70b9\n#net.ipv4.neigh.default.gc_thresh1 = 80000\n#net.ipv4.neigh.default.gc_thresh2 = 90000\n#net.ipv4.neigh.default.gc_thresh3 = 100000\nnet.ipv4.neigh.default.gc_interval = 120\nnet.ipv4.route.flush = 1\nnet.ipv4.rt_cache_rebuild_count = -1\n\nnet.netfilter.nf_conntrack_max = 4194304\nnet.nf_conntrack_max = 4194304\nnet.netfilter.nf_conntrack_buckets = 1048576\nnet.netfilter.nf_conntrack_tcp_timeout_fin_wait=30\nnet.netfilter.nf_conntrack_tcp_timeout_time_wait=300\nnet.netfilter.nf_conntrack_tcp_timeout_close_wait=1\n#\u7ef4\u6301\u901a\u8fc7NAT\u7ef4\u6301TCP\u957f\u8fde\u63a5\u7684\u4f18\u5316,\u6ce8\u610fkube-proxy\u4f1a\u4fee\u6539\u6b64\u53c2\u6570\nnet.netfilter.nf_conntrack_tcp_timeout_established=3600\n#tcp_keepalive_time+ tcp_keepalive_interval * tcp_keepalive_max_retry + 2msl\u53d6\u6574\n#https://www.xinmeow.com/2020/05/04/iptables-nf_conntrack-%E6%9D%A1%E7%9B%AE%E7%9A%84%E8%80%81%E5%8C%96%E6%97%B6%E9%97%B4%E5%9B%A0%E8%AF%A5%E8%BF%9E%E6%8E%A5%E5%8F%91%E7%94%9F%E4%B8%A2%E5%8C%85%E8%80%8C%E5%8F%98%E7%9F%AD%EF%BC%8C/\nnet.netfilter.nf_conntrack_tcp_timeout_max_retrans=720\n\nnet.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\n')),(0,a.kt)("h3",{id:"\u751f\u6548\u914d\u7f6e"},"\u751f\u6548\u914d\u7f6e"),(0,a.kt)("p",null,"\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"sysctl -p"),"\u547d\u4ee4\u5373\u65f6\u751f\u6548\u914d\u7f6e"),(0,a.kt)("p",null,"\u6216\u8005"),(0,a.kt)("p",null,"\u6267\u884c",(0,a.kt)("inlineCode",{parentName:"p"},"reboot"),"\u91cd\u542f\u670d\u52a1\u5668\u540e\u5185\u6838\u914d\u7f6e\u751f\u6548"))}m.isMDXComponent=!0}}]);