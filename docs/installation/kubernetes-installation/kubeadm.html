<!doctype html>
<html class="docs-version-current" lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KubeGems RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KubeGems Atom Feed"><title data-rh="true">Kubeadmï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰ | KubeGems</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kubegems.io/docs/installation/kubernetes-installation/kubeadm"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kubeadmï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰ | KubeGems"><meta data-rh="true" name="description" content="ä½¿ç”¨Kubeadmå®‰è£…"><meta data-rh="true" property="og:description" content="ä½¿ç”¨Kubeadmå®‰è£…"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kubegems.io/docs/installation/kubernetes-installation/kubeadm"><link data-rh="true" rel="alternate" href="https://kubegems.io/docs/installation/kubernetes-installation/kubeadm" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kubegems.io/docs/installation/kubernetes-installation/kubeadm" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.cd3646d2.css">
<link rel="preload" href="/assets/js/runtime~main.3cc290b8.js" as="script">
<link rel="preload" href="/assets/js/main.cbbec2e5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/concepts/what-is-kubegems">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/community/support">ç¤¾ç¾¤</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/concepts/what-is-kubegems">v1.20.0-beta.1</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/docs/installation/kubernetes-installation/kubeadm" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="navbar__items navbar__item--dock"><div class="toggle navbar__toggle toggle--disabled" role="button" tabindex="-1"><div class="toggle__icon toggle__icon--unchecked kubegems-icon icon-light"></div><div class="toggle__icon toggle__icon--checked kubegems-icon icon-dark"></div><input type="checkbox" class="toggle__screenreader-only" aria-label="Switch between dark and light mode"></div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="navbar__github"></a><a href="https://demo.kubegems.io" target="_blank" rel="noopener noreferrer" class="navbar__login button button--primary">ç™»å½•æ§åˆ¶å°</a><div class="navbar__login__account"><div class="navbar__login__info">è´¦å·: admin</div><div class="navbar__login__info">å¯†ç : demo!@#admin</div></div></div></div></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y sidebarWithHideableNavbar_FoYL"><a tabindex="-1" class="sidebarLogo_FJUI" href="/"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></a><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/concepts/what-is-kubegems">æ¦‚å¿µ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/installation/quick-install">éƒ¨ç½²æŒ‡å—</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/quick-install">å¿«é€Ÿå®‰è£…</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/installation/kubernetes-installation/kubeadm">å®‰è£…Kubernetes</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/installation/kubernetes-installation/kubeadm">Kubeadmï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/kubernetes-installation/kind">Kind</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/kubernetes-installation/aks">é˜¿é‡Œäº‘ï¼ˆASKï¼‰</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/kubernetes-installation/gke">è°·æ­Œäº‘ï¼ˆGKEï¼‰</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/installation/more-install-guides/kernel-optimize">æ›´å¤šé…ç½®</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/quick-starts/quick-start">å¿«é€Ÿå…¥é—¨</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/tasks/platform/user">ä½¿ç”¨æŒ‡å—</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/public/contribute/add-content">å‚ä¸è´¡çŒ®</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/reference/customresourcedefinitions">å‚è€ƒ</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/">ğŸ </a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">éƒ¨ç½²æŒ‡å—</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">å®‰è£…Kubernetes</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docs/installation/kubernetes-installation/kubeadm">Kubeadmï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ä½¿ç”¨kubeadmå®‰è£…">ä½¿ç”¨Kubeadmå®‰è£…<a class="hash-link" href="#ä½¿ç”¨kubeadmå®‰è£…" title="Direct link to heading">â€‹</a></h2><p>æœ¬é¡µé¢æ˜¾ç¤ºå¦‚ä½•é€šè¿‡kubeadmå®‰è£…ä¸€ä¸ª3 MasterèŠ‚ç‚¹çš„é«˜å¯ç”¨Kubernetesé›†ç¾¤ã€‚æœ‰å…³åœ¨æ‰§è¡Œæ­¤å®‰è£…è¿‡ç¨‹åå¦‚ä½•ä½¿ç”¨ <strong>kubeadm</strong> åˆ›å»ºé›†ç¾¤çš„ä¿¡æ¯ï¼Œè¯·å‚è§kubeadmå®˜æ–¹æ–‡æ¡£ã€‚</p><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="å‡†å¤‡å¼€å§‹">å‡†å¤‡å¼€å§‹<a class="hash-link" href="#å‡†å¤‡å¼€å§‹" title="Direct link to heading">â€‹</a></h3><ul><li><p>ä¸€å°å…¼å®¹çš„ Linux ä¸»æœºã€‚Kubernetes é¡¹ç›®<strong>ä¸ºåŸºäºDebianå’ŒUbuntu</strong>çš„Linuxå‘è¡Œç‰ˆä»¥åŠä¸€äº›ä¸æä¾›åŒ…ç®¡ç†å™¨çš„å‘è¡Œç‰ˆæä¾›é€šç”¨çš„æŒ‡ä»¤</p></li><li><p>æ¯å°æœºå™¨ 8 GB æˆ–æ›´å¤šçš„ RAM ï¼ˆå¦‚æœå°‘äºè¿™ä¸ªæ•°å­—å°†ä¼šå½±å“ä½ åº”ç”¨çš„è¿è¡Œå†…å­˜)</p></li><li><p>2 CPU æ ¸æˆ–æ›´å¤š</p></li><li><p>é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨çš„ç½‘ç»œå½¼æ­¤å‡èƒ½ç›¸äº’è¿æ¥(å…¬ç½‘å’Œå†…ç½‘éƒ½å¯ä»¥)</p></li><li><p>èŠ‚ç‚¹ä¹‹ä¸­ä¸å¯ä»¥æœ‰é‡å¤çš„ä¸»æœºåã€MAC åœ°å€æˆ– product_uuidã€‚è¯·å‚è§è¿™é‡Œäº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p></li><li><p>å¼€å¯æœºå™¨ä¸Šçš„æŸäº›ç«¯å£ã€‚</p></li><li><p>ç¦ç”¨äº¤æ¢åˆ†åŒºã€‚ä¸ºäº†ä¿è¯ kubelet æ­£å¸¸å·¥ä½œï¼Œä½ <strong>å¿…é¡»</strong>ç¦ç”¨äº¤æ¢åˆ†åŒºã€‚</p></li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>ä¿¡æ¯</h5></div><div class="admonition-content"><p><strong>æ“ä½œç³»ç»Ÿæ¨èä½¿ç”¨</strong>Ubuntu Server 1804<strong>ä»¥ä¸Šç‰ˆæœ¬</strong></p></div></div><p><strong>ä¸‹è½½kuberenteså®‰è£…åŒ…</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes.1.18.16-with-containerd.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes.1.18.16-with-containerd.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>å®‰è£…kubernetesç»„ä»¶å’Œcontainerd</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./libseccomp2_2.4.3-1ubuntu3.18.04.3_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg -i containerd.io_1.4.4-1_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>é…ç½®containerdå’Œcriå·¥</strong>å…·</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s#root = &quot;/var/lib/containerd&quot;#root = &quot;/data/containerd&quot;#&#x27;</span><span class="token plain"> /etc/containerd/config.tom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>é…ç½®kubelet</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">EOF </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_KUBECONFIG_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/var/lib/kubelet/kubeadm-flags.env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/etc/default/kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/kubelet </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBECONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_CONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBEADM_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_EXTRA_ARGS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>å¯¼å…¥kuberentes masterå’Œetcdé•œåƒ</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr ns create k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> api.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> etcd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> manager.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> proxy.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> scheduler.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> coredns.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/pause.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> pause.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="éƒ¨ç½²etcdé«˜å¯ç”¨é›†ç¾¤">éƒ¨ç½²etcdé«˜å¯ç”¨é›†ç¾¤<a class="hash-link" href="#éƒ¨ç½²etcdé«˜å¯ç”¨é›†ç¾¤" title="Direct link to heading">â€‹</a></h3><p><strong>master1èŠ‚ç‚¹ä¸Šåˆ›å»ºetcdé…ç½®æ–‡ä»¶</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># HOSTåœ°å€æ ¹æ®è‡ªå·±çš„å®é™…æœåŠ¡å™¨åœ°å€è¿›è¡Œæ›´æ¢</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST0</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST1</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.69</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST2</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/ /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/ /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCDHOSTS</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NAMES</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;infra0&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;infra1&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;infra2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">i</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${</span><span class="token string variable operator" style="color:#393A34">!</span><span class="token string variable" style="color:#36acaa">ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">@</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">$i</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${NAMES</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">$i</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /tmp/</span><span class="token string bash punctuation variable" style="color:#36acaa">${HOST}</span><span class="token string bash punctuation" style="color:#393A34">/kubeadmcfg.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: &quot;kubeadm.k8s.io/v1beta2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ClusterConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">etcd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    local:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        serverCertSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &quot;</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        peerCertSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &quot;</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-cluster: infra0=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">0</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380,infra1=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">1</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380,infra2=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">2</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-cluster-state: new</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            name: </span><span class="token string variable" style="color:#36acaa">${NAME}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen-peer-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen-client-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            advertise-client-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-advertise-peer-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>ç”Ÿæˆetcdé›†ç¾¤çš„è¯ä¹¦</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-ca</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -R /etc/kubernetes/pki /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -R /etc/kubernetes/pki /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain"> -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain"> -name ca.key -type f -delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>æ‹·è´etcdé›†ç¾¤è¯ä¹¦</strong></p><p>å°†ç›®å½•/tmp/\${HOST1}å’Œ/tmp/\${HOST2}ä¸‹çš„æ–‡ä»¶åˆ†åˆ«æ‹·è´åˆ°å¯¹åº”masterèŠ‚ç‚¹çš„/etc/kubernetesç›®å½•ä¸‹
ä¿è¯æ–‡ä»¶ç»“æ„å¦‚ä¸‹</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0</span><span class="token variable operator" style="color:#393A34">,</span><span class="token variable" style="color:#36acaa">1</span><span class="token variable operator" style="color:#393A34">,</span><span class="token variable" style="color:#36acaa">2}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â””â”€â”€ kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â””â”€â”€ kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â””â”€â”€ pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      â”œâ”€â”€ apiserver-etcd-client.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      â”œâ”€â”€ apiserver-etcd-client.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      â””â”€â”€ etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â”œâ”€â”€ ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â”œâ”€â”€ ca.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â”œâ”€â”€ healthcheck-client.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â”œâ”€â”€ healthcheck-client.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â”œâ”€â”€ peer.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â”œâ”€â”€ peer.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â”œâ”€â”€ server.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â””â”€â”€ server.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>åˆ›å»ºetcdå®ä¾‹</strong></p><ul><li>master1èŠ‚ç‚¹</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase etcd </span><span class="token builtin class-name">local</span><span class="token plain"> --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>master2/master3èŠ‚ç‚¹</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase etcd </span><span class="token builtin class-name">local</span><span class="token plain"> --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/kubeadmcfg.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>æŸ¥çœ‹etcdé›†ç¾¤çŠ¶æ€</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">pod_id</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">crictl </span><span class="token variable function" style="color:#d73a49">ps</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> etcd </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{print $1}&#x27;</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crictl </span><span class="token builtin class-name">exec</span><span class="token plain"> -it </span><span class="token variable" style="color:#36acaa">${pod_id}</span><span class="token plain"> etcdctl </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cert /etc/kubernetes/pki/etcd/peer.crt </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key /etc/kubernetes/pki/etcd/peer.key </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cacert /etc/kubernetes/pki/etcd/ca.crt </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--endpoints https://10.36.0.68:2379 endpoint health --cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="éƒ¨ç½²masteré›†ç¾¤">éƒ¨ç½²Masteré›†ç¾¤<a class="hash-link" href="#éƒ¨ç½²masteré›†ç¾¤" title="Direct link to heading">â€‹</a></h3><p><strong>ä¿®æ”¹kubeleté…ç½®æ–‡ä»¶</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">EOF </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf  --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd  --container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/var/lib/kubelet/kubeadm-flags.env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/etc/default/kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/kubelet </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBECONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_CONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBEADM_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_EXTRA_ARGS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>ç”Ÿæˆkubeadmé…ç½®</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /root/kubeadm.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">bootstrapTokens:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">- groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - system:bootstrappers:kubeadm:default-node-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  token: abcdef.0123456789abcdef</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ttl: 24h0m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  usages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - signing</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: InitConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">localAPIEndpoint:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### å¿…é…ï¼Œé€‰ç€Kubnernetes apiçš„æš´éœ²åœ°å€ï¼Œä¸€èˆ¬ä¸ºç®¡ç†ç½‘æ®µï¼Œåœ°å€æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  advertiseAddress: 10.36.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  bindPort: 6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">nodeRegistration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  criSocket: /run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### å¿…é…ï¼Œé€‰ç€Kubnernetes masterçš„hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: l-010036000068-k8s.cloudminds.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  taints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - effect: NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    key: node-role.kubernetes.io/master</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ClusterConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kubernetesVersion: v1.18.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">imageRepository: k8s.gcr.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">clusterName: kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">certificatesDir: /etc/kubernetes/pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">dns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  type: CoreDNS</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">etcd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  external:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### å¿…é…, å¤–éƒ¨etcdé›†ç¾¤çš„è¿æ¥åœ°å€,åœ°å€æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - https://10.36.0.68:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - https://10.36.0.69:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - https://10.36.0.70:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### å¿…é…ï¼Œä¿æŒé»˜è®¤è·¯å¾„</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    caFile: &quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    certFile: &quot;/etc/kubernetes/pki/apiserver-etcd-client.crt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    keyFile: &quot;/etc/kubernetes/pki/apiserver-etcd-client.key&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">networking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  dnsDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  serviceSubnet: 10.96.0.0/12</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### å¿…é…ï¼ŒcalicoåæœŸå¦‚æœè¦ç”¨bgpåè®®ï¼Œéœ€è¦æå‰è§„åˆ’</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  podSubnet: &quot;172.16.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiServer:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  # æ‰“å¼€apiserverçš„å®¡è®¡æ—¥å¿—</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-path: /var/log/kube-apiserver.audit.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-policy-file: /etc/kubernetes/audit.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-maxage: &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-maxsize: &quot;100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-maxbackup: &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  extraVolumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - name: audit</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      hostPath: /etc/kubernetes/audit.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      mountPath: /etc/kubernetes/audit.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      readOnly: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      pathType: File</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - name: audit-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      hostPath: /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      mountPath: /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  timeoutForControlPlane: 4m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  certSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### å¿…é…ï¼ŒapiæœåŠ¡çš„è¯ä¹¦ç­¾åipå’ŒåŸŸå,åœ°å€æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.0.69</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.0.70</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.13.145</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.13.146</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.13.147</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">controllerManager: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">scheduler: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: KubeProxyConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># å¼€å¯ipvsæ¨¡å¼ï¼Œå¯é€‰æ‹©iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">mode: &quot;ipvs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># nodeportç»‘å®šåœ°å€,1.1.1.0/24å°±åªç»‘å®šåœ¨è¿™ä¸ªç½‘æ®µ</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">nodePortAddresses: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># nodeportçš„ç«¯å£èŒƒå›´</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">portRange:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">configSyncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### å¿…é…</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># å®¹å™¨çš„CIDRç½‘æ®µï¼Œç”¨æ¥åšsnatåœ°å€ä¼ªè£…</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">clusterCIDR: 10.156.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># å…³é—­è®¾ç½®conntrackè·Ÿè¸ªè¡¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">conntrack:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  maxPerCore: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  min: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpCloseWaitTimeout: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpEstablishedTimeout: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># å…³é—­ipvsçš„è®¾ç½®ï¼Œä»¥æ“ä½œç³»ç»Ÿåˆå§‹åŒ–ä¸ºä¸»</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ipvs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  excludeCIDRs: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  minSyncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  scheduler: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  strictARP: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  syncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpFinTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  udpTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: KubeletConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">maxPods: 250</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># æ­¤é…ç½®ä¿è¯äº† kubelet èƒ½åœ¨ swap å¼€å¯çš„æƒ…å†µä¸‹å¯åŠ¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">failSwapOn: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># åˆå§‹é•œåƒGCçš„ç£ç›˜å æ¯”è§¦å‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">imageGCLowThresholdPercent: 75</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># è¶…è¿‡85Â¥åä¸€ç›´è¿è¡Œé•œåƒGC</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">imageGCHighThresholdPercent: 85</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># kubeleté¢„ç•™èµ„æºï¼Œæ ¹æ®é…ç½®è®¾ç½®</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#kubeReserved:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#  &quot;cpu&quot;: &quot;500m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#  &quot;memory&quot;: &quot;512Mi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#  &quot;ephemeral-storage&quot;: &quot;1Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># kubeletè¯ä¹¦è½®è½¬</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">rotateCertificates: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">featureGates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  EphemeralContainers: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/kubernetes/audit.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: audit.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">omitStages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - &quot;ResponseStarted&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - level: RequestResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>åˆå§‹åŒ–kubernets master1èŠ‚ç‚¹</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">swapoff -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm  init </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/kubeadm.conf </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /var/run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--feature-gates </span><span class="token assign-left variable" style="color:#36acaa">EphemeralContainers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true,ServiceAppProtocol</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>æ‹·è´kubectlé…ç½®æ–‡ä»¶</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /root/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /etc/kubernetes/admin.conf  /root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> -R root.root/root/.kube/config </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token create --ttl </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>master2/master3 èŠ‚ç‚¹å®‰è£…</strong></p><ul><li>åŠ å…¥kubernetesé›†ç¾¤</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68:6443 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token wi0cmt.0o8xodk3thphulkj </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:ae184f561109c7aecfadaa12a5bf6d871c6a0cced0ff4f77313b4639f0fd8f33 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>æ³¨æ„</h5></div><div class="admonition-content"><p><code>token</code>ä¸ºkubeadmåˆå§‹åŒ–åæä¾›.<br>
<code>discovery-token-ca-cert-hash</code>ä¸ºkubeadmåˆå§‹åŒ–åæä¾›ã€‚</p></div></div><ul><li>master1èŠ‚ç‚¹æ‰“åŒ…é…ç½®æ–‡ä»¶</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> cvzf api.config.tar.gz admin.conf audit.yaml controller-manager.conf scheduler.conf pki/sa.key pki/sa.pub pki/front-proxy-client.crt pki/front-proxy-client.key pki/front-proxy-ca.key pki/front-proxy-ca.crt pki/apiserver-kubelet-client.crt pki/apiserver-kubelet-client.key pki/apiserver.crt pki/apiserver.key pki/ca.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>å°†<code>api.config.tar.gz</code>æ‹·è´åˆ°master2ï¼Œmaster3èŠ‚ç‚¹</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mv api.config.tar.gz /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar xf api.config.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>åˆ›å»ºKubernetes authè§„åˆ™</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/kubernetes/audit.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: audit.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">omitStages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - &quot;ResponseStarted&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - level: RequestResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>æ‹·è´apiç»„ä»¶manifestæ–‡ä»¶</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-scheduler.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>æ³¨æ„</h5></div><div class="admonition-content"><p><code>kube-apiserver.yaml</code> æ–‡ä»¶æ‹·è´åˆ°master2å’Œmaster3ä¸Šæ—¶ï¼Œéœ€è¦å°†æ–‡ä»¶ä¸­çš„master1èŠ‚ç‚¹ipä¿¡æ¯æ¢æˆå¯¹åº”æœºå™¨ä¸Šçš„ipã€‚</p></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="éƒ¨ç½²kubeletèŠ‚ç‚¹">éƒ¨ç½²KubeletèŠ‚ç‚¹<a class="hash-link" href="#éƒ¨ç½²kubeletèŠ‚ç‚¹" title="Direct link to heading">â€‹</a></h3><p><strong>å®¹å™¨æ•°æ®ç›˜</strong></p><p>æ ¹æ®æœåŠ¡å™¨ä¸Šçš„ç¡¬ç›˜çµæ´»è§„åˆ’æ•°æ®ç›˜çš„æŒ‚è½½ï¼Œé€šå¸¸å°†sdbè®¾å¤‡æ ¼å¼åŒ–åæŒ‚åœ¨åˆ°<code>/data</code>ç›®å½•ä¸‹</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">msfs.xfs /dev/sdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> /dev/sdb /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/dev/sdb    none            xfs   defaults      0       0&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/fstab</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>ä¿¡æ¯</h5></div><div class="admonition-content"><p><strong>sdbè®¾å¤‡è¦çµæ´»é€‰æ‹©ï¼Œè¦ä¿è¯æ•°æ®çš„å®‰å…¨æ€§ï¼Œå¦‚æœæœåŠ¡å™¨æœ‰å¤šå—ç¡¬ç›˜çš„è¯ï¼Œè‡³å°‘è¦åšRAID1ä»¥ä¸Šçš„æ¨¡å¼</strong></p></div></div><p><strong>é…ç½®nginxï¼Œåå‘ä»£ç†åˆ°kubernets api</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/nginx/nginx.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">user root;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_processes 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_cpu_affinity auto;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">pid /run/nginx.pid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">load_module  /usr/share/nginx/modules/ngx_stream_module.so;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_rlimit_nofile 64512;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_shutdown_timeout 10s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">events {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    multi_accept        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    worker_connections  16384;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    use                 epoll;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">stream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    upstream upstream_balancer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            least_conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            # kubernetes masterçš„apiåœ°å€</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.68:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.69:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.70:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    log_format log_stream [</span><span class="token string variable" style="color:#36acaa">$time_local</span><span class="token string" style="color:#e3116c">] </span><span class="token string variable" style="color:#36acaa">$protocol</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$status</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_sent</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_received</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$session_time</span><span class="token string" style="color:#e3116c">;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    access_log /var/log/nginx/access.log log_stream ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    error_log  /var/log/nginx/error.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen 127.0.0.1:6443;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_timeout 1200s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_pass upstream_balancer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx -t </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> nginx -s reload </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>ä¸‹è½½kuberneteså®‰è£…åŒ…</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes.1.18.16-with-containerd.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>å®‰è£…kuberneteså’Œcontainerd</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./libseccomp2_2.4.3-1ubuntu3.18.04.3_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg -i containerd.io_1.4.4-1_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y --allow-change-held-packages ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>é…ç½®containerdå’Œcriå·¥å…·</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s#root = &quot;/var/lib/containerd&quot;#root = &quot;/data/containerd&quot;#&#x27;</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>å¯¼å…¥Containeré•œåƒ</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr ns create k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> proxy.18.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>æ¸…é™¤å®‰è£…æ–‡ä»¶</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /root </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><p><strong>åŠ å…¥kuernetesé›†ç¾¤</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:6443 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token wi0cmt.0o8xodk3thphulkj </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:ae184f561109c7aecfadaa12a5bf6d871c6a0cced0ff4f77313b4639f0fd8f33 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>æ³¨æ„</h5></div><div class="admonition-content"><p><code>token</code>ä¸ºkubeadmåˆå§‹åŒ–åæä¾›.<br>
<code>discovery-token-ca-cert-hash</code>ä¸ºkubeadmåˆå§‹åŒ–åæä¾›ã€‚</p></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="éƒ¨ç½²kubeletèŠ‚ç‚¹gpu">éƒ¨ç½²KubeletèŠ‚ç‚¹(GPU)<a class="hash-link" href="#éƒ¨ç½²kubeletèŠ‚ç‚¹gpu" title="Direct link to heading">â€‹</a></h3><p><strong>å®¹å™¨æ•°æ®ç›˜</strong></p><p>æ ¹æ®æœåŠ¡å™¨ä¸Šçš„ç¡¬ç›˜çµæ´»è§„åˆ’æ•°æ®ç›˜çš„æŒ‚è½½ï¼Œé€šå¸¸å°†sdbè®¾å¤‡æ ¼å¼åŒ–åæŒ‚åœ¨åˆ°<code>/data</code>ç›®å½•ä¸‹</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mkfs.xfs /dev/sdb -f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> /dev/sdb /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/dev/sdb    /data xfs   defaults      0       0&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/fstab</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>ä¿¡æ¯</h5></div><div class="admonition-content"><p><strong>sdbè®¾å¤‡è¦çµæ´»é€‰æ‹©ï¼Œè¦ä¿è¯æ•°æ®çš„å®‰å…¨æ€§ï¼Œå¦‚æœæœåŠ¡å™¨æœ‰å¤šå—ç¡¬ç›˜çš„è¯ï¼Œè‡³å°‘è¦åšRAID1ä»¥ä¸Šçš„æ¨¡å¼</strong></p></div></div><p><strong>é…ç½®nginxï¼Œåå‘ä»£ç†åˆ°kubernets api</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/nginx/nginx.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">user root;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_processes 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_cpu_affinity auto;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">pid /run/nginx.pid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">load_module  /usr/share/nginx/modules/ngx_stream_module.so;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_rlimit_nofile 64512;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_shutdown_timeout 10s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">events {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    multi_accept        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    worker_connections  16384;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    use                 epoll;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">stream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    upstream upstream_balancer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            least_conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            # kubernetes masterçš„apiåœ°å€</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 172.16.13.134:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 172.16.13.135:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 172.16.13.136:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    log_format log_stream [</span><span class="token string variable" style="color:#36acaa">$time_local</span><span class="token string" style="color:#e3116c">] </span><span class="token string variable" style="color:#36acaa">$protocol</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$status</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_sent</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_received</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$session_time</span><span class="token string" style="color:#e3116c">;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    access_log /var/log/nginx/access.log log_stream ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    error_log  /var/log/nginx/error.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen 127.0.0.1:6443;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_timeout 1200s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_pass upstream_balancer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx -t </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> nginx -s reload </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>ä¸‹è½½kuberneteså®‰è£…åŒ…</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes.1.18.16-with-containerd.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>å®‰è£…kuberneteså’Œcontainerd</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./libseccomp2_2.4.3-1ubuntu3.18.04.3_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg -i containerd.io_1.4.4-1_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>å®‰è£…contaienrd nvidia runtime</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/containerd-nvidia-1.18.16.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf containerd-nvidia-1.18.16.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf containerd-nvidia-1.18.16.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>é…ç½®containerdå’Œcriå·¥å…·</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/containerd/config.toml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">version = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">root = &quot;/data/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">state = &quot;/run/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">plugin_dir = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">disabled_plugins = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">required_plugins = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">oom_score = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[grpc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;/run/containerd/containerd.sock&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_tls_cert = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_tls_key = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  max_recv_message_size = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  max_send_message_size = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[ttrpc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[debug]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  level = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[metrics]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  grpc_histogram = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[cgroup]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  path = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[timeouts]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.cleanup&quot; = &quot;5s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.load&quot; = &quot;5s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.shutdown&quot; = &quot;3s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.task.state&quot; = &quot;2s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[plugins]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    pause_threshold = 0.02</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    deletion_threshold = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    mutation_threshold = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    schedule_delay = &quot;0s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    startup_delay = &quot;100ms&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_tcp_service = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_server_address = &quot;127.0.0.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_server_port = &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_idle_timeout = &quot;4h0m0s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enable_selinux = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    selinux_category_range = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    sandbox_image = &quot;k8s.gcr.io/pause:3.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stats_collect_period = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    systemd_cgroup = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enable_tls_streaming = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    max_container_log_line_size = 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_cgroup = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_apparmor = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    restrict_oom_score_adj = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    max_concurrent_downloads = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_proc_mount = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    unset_seccomp_profile = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    tolerate_missing_hugetlb_controller = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_hugetlb_controller = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    ignore_image_defined_volumes = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      snapshotter = &quot;overlayfs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      default_runtime_name = &quot;runc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      no_pivot = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      disable_snapshot_annotations = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      discard_unpacked_layers = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_type = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.untrusted_workload_runtime]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_type = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_type = &quot;io.containerd.runtime.v1.linux&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      bin_dir = &quot;/opt/cni/bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      conf_dir = &quot;/etc/cni/net.d&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      max_conf_num = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      conf_template = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      key_model = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      tls_cert_file = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      tls_key_file = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.internal.v1.opt&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    path = &quot;/opt/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.internal.v1.restart&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    interval = &quot;10s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.metadata.v1.bolt&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    content_sharing_policy = &quot;shared&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    no_prometheus = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.runtime.v1.linux&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    shim = &quot;containerd-shim&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    runtime = &quot;nvidia-container-runtime&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    no_shim = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    shim_debug = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.runtime.v2.task&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    platforms = [&quot;linux/amd64&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.service.v1.diff-service&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    default = [&quot;walking&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    root_path = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    pool_name = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    base_image_size = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    async_remove = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>å¯¼å…¥Containeré•œåƒ</strong></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar xf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr ns create k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images import proxy.18.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>æ¸…é™¤å®‰è£…æ–‡ä»¶</strong></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cd /root &amp;&amp; rm -rf root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>åŠ å…¥kuernetesé›†ç¾¤</strong></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm join 127.0.0.1:6443 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token k9brva.g7vj4109keb0c093 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:72986af040b0dc8e251ee85f774120844e9b64c26bfff547348ef0e669a0f208 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>æ³¨æ„</h5></div><div class="admonition-content"><p><code>token</code>ä¸ºkubeadmåˆå§‹åŒ–åæä¾›ã€‚<br>
<code>discovery-token-ca-cert-hash</code>ä¸ºkubeadmåˆå§‹åŒ–åæä¾›ã€‚</p></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/installation/quick-install"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">å¿«é€Ÿå®‰è£…</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/installation/kubernetes-installation/kind"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kind</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ä½¿ç”¨kubeadmå®‰è£…" class="table-of-contents__link toc-highlight">ä½¿ç”¨Kubeadmå®‰è£…</a><ul><li><a href="#å‡†å¤‡å¼€å§‹" class="table-of-contents__link toc-highlight">å‡†å¤‡å¼€å§‹</a></li><li><a href="#éƒ¨ç½²etcdé«˜å¯ç”¨é›†ç¾¤" class="table-of-contents__link toc-highlight">éƒ¨ç½²etcdé«˜å¯ç”¨é›†ç¾¤</a></li><li><a href="#éƒ¨ç½²masteré›†ç¾¤" class="table-of-contents__link toc-highlight">éƒ¨ç½²Masteré›†ç¾¤</a></li><li><a href="#éƒ¨ç½²kubeletèŠ‚ç‚¹" class="table-of-contents__link toc-highlight">éƒ¨ç½²KubeletèŠ‚ç‚¹</a></li><li><a href="#éƒ¨ç½²kubeletèŠ‚ç‚¹gpu" class="table-of-contents__link toc-highlight">éƒ¨ç½²KubeletèŠ‚ç‚¹(GPU)</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer" id="footer"><div class="text--center">Copyright Â© 2022 KubeGems, Inc.</div></footer></div>
<script src="/assets/js/runtime~main.3cc290b8.js"></script>
<script src="/assets/js/main.cbbec2e5.js"></script>
</body>
</html>