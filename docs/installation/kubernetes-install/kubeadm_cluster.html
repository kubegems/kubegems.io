<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-installation/kubernetes-install/kubeadm_cluster">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KubeGems RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KubeGems Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XB3JTSLM8D"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XB3JTSLM8D",{anonymize_ip:!0})</script><title data-rh="true">基于 Kubeadm 安装 HA 集群 | KubeGems</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kubegems.io/docs/installation/kubernetes-install/kubeadm_cluster"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="go-import" content="kubegems.io/kubegems git https://github.com/kubegems/kubegems"><meta data-rh="true" name="go-import" content="kubegems.io/bundle-controller git https://github.com/kubegems/bundle-controller"><meta data-rh="true" name="go-import" content="kubegems.io/configer git https://github.com/kubegems/configer"><meta data-rh="true" name="go-import" content="kubegems.io/ingress-nginx-operator git https://github.com/kubegems/ingress-nginx-operator"><meta data-rh="true" name="go-source" content="kubegems.io/kubegems https://github.com/kubegems/kubegems https://github.com/kubegems/kubegems/tree/master{/dir} https://github.com/kubegems/kubegems/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/bundle-controller https://github.com/kubegems/bundle-controller https://github.com/kubegems/bundle-controller/tree/master{/dir} https://github.com/kubegems/bundle-controller/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/configer https://github.com/kubegems/configer https://github.com/kubegems/configer/tree/master{/dir} https://github.com/kubegems/configer/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator/tree/master{/dir} https://github.com/kubegems/ingress-nginx-operator/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="基于 Kubeadm 安装 HA 集群 | KubeGems"><meta data-rh="true" name="description" content="使用 Kubeadm 安装 HA 集群"><meta data-rh="true" property="og:description" content="使用 Kubeadm 安装 HA 集群"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kubegems.io/docs/installation/kubernetes-install/kubeadm_cluster"><link data-rh="true" rel="alternate" href="https://kubegems.io/docs/installation/kubernetes-install/kubeadm_cluster" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kubegems.io/docs/installation/kubernetes-install/kubeadm_cluster" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9cf2301e.css">
<link rel="preload" href="/assets/js/runtime~main.17182f77.js" as="script">
<link rel="preload" href="/assets/js/main.50820c94.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:rgba(0, 0, 0, 0.03)" role="banner"><div class="announcementBarContent_KsVm">⭐️ <b>If you like KubeGems, give it a star on <a target="_blank" href="https://github.com/kubegems/kubegems">GitHub</a> and follow us on <a target="_blank" href="https://twitter.com/KubeGems">Twitter</a>  <a title="Twitter, Apache License 2.0 &lt;http://www.apache.org/licenses/LICENSE-2.0&gt;, via Wikimedia Commons" href="https://twitter.com/KubeGems"><img width="16" height="13" alt="Twitter-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Twitter-logo.svg/32px-Twitter-logo.svg.png"></a></b> </div></div><nav class="navbar navbar--fixed-top navbarHideable_VLjY"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/concepts/what-is-kubegems">文档</a><a class="navbar__item navbar__link" href="/blog">博客</a><a class="navbar__item navbar__link" href="/community/support">社群</a><a href="https://wj.qq.com/s2/10923500/96e0/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Contact</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/concepts/what-is-kubegems">v1.23</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/docs/installation/kubernetes-install/kubeadm_cluster" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li></ul></div><div class="navbar__items navbar__item--dock"><div class="toggle navbar__dark toggle--disabled" role="button" tabindex="-1"><div class="toggle__icon toggle__icon--unchecked kubegems-icon icon-light"></div><div class="toggle__icon toggle__icon--checked kubegems-icon icon-dark"></div><input type="checkbox" class="toggle__screenreader-only" aria-label="Switch between dark and light mode"></div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="navbar__github"></a><a href="https://demo.kubegems.io" target="_blank" rel="noopener noreferrer" class="navbar__login button button--primary">体验 Demo</a><div class="navbar__login__account"><div class="navbar__login__info">账号: admin</div><div class="navbar__login__info">密码: demo!@#admin</div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD sidebarWithHideableNavbar_d0QC"><a tabindex="-1" class="sidebarLogo_YUvz" href="/"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></a><nav class="menu thin-scrollbar menu_izAj menuWithAnnouncementBar_l2a_"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/产品介绍">产品介绍</a><button aria-label="Toggle the collapsible sidebar category &#x27;产品介绍&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/快速入门">快速入门</a><button aria-label="Toggle the collapsible sidebar category &#x27;快速入门&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/部署指南">部署指南</a><button aria-label="Toggle the collapsible sidebar category &#x27;部署指南&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/安装-kubernetes">安装 Kubernetes</a><button aria-label="Toggle the collapsible sidebar category &#x27;安装 Kubernetes&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/kubernetes-install/kubeadm">基于 Kubeadm 安装</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/installation/kubernetes-install/kubeadm_cluster">基于 Kubeadm 安装 HA 集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/kubernetes-install/sealos">基于 SealOS 安装 HA 集群 (推荐)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/kubernetes-install/kind">基于 Kind 安装 (实验性质)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/安装-kubegems">安装 KubeGems</a><button aria-label="Toggle the collapsible sidebar category &#x27;安装 KubeGems&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/更多配置">更多配置</a><button aria-label="Toggle the collapsible sidebar category &#x27;更多配置&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/category/版本升级">版本升级</a><button aria-label="Toggle the collapsible sidebar category &#x27;版本升级&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/installation/install-troubleshoot">安装问题排查指南</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/使用指南">使用指南</a><button aria-label="Toggle the collapsible sidebar category &#x27;使用指南&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/扩展">扩展</a><button aria-label="Toggle the collapsible sidebar category &#x27;扩展&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/ai-applications">AI Applications</a><button aria-label="Toggle the collapsible sidebar category &#x27;AI Applications&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_FykI"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_DTRl"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">🏠</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/部署指南"><span itemprop="name">部署指南</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/安装-kubernetes"><span itemprop="name">安装 Kubernetes</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">基于 Kubeadm 安装 HA 集群</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="使用-kubeadm-安装-ha-集群">使用 Kubeadm 安装 HA 集群<a class="hash-link" href="#使用-kubeadm-安装-ha-集群" title="Direct link to heading">​</a></h2><p>本页面显示如何通过kubeadm安装一个3 Master节点的高可用Kubernetes集群。有关在执行此安装过程后如何使用 <strong>kubeadm</strong> 创建集群的信息，请参见kubeadm官方文档。</p><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="准备开始">准备开始<a class="hash-link" href="#准备开始" title="Direct link to heading">​</a></h3><ul><li><p>一台兼容的 Linux 主机。Kubernetes 项目<strong>为基于Debian和Ubuntu</strong>的Linux发行版以及一些不提供包管理器的发行版提供通用的指令</p></li><li><p>每台机器 8 GB 或更多的 RAM （如果少于这个数字将会影响你应用的运行内存)</p></li><li><p>2 CPU 核或更多</p></li><li><p>集群中的所有机器的网络彼此均能相互连接(公网和内网都可以)</p></li><li><p>节点之中不可以有重复的主机名、MAC 地址或 product_uuid。请参见这里了解更多详细信息。</p></li><li><p>开启机器上的某些端口。</p></li><li><p>禁用交换分区。为了保证 kubelet 正常工作，你<strong>必须</strong>禁用交换分区。</p></li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><strong>操作系统推荐使用</strong>Ubuntu Server 1804<strong>以上版本</strong></p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="允许-iptables-检查桥接流量">允许 iptables 检查桥接流量<a class="hash-link" href="#允许-iptables-检查桥接流量" title="Direct link to heading">​</a></h3><p>确保 <code>br_netfilter</code> 模块被加载。这一操作可以通过运行 <code>lsmod | grep br_netfilter</code> 来完成。若要显式加载该模块，可执行 <code>sudo modprobe br_netfilter</code>。</p><p>为了让 Linux 节点上的 iptables 能够正确地查看桥接流量，需要确保在您的 <code>sysctl</code> 配置中将 <code>net.bridge.bridge-nf-call-iptables</code> 设置为 1。例如：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/k8s.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/k8s.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="安装运行时">安装运行时<a class="hash-link" href="#安装运行时" title="Direct link to heading">​</a></h3><p>为了在 Pod 中运行容器，Kubernetes 使用 容器运行时（Container Runtime）。</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Linux</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">Other</li></ul><div class="margin-vert--md"><div role="tabpanel">默认情况下，Kubernetes 使用容器运行时接口 Container Runtime Interface 来与你所选择的容器运行时交互。<p>如果不指定运行时，则 kubeadm 会自动尝试检测到系统上已经安装的运行时， 方法是扫描一组众所周知的 Unix 域套接字。 下面的表格列举了一些容器运行时及其对应的套接字路径：</p><table><thead><tr><th>运行时</th><th>域套接字</th></tr></thead><tbody><tr><td>Docker</td><td>/var/run/dockershim.sock</td></tr><tr><td>containerd</td><td>/run/containerd/containerd.sock</td></tr><tr><td>CRI-O</td><td>/var/run/crio/crio.sock</td></tr></tbody></table><p>如果同时检测到 Docker 和 containerd，则优先选择 Docker。 如果检测到其他两个或多个运行时，kubeadm 输出错误信息并退出。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>kubelet 通过内置的 dockershim CRI 实现与 Docker 集成。</p></div></div><p>参阅容器运行时 以了解更多信息。</p></div><div role="tabpanel" hidden="">默认情况下， kubeadm 使用 Docker 作为容器运行时。 kubelet 通过内置的 dockershim CRI 实现与 Docker 集成。</div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="安装-kubeadm">安装 kubeadm<a class="hash-link" href="#安装-kubeadm" title="Direct link to heading">​</a></h3><p>您需要在每台机器上安装以下的软件包：</p><ul><li><p>kubeadm：用来初始化集群的指令。</p></li><li><p>kubelet：在集群中的每个节点上用来启动 Pod 和容器等。</p></li><li><p>kubectl：用来与集群通信的命令行工具。</p></li></ul><p>kubeadm 不能 帮您安装或者管理 kubelet 或 kubectl，所以您需要 确保它们与通过 kubeadm 安装的控制平面的版本相匹配。 如果不这样做，则存在发生版本偏差的风险，可能会导致一些预料之外的错误和问题。</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active"> 基于 Debian 的发行版</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD"> 基于 RedHat 的发行版</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">二进制</li></ul><div class="margin-vert--md"><div role="tabpanel">1.更新 apt 包索引并安装使用 Kubernetes apt 仓库所需要的包<div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y apt-transport-https ca-certificates </span><span class="token function" style="color:#d73a49">curl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>2.下载 Google Cloud 公开签名秘钥：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>3.添加 Kubernetes apt 仓库：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/apt/sources.list.d/kubernetes.list</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>4.更新 apt 包索引，安装 kubelet、kubeadm 和 kubectl，并锁定其版本：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y kubelet kubeadm kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> apt-mark hold kubelet kubeadm kubectl</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/yum.repos.d/kubernetes.repo</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[kubernetes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">name=Kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\</span><span class="token string variable" style="color:#36acaa">$basearch</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">enabled=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">gpgcheck=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">repo_gpgcheck=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">exclude=kubelet kubeadm kubectl</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> setenforce </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span><span class="token plain"> /etc/selinux/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> yum </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y kubelet kubeadm kubectl --disableexcludes</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> --now kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><ul><li><p>通过运行命令 setenforce 0 和 sed ... 将 SELinux 设置为 permissive 模式 可以有效地将其禁用。 这是允许容器访问主机文件系统所必需的，而这些操作时为了例如 Pod 网络工作正常。您必须这么做，直到 kubelet 做出对 SELinux 的支持进行升级为止。</p></li><li><p>如果你知道如何配置 SELinux 则可以将其保持启用状态，但可能需要设定 kubeadm 不支持的部分配置</p></li></ul></div></div></div><div role="tabpanel" hidden="">安装 CNI 插件（大多数 Pod 网络都需要）：<div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">CNI_VERSION</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;v0.8.2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ARCH</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /opt/cni/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -L </span><span class="token string" style="color:#e3116c">&quot;https://github.com/containernetworking/plugins/releases/download/</span><span class="token string variable" style="color:#36acaa">${CNI_VERSION}</span><span class="token string" style="color:#e3116c">/cni-plugins-linux-</span><span class="token string variable" style="color:#36acaa">${ARCH}</span><span class="token string" style="color:#e3116c">-</span><span class="token string variable" style="color:#36acaa">${CNI_VERSION}</span><span class="token string" style="color:#e3116c">.tgz&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -C /opt/cni/bin -xz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>定义要下载命令文件的目录。</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>DOWNLOAD_DIR 变量必须被设置为一个可写入的目录。 如果你在运行 Flatcar Container Linux，可将 DOWNLOAD_DIR 设置为 /opt/bin。</p></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">DOWNLOAD_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/local/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p </span><span class="token variable" style="color:#36acaa">$DOWNLOAD_DIR</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>安装 crictl（kubeadm/kubelet 容器运行时接口（CRI）所需</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">CRICTL_VERSION</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;v1.22.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ARCH</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -L </span><span class="token string" style="color:#e3116c">&quot;https://github.com/kubernetes-sigs/cri-tools/releases/download/</span><span class="token string variable" style="color:#36acaa">${CRICTL_VERSION}</span><span class="token string" style="color:#e3116c">/crictl-</span><span class="token string variable" style="color:#36acaa">${CRICTL_VERSION}</span><span class="token string" style="color:#e3116c">-linux-</span><span class="token string variable" style="color:#36acaa">${ARCH}</span><span class="token string" style="color:#e3116c">.tar.gz&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -C </span><span class="token variable" style="color:#36acaa">$DOWNLOAD_DIR</span><span class="token plain"> -xz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>安装 kubeadm、kubelet、kubectl 并添加 kubelet 系统服务：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">RELEASE</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">curl</span><span class="token string variable" style="color:#36acaa"> -sSL https://dl.k8s.io/release/stable.txt</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ARCH</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;amd64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$DOWNLOAD_DIR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/</span><span class="token variable" style="color:#36acaa">${RELEASE}</span><span class="token plain">/bin/linux/</span><span class="token variable" style="color:#36acaa">${ARCH}</span><span class="token plain">/</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">kubeadm,kubelet,kubectl</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">kubeadm,kubelet,kubectl</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">RELEASE_VERSION</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;v0.4.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -sSL </span><span class="token string" style="color:#e3116c">&quot;https://raw.githubusercontent.com/kubernetes/release/</span><span class="token string variable" style="color:#36acaa">${RELEASE_VERSION}</span><span class="token string" style="color:#e3116c">/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;s:/usr/bin:</span><span class="token string variable" style="color:#36acaa">${DOWNLOAD_DIR}</span><span class="token string" style="color:#e3116c">:g&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/kubelet.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/systemd/system/kubelet.service.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -sSL </span><span class="token string" style="color:#e3116c">&quot;https://raw.githubusercontent.com/kubernetes/release/</span><span class="token string variable" style="color:#36acaa">${RELEASE_VERSION}</span><span class="token string" style="color:#e3116c">/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;s:/usr/bin:</span><span class="token string variable" style="color:#36acaa">${DOWNLOAD_DIR}</span><span class="token string" style="color:#e3116c">:g&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>激活并启动 kubelet：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> --now kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="配置-containerd和-cri-工具">配置 containerd和 cri 工具<a class="hash-link" href="#配置-containerd和-cri-工具" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s#root = &quot;/var/lib/containerd&quot;#root = &quot;/data/containerd&quot;#&#x27;</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署-etcd-高可用集群">部署 etcd 高可用集群<a class="hash-link" href="#部署-etcd-高可用集群" title="Direct link to heading">​</a></h3><ol><li>将 kubelet 配置为 etcd 的服务管理器</li></ol><p>由于 etcd 是首先创建的，因此你必须通过创建具有更高优先级的新文件来覆盖 kubeadm 提供的 kubelet 单元文件。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /etc/systemd/system/kubelet.service.d/20-etcd-service-manager.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ExecStart=</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 将下面的 &quot;systemd&quot; 替换为你的容器运行时所使用的 cgroup 驱动。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># kubelet 的默认值为 &quot;cgroupfs&quot;。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">Restart=always</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>检查 kubelet 的状态以确保其处于运行状态：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="2"><li>为 kubeadm 创建配置文件。</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># HOST地址根据自己的实际服务器地址进行更换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST0</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST1</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.69</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST2</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/ /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/ /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCDHOSTS</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NAMES</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;infra0&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;infra1&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;infra2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">i</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${</span><span class="token string variable operator" style="color:#393A34">!</span><span class="token string variable" style="color:#36acaa">ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">@</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">$i</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${NAMES</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">$i</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /tmp/</span><span class="token string bash punctuation variable" style="color:#36acaa">${HOST}</span><span class="token string bash punctuation" style="color:#393A34">/kubeadmcfg.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: &quot;kubeadm.k8s.io/v1beta2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ClusterConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">etcd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    local:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        serverCertSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &quot;</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        peerCertSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &quot;</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-cluster: infra0=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">0</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380,infra1=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">1</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380,infra2=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">2</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-cluster-state: new</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            name: </span><span class="token string variable" style="color:#36acaa">${NAME}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen-peer-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen-client-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            advertise-client-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-advertise-peer-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="3"><li>生成etcd集群的证书</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-ca</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -R /etc/kubernetes/pki /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -R /etc/kubernetes/pki /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain"> -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain"> -name ca.key -type f -delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="4"><li>拷贝etcd集群证书</li></ol><p>将目录/tmp/\${HOST1}和/tmp/\${HOST2}下的文件分别拷贝到对应master节点的/etc/kubernetes目录下
保证文件结构如下</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0</span><span class="token variable operator" style="color:#393A34">,</span><span class="token variable" style="color:#36acaa">1</span><span class="token variable operator" style="color:#393A34">,</span><span class="token variable" style="color:#36acaa">2}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── apiserver-etcd-client.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── apiserver-etcd-client.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      └── etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── ca.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── healthcheck-client.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── healthcheck-client.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── peer.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── peer.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── server.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          └── server.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="5"><li>创建etcd实例</li></ol><ul><li>master1节点</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase etcd </span><span class="token builtin class-name">local</span><span class="token plain"> --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>master2/master3节点</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase etcd </span><span class="token builtin class-name">local</span><span class="token plain"> --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/kubeadmcfg.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="6"><li>查看 etcd 集群状态</li></ol><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">docker</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">containerd</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --rm -it &lt;etcd_pod_id&gt; etcdctl \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cert /etc/kubernetes/pki/etcd/peer.crt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key /etc/kubernetes/pki/etcd/peer.key \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--endpoints https://10.36.0.68:2379 endpoint health --cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">crictl exec -it &lt;etcd_pod_id&gt; etcdctl \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cert /etc/kubernetes/pki/etcd/peer.crt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key /etc/kubernetes/pki/etcd/peer.key \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cacert /etc/kubernetes/pki/etcd/ca.crt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--endpoints https://10.36.0.68:2379 endpoint health --cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署-master-集群">部署 Master 集群<a class="hash-link" href="#部署-master-集群" title="Direct link to heading">​</a></h3><ol><li>修改kubelet配置文件</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">EOF </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf  --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd  --container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/var/lib/kubelet/kubeadm-flags.env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/etc/default/kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/kubelet </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBECONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_CONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBEADM_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_EXTRA_ARGS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="2"><li>生成kubeadm配置</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> EOF </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /root/kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: InitConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">localAPIEndpoint:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  advertiseAddress: </span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bindPort: </span><span class="token number" style="color:#36acaa">6443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nodeRegistration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  criSocket: /run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: ClusterConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubernetesVersion: v1.20.15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FeatureGates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EphemeralContainers: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ServiceAppProtocol: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterName: cloud-m8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certificatesDir: /etc/kubernetes/pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: CoreDNS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etcd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  external:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - https://10.36.0.68:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - https://10.36.0.69:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - https://10.36.0.70:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    caFile: </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    certFile: </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes/pki/apiserver-etcd-client.crt&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyFile: </span><span class="token string" style="color:#e3116c">&quot;/etc/kubernetes/pki/apiserver-etcd-client.key&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">networking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dnsDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceSubnet: </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.0.0/12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### 必配，calico后期如果要用bgp协议，需要提前规划</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  podSubnet: </span><span class="token string" style="color:#e3116c">&quot;10.59.0.0/16&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiServer:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeoutForControlPlane: 4m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  certSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### 必配，api服务的证书签名ip和域名,地址根据实际情况修改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.69</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token number" style="color:#36acaa">10.96</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - </span><span class="token string" style="color:#e3116c">&quot;*.kubegems.io&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">controllerManager: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeProxyConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 开启ipvs模式，可选择iptables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mode: </span><span class="token string" style="color:#e3116c">&quot;ipvs&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nodeport绑定地址,1.1.1.0/24就只绑定在这个网段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nodePortAddresses: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># nodeport的端口范围</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">configSyncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### 必配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 容器的CIDR网段，用来做snat地址伪装</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clusterCIDR: </span><span class="token number" style="color:#36acaa">10.59</span><span class="token plain">.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 关闭设置conntrack跟踪表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conntrack:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  maxPerCore: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  min: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcpCloseWaitTimeout: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcpEstablishedTimeout: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 关闭ipvs的设置，以操作系统初始化为主</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ipvs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  excludeCIDRs: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  minSyncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scheduler: </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strictARP: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  syncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcpFinTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tcpTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  udpTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: KubeletConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">maxPods: </span><span class="token number" style="color:#36acaa">250</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">failSwapOn: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rotateCertificates: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">featureGates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EphemeralContainers: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ServiceAppProtocol: </span><span class="token boolean" style="color:#36acaa">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="3"><li>初始化kubernets master1节点</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">swapoff -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm  init </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/kubeadm.conf </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /var/run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--feature-gates </span><span class="token assign-left variable" style="color:#36acaa">EphemeralContainers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true,ServiceAppProtocol</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="4"><li>拷贝kubectl配置文件</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /root/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /etc/kubernetes/admin.conf  /root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> -R root.root/root/.kube/config </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token create --ttl </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="5"><li>master2/master3 节点安装</li></ol><ul><li>加入kubernetes集群</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68:6443 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token wi0cmt.0o8xodk3thphulkj </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:ae184f561109c7aecfadaa12a5bf6d871c6a0cced0ff4f77313b4639f0fd8f33 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><code>token</code>为kubeadm初始化后提供.<br>
<code>discovery-token-ca-cert-hash</code>为kubeadm初始化后提供。</p></div></div><ul><li>master1节点打包配置文件</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> cvzf api.config.tar.gz admin.conf audit.yaml controller-manager.conf scheduler.conf pki/sa.key pki/sa.pub pki/front-proxy-client.crt pki/front-proxy-client.key pki/front-proxy-ca.key pki/front-proxy-ca.crt pki/apiserver-kubelet-client.crt pki/apiserver-kubelet-client.key pki/apiserver.crt pki/apiserver.key pki/ca.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>将<code>api.config.tar.gz</code>拷贝到master2，master3节点</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mv api.config.tar.gz /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar xf api.config.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="6"><li>拷贝api组件manifest文件</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-scheduler.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><code>kube-apiserver.yaml</code> 文件拷贝到master2和master3上时，需要将文件中的master1节点ip信息换成对应机器上的ip。</p></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署-kubelet节点">部署 Kubelet节点<a class="hash-link" href="#部署-kubelet节点" title="Direct link to heading">​</a></h3><ol><li>容器数据盘 （可选）</li></ol><p>根据服务器上的硬盘灵活规划数据盘的挂载，通常将sdb设备格式化后挂在到<code>/data</code>目录下</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">msfs.xfs /dev/sdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> /dev/sdb /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/dev/sdb    none            xfs   defaults      0       0&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/fstab</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><strong>sdb设备要灵活选择，要保证数据的安全性，如果服务器有多块硬盘的话，至少要做RAID1以上的模式</strong></p></div></div><ol start="2"><li>配置nginx apiserver</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/nginx/nginx.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">user root;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_processes 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_cpu_affinity auto;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">pid /run/nginx.pid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">load_module  /usr/share/nginx/modules/ngx_stream_module.so;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_rlimit_nofile 64512;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_shutdown_timeout 10s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">events {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    multi_accept        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    worker_connections  16384;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    use                 epoll;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">stream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    upstream upstream_balancer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            least_conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            # kubernetes master的api地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.68:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.69:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.70:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    log_format log_stream [</span><span class="token string variable" style="color:#36acaa">$time_local</span><span class="token string" style="color:#e3116c">] </span><span class="token string variable" style="color:#36acaa">$protocol</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$status</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_sent</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_received</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$session_time</span><span class="token string" style="color:#e3116c">;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    access_log /var/log/nginx/access.log log_stream ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    error_log  /var/log/nginx/error.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen 127.0.0.1:6443;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_timeout 1200s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_pass upstream_balancer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx -t </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> nginx -s reload </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="3"><li>安装运行时</li></ol><ol start="4"><li>配置containerd和cri工具**</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 将 containerd 的数据持久化到 sdb 设备</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s#root = &quot;/var/lib/containerd&quot;#root = &quot;/data/containerd&quot;#&#x27;</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><hr><p>5.加入kuernetes集群</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:6443 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token wi0cmt.0o8xodk3thphulkj </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:ae184f561109c7aecfadaa12a5bf6d871c6a0cced0ff4f77313b4639f0fd8f33 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><code>token</code>为kubeadm初始化后提供，如果您没有这个数据，可以通过下述命令获取</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TOKEN                    TTL  EXPIRES              USAGES           DESCRIPTION            EXTRA </span><span class="token environment constant" style="color:#36acaa">GROUPS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8ewj1p.9r9hcjoqgajrj4gi  23h  </span><span class="token number" style="color:#36acaa">2018</span><span class="token plain">-06-12T02:51:28Z authentication,  The default bootstrap  system:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                   signing          token generated by     bootstrappers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                    </span><span class="token string" style="color:#e3116c">&#x27;kubeadm init&#x27;</span><span class="token builtin class-name">.</span><span class="token plain">        kubeadm:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                                           default-node-token</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>discovery-token-ca-cert-hash</code>为kubeadm初始化后提供。如果您没有这个数据，可以通过执行下述命令获取</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> openssl rsa -pubin -outform der </span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/dev/null </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   openssl dgst -sha256 -hex </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;s/^.* //&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="配置-containerd-for-gpu">配置 Containerd for GPU<a class="hash-link" href="#配置-containerd-for-gpu" title="Direct link to heading">​</a></h3><ol><li>安装contaienrd nvidia runtime</li></ol><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LplD tabs__item--active">Debian系列</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LplD">RHEL系列</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -s -L https://nvidia.github.io/nvidia-container-runtime/gpgkey </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> apt-key </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">distribution</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">.</span><span class="token variable" style="color:#36acaa"> /etc/os-release</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> $ID$VERSION_ID</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -s -L https://nvidia.github.io/nvidia-container-runtime/</span><span class="token variable" style="color:#36acaa">$distribution</span><span class="token plain">/nvidia-container-runtime.list </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/apt/sources.list.d/nvidia-container-runtime.list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apt-get</span><span class="token plain"> update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> nvidia-container-runtime -y</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">distribution</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable builtin class-name" style="color:#36acaa">.</span><span class="token variable" style="color:#36acaa"> /etc/os-release</span><span class="token variable punctuation" style="color:#393A34">;</span><span class="token variable builtin class-name" style="color:#36acaa">echo</span><span class="token variable" style="color:#36acaa"> $ID$VERSION_ID</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -s -L https://nvidia.github.io/nvidia-container-runtime/</span><span class="token variable" style="color:#36acaa">$distribution</span><span class="token plain">/nvidia-container-runtime.repo </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/yum.repos.d/nvidia-container-runtime.repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum -y </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> nvidia-container-runtime</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><ol start="2"><li>配置containerd和cri工具</li></ol><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/containerd/config.toml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">version = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">root = &quot;/data/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">state = &quot;/run/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">plugin_dir = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">disabled_plugins = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">required_plugins = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">oom_score = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[grpc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;/run/containerd/containerd.sock&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_tls_cert = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_tls_key = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  max_recv_message_size = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  max_send_message_size = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[ttrpc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[debug]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  level = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[metrics]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  grpc_histogram = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[cgroup]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  path = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[timeouts]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.cleanup&quot; = &quot;5s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.load&quot; = &quot;5s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.shutdown&quot; = &quot;3s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.task.state&quot; = &quot;2s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[plugins]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    pause_threshold = 0.02</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    deletion_threshold = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    mutation_threshold = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    schedule_delay = &quot;0s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    startup_delay = &quot;100ms&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_tcp_service = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_server_address = &quot;127.0.0.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_server_port = &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_idle_timeout = &quot;4h0m0s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enable_selinux = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    selinux_category_range = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    sandbox_image = &quot;k8s.gcr.io/pause:3.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stats_collect_period = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    systemd_cgroup = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enable_tls_streaming = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    max_container_log_line_size = 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_cgroup = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_apparmor = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    restrict_oom_score_adj = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    max_concurrent_downloads = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_proc_mount = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    unset_seccomp_profile = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    tolerate_missing_hugetlb_controller = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_hugetlb_controller = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    ignore_image_defined_volumes = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      snapshotter = &quot;overlayfs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      default_runtime_name = &quot;runc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      no_pivot = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      disable_snapshot_annotations = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      discard_unpacked_layers = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_type = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.untrusted_workload_runtime]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_type = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_type = &quot;io.containerd.runtime.v1.linux&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      bin_dir = &quot;/opt/cni/bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      conf_dir = &quot;/etc/cni/net.d&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      max_conf_num = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      conf_template = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      key_model = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      tls_cert_file = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      tls_key_file = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.internal.v1.opt&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    path = &quot;/opt/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.internal.v1.restart&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    interval = &quot;10s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.metadata.v1.bolt&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    content_sharing_policy = &quot;shared&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    no_prometheus = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.runtime.v1.linux&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    shim = &quot;containerd-shim&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    runtime = &quot;nvidia-container-runtime&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    no_shim = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    shim_debug = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.runtime.v2.task&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    platforms = [&quot;linux/amd64&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.service.v1.diff-service&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    default = [&quot;walking&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    root_path = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    pool_name = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    base_image_size = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    async_remove = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="3"><li>验证安装结果</li></ol><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"> ctr image pull docker.io/nvidia/cuda:11.0.3-base-ubuntu20.04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ctr run --rm --gpus 0 -t docker.io/nvidia/cuda:11.0.3-base-ubuntu20.04 cuda-11.0.3-base-ubuntu20.04 nvidia-smi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| NVIDIA-SMI 450.80.02    Driver Version: 450.80.02    CUDA Version: 11.0     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|-------------------------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                               |                      |               MIG M. |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|===============================+======================+======================|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   0  Tesla T4            On   | 00000000:00:1E.0 Off |                    0 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| N/A   34C    P8     9W /  70W |      0MiB / 1µ5109MiB |      0%      Default |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|                               |                      |                  N/A |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------------------------------------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Processes:                                                                  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|        ID   ID                                                   Usage      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|=============================================================================|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  No running processes found                                                 |</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kubegems/kubegems.io/edit/main/docs/installation/kubernetes-install/kubeadm_cluster.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-12-19T08:30:24.000Z">2022/12/19</time></b> by <b>LinkMaq</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/installation/kubernetes-install/kubeadm"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">基于 Kubeadm 安装</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/installation/kubernetes-install/sealos"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">基于 SealOS 安装 HA 集群 (推荐)</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#使用-kubeadm-安装-ha-集群" class="table-of-contents__link toc-highlight">使用 Kubeadm 安装 HA 集群</a><ul><li><a href="#准备开始" class="table-of-contents__link toc-highlight">准备开始</a></li><li><a href="#允许-iptables-检查桥接流量" class="table-of-contents__link toc-highlight">允许 iptables 检查桥接流量</a></li><li><a href="#安装运行时" class="table-of-contents__link toc-highlight">安装运行时</a></li><li><a href="#安装-kubeadm" class="table-of-contents__link toc-highlight">安装 kubeadm</a></li><li><a href="#配置-containerd和-cri-工具" class="table-of-contents__link toc-highlight">配置 containerd和 cri 工具</a></li><li><a href="#部署-etcd-高可用集群" class="table-of-contents__link toc-highlight">部署 etcd 高可用集群</a></li><li><a href="#部署-master-集群" class="table-of-contents__link toc-highlight">部署 Master 集群</a></li><li><a href="#部署-kubelet节点" class="table-of-contents__link toc-highlight">部署 Kubelet节点</a></li><li><a href="#配置-containerd-for-gpu" class="table-of-contents__link toc-highlight">配置 Containerd for GPU</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer" id="footer"><div class="text--center">Copyright © 2023 KubeGems.io .</div></footer></div>
<script src="/assets/js/runtime~main.17182f77.js"></script>
<script src="/assets/js/main.50820c94.js"></script>
</body>
</html>