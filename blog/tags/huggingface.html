<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KubeGems RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KubeGems Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XB3JTSLM8D"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XB3JTSLM8D",{anonymize_ip:!0})</script><title data-rh="true">One post tagged with &quot;huggingface&quot; | KubeGems</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kubegems.io/blog/tags/huggingface"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="go-import" content="kubegems.io/kubegems git https://github.com/kubegems/kubegems"><meta data-rh="true" name="go-import" content="kubegems.io/bundle-controller git https://github.com/kubegems/bundle-controller"><meta data-rh="true" name="go-import" content="kubegems.io/configer git https://github.com/kubegems/configer"><meta data-rh="true" name="go-import" content="kubegems.io/ingress-nginx-operator git https://github.com/kubegems/ingress-nginx-operator"><meta data-rh="true" name="go-source" content="kubegems.io/kubegems https://github.com/kubegems/kubegems https://github.com/kubegems/kubegems/tree/master{/dir} https://github.com/kubegems/kubegems/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/bundle-controller https://github.com/kubegems/bundle-controller https://github.com/kubegems/bundle-controller/tree/master{/dir} https://github.com/kubegems/bundle-controller/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/configer https://github.com/kubegems/configer https://github.com/kubegems/configer/tree/master{/dir} https://github.com/kubegems/configer/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator/tree/master{/dir} https://github.com/kubegems/ingress-nginx-operator/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" property="og:title" content="One post tagged with &quot;huggingface&quot; | KubeGems"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kubegems.io/blog/tags/huggingface"><link data-rh="true" rel="alternate" href="https://kubegems.io/blog/tags/huggingface" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kubegems.io/blog/tags/huggingface" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.462b57f5.css">
<link rel="preload" href="/assets/js/runtime~main.3344d940.js" as="script">
<link rel="preload" href="/assets/js/main.7e3053f7.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link" href="/docs/concepts/what-is-kubegems">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a><a class="navbar__item navbar__link" href="/community/support">社群</a><a href="https://wj.qq.com/s2/10923500/96e0/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Contact</a></div><div class="navbar__items navbar__items--right"><div class="navbar__items navbar__item--dock"><div class="toggle navbar__dark toggle--disabled" role="button" tabindex="-1"><div class="toggle__icon toggle__icon--unchecked kubegems-icon icon-light"></div><div class="toggle__icon toggle__icon--checked kubegems-icon icon-dark"></div><input type="checkbox" class="toggle__screenreader-only" aria-label="Switch between dark and light mode"></div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="navbar__github"></a></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">最新博客</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-observ">OpenTelemetry 技术分享 Golang 篇</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems">KubeGems v1.23 正式 GA</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-ai">在 KubeGems 上运行 HuggingFace 模型</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-modelx">ModelX一款开源的机器学习模型管理仓库</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-nacos">KubeGems 启用 Nacos 配置中心</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-kind">使用 Kind 快速部署体验 KubeGems</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-skywalking">基于KubeGems可视化搭建SkyWalking</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-logging">KubeGems 中的日志设计</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-auth">KubeGems 用户认证和登录设计</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;huggingface&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-ai">在 KubeGems 上运行 HuggingFace 模型</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-20T00:00:00.000Z" itemprop="datePublished">2023年1月20日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/pepesi" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/pepesi.png" alt="yud"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pepesi" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yud</span></a></div><small class="avatar__subtitle" itemprop="description">developer@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>随着众多model zoo的出现，对于我们这样不懂得高深的数学基础知识的小白来说，能体验众多业界大牛开发的模型也不再是一个遥不可及的事情了。现在唯一的成本可能就是要熟悉各种开发框架，如 Transformers，OpenMMLab 等。KubeGems 在1.23版本中加入了模型商店的功能，其主要目的就是为了让开发者快速部署和体验这些优秀的模型，当前KubeGems主要对接Huggingface 和 OpenMMLab 两个model zoo，后续我们还将不断集成其他优秀的model zoo。本文将以HuggingFace为例，简单介绍如何在KubeGems上快速体验一个视觉问答的模型任务，以及一些实现背后的技术细节。</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubegems模型商店">KubeGems模型商店<a class="hash-link" href="#kubegems模型商店" title="Direct link to heading">​</a></h2><p>KubeGems 模型商店目前的设计目的是基于它来托管和集成第三方模型和自有模型；对于自有模型，我们通过<a href="https://github.com/kubegems/modelx" target="_blank" rel="noopener noreferrer" title="modelx">modelx</a>项目来存储其模型数据。同时在某些私有化场景下，我们也可以基于modex来导入私有化部署所需的模型。对于第三方的模型，通常我们仅仅存储其模型元数据（模型名字，模型数据的url地址等)，但不会储存其模型数据本身，KubeGems 模型商店提供了一个“模型同步器&quot;，它实际上是一个简单的 spider，会将HuggingFace的模型列表和其他任务相关信息记录下来，以便KubeGems用户可以在KubeGems中筛选和检索。当然modelx 也是可以存储第三方的模型的，例如我们要将一个优秀的开源模型部署到私有化环境下的时候，也可以将第三方的模型数据导入到modex中。</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/modelx-ef360228d64d7460c5ae7da92a77bb25.jpg" class="img_E7b_"></p><blockquote><p>modelx 是一个基于 OCI 的简单、高性能、可扩展的 ML/DL 模型存储库。</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="seldon-项目">Seldon 项目<a class="hash-link" href="#seldon-项目" title="Direct link to heading">​</a></h2><p>出于快速部署任意模型的目的，我们需要一套方案来快速集成主流的模型开发框架，同时还能为模型部署提供一些额外的监控数据，经过一些筛选，我们采用的是<a href="https://github.com/SeldonIO/seldon-core" target="_blank" rel="noopener noreferrer" title="seldon">SeldonIO</a>这个项目。seldon-core 是一个用于打包、部署、监控和管理数千个生产机器学习模型的 MLOps 框架，它主要支持两个类型的推理组件 <a href="https://github.com/triton-inference-server/server" target="_blank" rel="noopener noreferrer" title="triton">Triton</a>和 <a href="https://github.com/SeldonIO/MLServer" target="_blank" rel="noopener noreferrer" title="mlserver">MLServer</a>。Triton 推理服务器是NVIDIA AI平台的一部分，是一款开源推理服务软件，可帮助标准化模型部署和执行，并在生产中提供快速且可扩展的AI服务。MLServer 是机器学习模型的推理服务器，包括对多个框架、多模型服务等的支持，同时也很容易基于它来开发一个自定义的推理运行时，它由Seldon开发，当前KubeGems集成HuggingFace 就是基于 MLServer 项目。有关更多SeldonIO 和 MLServer的信息可以在其官网找到，所以这儿就不再赘述了。</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/e2e-model-serving.svg" class="img_E7b_"></p><blockquote><p>一点使用心得，seldon-core 的 operator 处理 SeldonDeployment 的时候，是通过硬编码编排内容的方式来提交Resource到 Kubernetes API Server，灵活度还是有点欠缺，例如我们想调整Deployment的updateStrategy的时候，就无从下手。单从部署的角度来看，KubeVela 使用模版的办法才是一个更优雅的办法。瑕不掩瑜，这点小问题不影响它是个不错的项目。</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mlserver-项目">MLServer 项目<a class="hash-link" href="#mlserver-项目" title="Direct link to heading">​</a></h2><p>MLServer 旨在提供一种简单的方法来通过 REST 和 gRPC 接口开始为机器学习模型提供服务，它实现了 KFServing 的 <a href="https://kserve.github.io/website/modelserving/inference_api/" target="_blank" rel="noopener noreferrer">Predict Protocol V2</a> 协议规范。</p><blockquote><p>本文中，Predict Protocol V2 我们简称其为“V2协议&quot;。 V2 推理协议的目的是提供一种标准化协议来与不同的推理服务器（例如 MLServer、Triton 等）和编排框架（例如 Seldon Core、KServe 等）进行通信。 V2 推理协议的规范定义了 REST 和 gRPC 接口和请求负载数据的格式。</p></blockquote><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/content-type.svg" class="img_E7b_"></p><p>MLServer 核心由两个部分组成，他们分别是<strong>编解码器(codecs)</strong>和<strong>运行时(runtime)</strong></p><p>编解码器</p><p>MLServer 的编解码器负责将用户的输入转换成兼容 <a href="https://kserve.github.io/website/modelserving/inference_api/" target="_blank" rel="noopener noreferrer">Predict Protocol V2</a> 协议的数据格式，同时也将模型的推理输出按照V2协议进行编码返回。MLServer 实现了对V2协议的数据编码的支持，同时允许用户开发和注册自定义的编解码器。</p><p>由于V2协议是一个面向推理服务的协议，并没有对媒体类型进行支持，所以对于要求直接将图片或者音频作为输入的任务来说，就需要开发自定义的编解码器。</p><p>其中编解码器又分成两个类型，分别是<strong>RequestCodec</strong> 和 <strong>InputCodec</strong></p><p>RequestCodec 会作为整个请求的默认编码器，当payload的input字段中没有提供Content-Type的时候，就会使用默认编码器编解码，InputCodec 则是真正执行编解码的编解码，每个RequestCodec应该有一个默认的InputCodec，当payload的input字段中提供了Content-Type的时候，则会使用指定Content-Type的编解码器对数据进行编解码。</p><p>例子：</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;parameters&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;content_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pd&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;inputs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;First Name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;datatype&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BYTES&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;parameters&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;content_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;str&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;shape&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;Joanne&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Michael&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Age&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;datatype&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;INT32&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;shape&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>以MLServer在解码这个请求输入的时候，默认使用PandasCodec对数据decode，返回一个pandas.DataFrame，但是 inputs<!-- -->[1]<!-- --> 指定了Content-Type 为<strong>str</strong>，那么这个字段将被编码成字符串。以上数据会decode为一个python字典</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;First Name&quot;: [&quot;Joanne&quot;, &quot;Michale&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Age&quot;: pandas.DataFrame([34, 22]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="运行时">运行时<a class="hash-link" href="#运行时" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/architecture.svg" class="img_E7b_"></p><p>运行时是MLServer实现推理的核心模块，当前MLServer内置了八个推理运行时，每个推理运行时可以注册自己专有的Content-type对应的InputCodec和RequestCodec。目前已经支持的推理框架如下：</p><table><thead><tr><th align="left">Framework</th><th align="left">Package Name</th><th align="left">Implementation Class</th><th align="left">Example</th><th align="left">Documentation</th></tr></thead><tbody><tr><td align="left">Scikit-Learn</td><td align="left"><code>mlserver-sklearn</code></td><td align="left"><code>mlserver_sklearn.SKLearnModel</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/sklearn/README.html" target="_blank" rel="noopener noreferrer">Scikit-Learn example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/sklearn.html" target="_blank" rel="noopener noreferrer">MLServer SKLearn</a></td></tr><tr><td align="left">XGBoost</td><td align="left"><code>mlserver-xgboost</code></td><td align="left"><code>mlserver_xgboost.XGBoostModel</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/xgboost/README.html" target="_blank" rel="noopener noreferrer">XGBoost example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/xgboost.html" target="_blank" rel="noopener noreferrer">MLServer XGBoost</a></td></tr><tr><td align="left">HuggingFace</td><td align="left"><code>mlserver-huggingface</code></td><td align="left"><code>mlserver_huggingface.HuggingFaceRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/huggingface/README.html" target="_blank" rel="noopener noreferrer">HuggingFace example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/huggingface.html" target="_blank" rel="noopener noreferrer">MLServer HuggingFace</a></td></tr><tr><td align="left">Spark MLlib</td><td align="left"><code>mlserver-mllib</code></td><td align="left"><code>mlserver_mllib.MLlibModel</code></td><td align="left">Coming Soon</td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/mllib.html" target="_blank" rel="noopener noreferrer">MLServer MLlib</a></td></tr><tr><td align="left">LightGBM</td><td align="left"><code>mlserver-lightgbm</code></td><td align="left"><code>mlserver_lightgbm.LightGBMModel</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/lightgbm/README.html" target="_blank" rel="noopener noreferrer">LightGBM example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/lightgbm.html" target="_blank" rel="noopener noreferrer">MLServer LightGBM</a></td></tr><tr><td align="left">Tempo</td><td align="left"><code>tempo</code></td><td align="left"><code>tempo.mlserver.InferenceRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/tempo/README.html" target="_blank" rel="noopener noreferrer">Tempo example</a></td><td align="left"><a href="https://github.com/SeldonIO/tempo" target="_blank" rel="noopener noreferrer"><code>github.com/SeldonIO/tempo</code></a></td></tr><tr><td align="left">MLflow</td><td align="left"><code>mlserver-mlflow</code></td><td align="left"><code>mlserver_mlflow.MLflowRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/mlflow/README.html" target="_blank" rel="noopener noreferrer">MLflow example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/mlflow.html" target="_blank" rel="noopener noreferrer">MLServer MLflow</a></td></tr><tr><td align="left">Alibi-Detect</td><td align="left"><code>mlserver-alibi-detect</code></td><td align="left"><code>mlserver_alibi_detect.AlibiDetectRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/alibi-detect/README.html" target="_blank" rel="noopener noreferrer">Alibi-detect example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/alibi-detect.html" target="_blank" rel="noopener noreferrer">MLServer Alibi-Detect</a></td></tr><tr><td align="left">Alibi-Explain</td><td align="left"><code>mlserver-alibi-explain</code></td><td align="left"><code>mlserver_alibi_explain.AlibiExplainRuntime</code></td><td align="left">Coming Soon</td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/alibi-explain.html" target="_blank" rel="noopener noreferrer">MLServer Alibi-Explain</a></td></tr></tbody></table><p>此外，想要开发一个自定义的推理运行时也十分容易，仅需要继承 <code> mlserver.MLModel</code>, 然后实现  <code>load </code>和 <code>predict</code>方法即可，常见的编码器MLServer已经提供，大部分可以直接复用，如果有特殊的媒体类型，开发一个自己的Codec也十分简单。这儿以transformers库为例，其推理运行时核心代码可以简化如下:</p><div class="codeBlockContainer_I0IT language-python-repl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-python-repl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class MyCustomRuntime(MLModel):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 加载模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def load(self) -&gt; bool:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        settings = get_settings_from_env()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pp = pipeline(**settings)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self._model = pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 执行推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def predict(self, *args, **kwargs):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prediction = self._model(*args, **kwargs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.serialize(prediction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在load方法中通过transformers库的pipeline来加载模型，在predict方法中使用模型来执行推理，返回被编码器encode之后的推理结果。</p><blockquote><p>KubeGems 的 OpenMMLab 模型推理运行时就是一个自定义的推理运行时，但是尚未支持完所有任务类型。</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署体验">部署体验<a class="hash-link" href="#部署体验" title="Direct link to heading">​</a></h2><p>我们经将HuggingFace的相关元数据存放在了KubeGems模型商店中，快速部署一个模型已经十分方便。用户可以在KubeGems模型商店内根据任务类型找到感兴趣的模型，快速部署到自己的环境中。一图胜千言，可以看接下来这两个例子。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="运行-huggingface-图片语义分割任务image-segmentation">运行 HuggingFace 图片语义分割任务（Image Segmentation）<a class="hash-link" href="#运行-huggingface-图片语义分割任务image-segmentation" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/1673932616990.png" alt="1673932616990" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="运行huggingface-视觉问答任务-visual-question-answering">运行HuggingFace 视觉问答任务 （Visual Question Answering）<a class="hash-link" href="#运行huggingface-视觉问答任务-visual-question-answering" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/1673933034799.png" alt="1673933034799" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="一些限制和问题">一些限制和问题<a class="hash-link" href="#一些限制和问题" title="Direct link to heading">​</a></h2><ol><li>HuggingFace 并非所有模型都能直接下载，部分模型是需要授权的，这类模型在部署的时候需要提供一个被授权用户的Token，KubeGems仅帮助快速部署和体验模型，使用相关模型的时候还是休要遵守HuggingFace的一些协议，许可，策略等。</li><li>HuggingFace 的模型文件虽然放在了CDN上，但是中国大陆访问的时候，还是会出现下载非常缓慢的情况，特别是十几G以上的大模型。当然，在真实部署的时候，可以通过NFS共享模型卷的方式实现缓存加速，或者实现自己的缓存加速方案，这取决于部署的基础设施情况了，KubeGems 研发团队内部已经完成了一套缓存加速管理方案（这部分并未开源）。</li><li>MLServer 当前并没有提供像openapi schema这样的东西来直接生成接口描述文件，由于其主要支持 Predict Protocol V2 协议，用户只能通过v2协议的metadata来了解输入和输出，这点对于非算法相关背景的同学来说不是很友好。所以我们也在调研其他支持媒体类型的适配器，（如 讯飞的 <a href="https://github.com/iflytek/aiges%EF%BC%89%EF%BC%8C%E4%BB%A5%E5%B0%BD%E5%8F%AF%E8%83%BD%E9%99%8D%E4%BD%8E%E4%BD%BF%E7%94%A8%E8%BF%99%E4%BA%9B%E4%BC%98%E7%A7%80%E7%9A%84%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9C%AC%E5%92%8C%E6%8E%A5%E5%85%A5%E7%9A%84%E5%BC%80%E5%8F%91%E6%88%90%E6%9C%AC%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/iflytek/aiges），以尽可能降低使用这些优秀的模型的学习成本和接入的开发成本。</a></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/mlops">mlops</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/huggingface">huggingface</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/seldon">seldon</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/mlserver">mlserver</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 在 KubeGems 上运行 HuggingFace 模型" href="/blog/kubegems-ai"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer" id="footer"><div class="row"><div class="col col--2"><img src="/img/logo.svg" style="margin-top:35px"></div><div class="col col--7"><div class="row"><div class="col col--2"></div><div class="col col--10"><div class="footer__div_HPxS"><div class="footer__link_e9CW">文档</div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/installation/kubegems-install/offline">离线安装</a></div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/installation/kubegems-install/self-hosted">快速安装</a></div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/category/快速入门">快速入门</a></div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/category/开发指南">API文档</a></div></div><div class="footer__div_HPxS"><div class="footer__link_e9CW">社区</div><div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/github-icon.svg">Github</a></div><div><a href="https://kubegems.slack.com/" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/slack-icon.svg">Slack</a></div><div><a href="https://twitter.com/KubeGems" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/twitter.svg">Twitter</a></div><div><a href="https://www.youtube.com/@LinkMaq1" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/youtube-icon.svg">YouTube</a></div><div><a href="https://space.bilibili.com/316793859" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/bilibili.png">Bilibili</a></div></div><div class="footer__div_HPxS"><div class="footer__link_e9CW">更多</div><div><a class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px" href="/blog">Blog</a></div><div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px">Github</a></div><div><a href="mailto:support@kubegems.io" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700">联系我们</a></div></div></div></div></div><div class="col col--1" style="margin-top:20px"><img src="/img/page/qrcode.png"></div><div class="col col--2" style="margin-top:20px"><div><div>Web: https://kubegems.io</div><div>Email: support@kubegems.io</div></div><div style="margin-top:5px"><div class="footer__title_ryMd">更便捷的云原生管理平台</div><div>Simplify your cloud native journey</div></div></div></div><div class="text--center" style="margin-top:30px">Copyright © 2023 kubegems.io .</div></footer></div>
<script src="/assets/js/runtime~main.3344d940.js"></script>
<script src="/assets/js/main.7e3053f7.js"></script>
</body>
</html>