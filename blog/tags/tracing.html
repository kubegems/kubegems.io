<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KubeGems RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KubeGems Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XB3JTSLM8D"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XB3JTSLM8D",{anonymize_ip:!0})</script><title data-rh="true">One post tagged with &quot;tracing&quot; | KubeGems</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kubegems.io/blog/tags/tracing"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="go-import" content="kubegems.io/kubegems git https://github.com/kubegems/kubegems"><meta data-rh="true" name="go-import" content="kubegems.io/bundle-controller git https://github.com/kubegems/bundle-controller"><meta data-rh="true" name="go-import" content="kubegems.io/configer git https://github.com/kubegems/configer"><meta data-rh="true" name="go-import" content="kubegems.io/ingress-nginx-operator git https://github.com/kubegems/ingress-nginx-operator"><meta data-rh="true" name="go-source" content="kubegems.io/kubegems https://github.com/kubegems/kubegems https://github.com/kubegems/kubegems/tree/master{/dir} https://github.com/kubegems/kubegems/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/bundle-controller https://github.com/kubegems/bundle-controller https://github.com/kubegems/bundle-controller/tree/master{/dir} https://github.com/kubegems/bundle-controller/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/configer https://github.com/kubegems/configer https://github.com/kubegems/configer/tree/master{/dir} https://github.com/kubegems/configer/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator/tree/master{/dir} https://github.com/kubegems/ingress-nginx-operator/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" property="og:title" content="One post tagged with &quot;tracing&quot; | KubeGems"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kubegems.io/blog/tags/tracing"><link data-rh="true" rel="alternate" href="https://kubegems.io/blog/tags/tracing" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kubegems.io/blog/tags/tracing" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.9cf2301e.css">
<link rel="preload" href="/assets/js/runtime~main.d5b5010d.js" as="script">
<link rel="preload" href="/assets/js/main.8b3d5ac5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:rgba(0, 0, 0, 0.03)" role="banner"><div class="announcementBarContent_KsVm">â­ï¸ <b>If you like KubeGems, give it a star on <a target="_blank" href="https://github.com/kubegems/kubegems">GitHub</a> and follow us on <a target="_blank" href="https://twitter.com/KubeGems">Twitter</a>  <a title="Twitter, Apache License 2.0 &lt;http://www.apache.org/licenses/LICENSE-2.0&gt;, via Wikimedia Commons" href="https://twitter.com/KubeGems"><img width="16" height="13" alt="Twitter-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/Twitter-logo.svg/32px-Twitter-logo.svg.png"></a></b> </div></div><nav class="navbar navbar--fixed-top navbarHideable_VLjY"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link" href="/docs/concepts/what-is-kubegems">æ–‡æ¡£</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/community/support">ç¤¾ç¾¤</a><a href="https://wj.qq.com/s2/10923500/96e0/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Contact</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/concepts/what-is-kubegems">v1.23</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/tracing" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="navbar__items navbar__item--dock"><div class="toggle navbar__dark toggle--disabled" role="button" tabindex="-1"><div class="toggle__icon toggle__icon--unchecked kubegems-icon icon-light"></div><div class="toggle__icon toggle__icon--checked kubegems-icon icon-dark"></div><input type="checkbox" class="toggle__screenreader-only" aria-label="Switch between dark and light mode"></div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="navbar__github"></a><a href="https://demo.kubegems.io" target="_blank" rel="noopener noreferrer" class="navbar__login button button--primary">ä½“éªŒ Demo</a><div class="navbar__login__account"><div class="navbar__login__info">è´¦å·: admin</div><div class="navbar__login__info">å¯†ç : demo!@#admin</div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">æœ€æ–°åšå®¢</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems">KubeGems v1.23 æ­£å¼ GA</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-modelx">ModelXä¸€æ¬¾å¼€æºçš„æœºå™¨å­¦ä¹ æ¨¡å‹ç®¡ç†ä»“åº“</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-nacos">KubeGems å¯ç”¨ Nacos é…ç½®ä¸­å¿ƒ</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-kind">ä½¿ç”¨ Kind å¿«é€Ÿéƒ¨ç½²ä½“éªŒ KubeGems</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-skywalking">åŸºäºKubeGemså¯è§†åŒ–æ­å»ºSkyWalking</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-logging">KubeGems ä¸­çš„æ—¥å¿—è®¾è®¡</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-auth">KubeGems ç”¨æˆ·è®¤è¯å’Œç™»å½•è®¾è®¡</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-observ">OpenTelemetry æŠ€æœ¯åˆ†äº« Golang ç¯‡</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;tracing&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-skywalking">åŸºäºKubeGemså¯è§†åŒ–æ­å»ºSkyWalking</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-06-23T00:00:00.000Z" itemprop="datePublished">2022å¹´6æœˆ23æ—¥</time> Â· <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/liutao-east" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/liutao-east.png" alt="liutao"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/liutao-east" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">liutao</span></a></div><small class="avatar__subtitle" itemprop="description">contributor@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Apache Skywalking</a> ä¸“é—¨ä¸ºå¾®æœåŠ¡æ¶æ„å’Œäº‘åŸç”Ÿæ¶æ„ç³»ç»Ÿè€Œè®¾è®¡å¹¶ä¸”æ”¯æŒåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªçš„APMç³»ç»Ÿã€‚<a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Apache Skywalking</a> é€šè¿‡åŠ è½½æ¢é’ˆçš„æ–¹å¼æ”¶é›†åº”ç”¨è°ƒç”¨é“¾è·¯ä¿¡æ¯ï¼Œå¹¶å¯¹é‡‡é›†çš„è°ƒç”¨é“¾è·¯ä¿¡æ¯è¿›è¡Œåˆ†æï¼Œç”Ÿæˆåº”ç”¨é—´å…³ç³»å’ŒæœåŠ¡é—´å…³ç³»ä»¥åŠæœåŠ¡æŒ‡æ ‡ã€‚<a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Apache Skywalking</a> ç›®å‰æ”¯æŒå¤šç§è¯­è¨€ï¼Œå…¶ä¸­åŒ…æ‹¬ <a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Java</a>ï¼Œ<a href="https://github.com/OpenSkywalking/skywalking-netcore" target="_blank" rel="noopener noreferrer">.Net Core</a>ï¼Œ<a href="https://github.com/OpenSkywalking/skywalking-nodejs" target="_blank" rel="noopener noreferrer">Node.js</a> å’Œ <a href="https://github.com/OpenSkywalking/skywalking-go" target="_blank" rel="noopener noreferrer">Go</a> è¯­è¨€ã€‚æœ¬æ–‡å°†ä»ä»¥ KubeGems åº”ç”¨å•†åº—å‡ºå‘ï¼Œæ¥å¿«é€Ÿæ­å»ºä¸€å¥—Skywalkingï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©åˆ°å¤§å®¶ã€‚</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="å®‰è£…skywalking-oap">å®‰è£…SkyWalking OAP<a class="hash-link" href="#å®‰è£…skywalking-oap" title="Direct link to heading">â€‹</a></h2><blockquote><p>KubeGemsåº”ç”¨å•†åº—(HelmChart)æ˜¯ä¸€ä¸ªæè¿°Kubernetesç›¸å…³èµ„æºçš„æ–‡ä»¶é›†åˆï¼Œå•ä¸ªåº”ç”¨å¯ä»¥ç”¨æ¥éƒ¨ç½²æŸäº›å¤æ‚çš„HTTPæœåŠ¡å™¨ä»¥åŠWebå…¨æ ˆåº”ç”¨ã€æ•°æ®åº“ã€ç¼“å­˜ç­‰</p></blockquote><ol><li><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="elasticsearchå®‰è£…">Elasticsearchå®‰è£…<a class="hash-link" href="#elasticsearchå®‰è£…" title="Direct link to heading">â€‹</a></h3></li></ol><p>åœ¨KubeGemsåº”ç”¨å•†åº—ä¸­æ‰¾åˆ°Elasticsearch</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/12ad60c8cc85f5045a1ee8a8f445261d.png" class="img_E7b_"></p><p>é€‰æ‹©éƒ¨ç½²7.13.2ç‰ˆæœ¬ï¼Œå¡«å†™å¿…è¦çš„ã€é¡¹ç›®ã€‘ã€ã€ç¯å¢ƒã€‘ç­‰ä¿¡æ¯</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/223d171147da56a82cb509968568f858.png" alt="img" class="img_E7b_"></p><p>ä¸ºæ–¹ä¾¿æ¼”ç¤ºï¼ŒMasterã€ESå‰¯æœ¬æ•°éƒ½é…ç½®ä¸º1ï¼Œå¯æ ¹æ®å®é™…éœ€è¦é…ç½®å‚æ•°ï¼Œè¿˜å¯ä»¥ä¿®æ”¹ <code>Values</code> ä¸­çš„é…ç½®</p><p>SkyWalking åˆå§‹åŒ– ElasticSearch index çš„æ˜¯é»˜è®¤è§„åˆ™æ˜¯ 1 å‰¯æœ¬ 1 åˆ†ç‰‡ï¼Œå®é™…åœ¨ä½¿ç”¨ä¸­ElasticSearch çš„å®ä¾‹æ•°æœ€å¥½å¤§äº 2 ä¸ª</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/ab6bec19080bfa2eaf357c5aa5adee8b.png" alt="img" class="img_E7b_"></p><p>ç‚¹å‡»éƒ¨ç½²ï¼ŒESæœåŠ¡æ­å»ºå®Œæˆã€‚</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/5732a57c4733b7001c28dbee0cec1bf9.png" alt="img" class="img_E7b_"></p><ol><li><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalkingå®‰è£…">SkyWalkingå®‰è£…<a class="hash-link" href="#skywalkingå®‰è£…" title="Direct link to heading">â€‹</a></h3></li></ol><p>åŒæ ·åœ¨åº”ç”¨å•†åº—æ‰¾åˆ°skywalkingåº”ç”¨ï¼Œå¡«å†™åŸºæœ¬ä¿¡æ¯ï¼Œè¿›å…¥è¯¦ç»†é…ç½®é¡µï¼Œå°†æ•°æ®è®¾ç½®ä¸ºESåº”ç”¨åç§°ä¸ç«¯å£</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/f8c24482817f6d19af4db47e08b06544.png" alt="img" class="img_E7b_"></p><p>ç‚¹å‡»éƒ¨ç½²ï¼Œå¯ä»¥çœ‹åˆ°skywalking-oapã€skywalking-uiæœåŠ¡å·²ç»éƒ¨ç½²å®Œæˆ</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/a0bde3d10539ffb239e0772921c84f85.png" alt="img" class="img_E7b_"></p><p>åœ¨KubeGemsæ§åˆ¶å°ï¼Œæ‰¾åˆ°å®¹å™¨æœåŠ¡--&gt;è¿è¡Œæ—¶--&gt;è·¯ç”±ï¼Œåˆ›å»ºè·¯ç”±ï¼Œå°†skywalking-uiæœåŠ¡åœ°å€è¿›è¡ŒåŸŸåæ˜ å°„ã€‚æˆ‘è¿™é‡Œç›´æ¥é‡‡ç”¨éšæœºåŸŸåï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±å…¬å¸å†…çš„åŸŸåæ‰‹åŠ¨é…ç½®ã€‚</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/4ea6c436becd2f6c9e6ec6d0f16c5d78.png" alt="img" class="img_E7b_"></p><p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è·¯ç”±è®¿é—®åœ°å€ï¼Œå·²ç»èƒ½æ­£å¸¸çœ‹skywalking-uiçš„é¡µé¢äº†</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/5c93cd6a4ac9c193f61edb3c92b156db.png" alt="img" class="img_E7b_"></p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/212b4f67b1839059813b35704ff9ad0c.png" alt="img" class="img_E7b_"></p><p>skywalkingæœåŠ¡æ­å»ºå®Œæˆå•¦ï¼Œæ˜¯ä¸æ˜¯éå¸¸çš„å¿«é€Ÿæ–¹ä¾¿ï¼Œå“ˆå“ˆå“ˆå“ˆå“ˆğŸ˜„</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalking-agent">SkyWalking Agent<a class="hash-link" href="#skywalking-agent" title="Direct link to heading">â€‹</a></h2><blockquote><p>æ‰€è°“Agentæ˜¯æŒ‡SkyWalkingä»å„ä¸ªå¹³å°(Java Pythonç­‰)æ”¶é›†ç›‘æ§æ•°æ®çš„ä»£ç†ï¼Œæ­¤å¤„æˆ‘ä»¬ä»¥ä¸ºJavaåº”ç”¨ä¸ºä¾‹ï¼Œæ”¶é›†Javaåº”ç”¨äº§ç”Ÿçš„å„ç§ç›‘æ§æ•°æ®</p></blockquote><p>SkyWalkingçš„æ•°æ®é‡‡é›†ä¸»è¦æ˜¯é€šè¿‡<strong>ä¸šåŠ¡æ¢é’ˆ(Agent)</strong>æ¥å®ç°çš„ï¼Œé’ˆå¯¹ä¸åŒçš„ç¼–ç¨‹è¯­è¨€SkyWalkingæä¾›äº†å¯¹åº”çš„Agentå®ç°ã€‚Javaå¾®æœåŠ¡æ¥å…¥SkyWalkingå¯ä»¥ä½¿ç”¨â€œSkyWalking Java Agentâ€æ¥ä¸ŠæŠ¥ç›‘æ§æ•°æ®ã€‚</p><p>è¿™å°±éœ€è¦Javaå¾®æœåŠ¡åœ¨éƒ¨ç½²å¯åŠ¨çš„è¿‡ç¨‹ä¸­éœ€è¦è·å– <strong>SkyWalking Java Agent</strong> æ¢é’ˆåŒ…ï¼Œå¹¶åœ¨å¯åŠ¨å‚æ•°ä¸­é€šè¿‡<code>--javaagent:xxx</code>è¿›è¡Œå‚æ•°æŒ‡å®šã€‚è€Œå…·ä½“çš„é›†æˆæ–¹å¼å¤§è‡´æœ‰ä»¥ä¸‹å››ç§ï¼š</p><ul><li><p>ä½¿ç”¨å®˜æ–¹æä¾›çš„åŸºç¡€é•œåƒï¼›</p></li><li><p>å°†agentåŒ…æ„å»ºåˆ°å·²å­˜åœ¨çš„åŸºç¡€é•œåƒä¸­ï¼›</p></li><li><p>å°†agentåŒ…æ”¾åˆ°å…±äº«volumeä¸­;</p></li><li><p>é€šè¿‡sidecar æ¨¡å¼æŒ‚è½½agentï¼›</p></li></ul><p>å…¶ä¸­å‰ä¸¤ç§æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡åœ¨æ„å»ºDockeré•œåƒçš„è¿‡ç¨‹ä¸­å°†Agentä¾èµ–æ‰“åŒ…é›†æˆåˆ°JavaæœåŠ¡çš„Dockeré•œåƒä¸­ï¼Œè€Œsidecaræ¨¡å¼åˆ™æ˜¯åˆ©ç”¨k8sçš„ç›¸å…³ç‰¹æ€§æ¥å®ç°åœ¨<strong>å®¹å™¨å¯åŠ¨æ—¶æŒ‚è½½Agent</strong>ç›¸å…³ä¾èµ–ã€‚</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ä¸ºä»€ä¹ˆé€‰æ‹©sidecar">ä¸ºä»€ä¹ˆé€‰æ‹©sidecar<a class="hash-link" href="#ä¸ºä»€ä¹ˆé€‰æ‹©sidecar" title="Direct link to heading">â€‹</a></h3><p>Sidecardä¸»è¦åŸç†æ˜¯é€šè¿‡Kubernetesçš„åˆå§‹åŒ–å®¹å™¨<code>initContainers</code>æ¥å®ç°çš„ï¼Œ<code>initContainers</code>æ˜¯ä¸€ç§ä¸“ç”¨å®¹å™¨ï¼Œå®ƒåº”ç”¨å®¹å™¨å¯åŠ¨ä¹‹å‰è¿è¡Œï¼Œå¯ä»¥ç”¨äºå®Œæˆåº”ç”¨å¯åŠ¨å‰çš„å¿…è¦åˆå§‹åŒ–å·¥ä½œã€‚å¦‚æœå¾®æœåŠ¡æ˜¯ç›´æ¥éƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ï¼Œé‚£ä¹ˆé‡‡ç”¨ sidecar æ¨¡å¼æ¥ä½¿ç”¨ SkyWalking Agentä¼šæ›´åŠ æ–¹ä¾¿ï¼Œå› ä¸ºè¿™ç§æ–¹å¼<strong>ä¸éœ€è¦ä¿®æ”¹åŸæ¥çš„åŸºç¡€é•œåƒï¼Œä¹Ÿä¸éœ€è¦é‡æ–°æ„å»ºæ–°çš„æœåŠ¡é•œåƒ</strong>ï¼Œè€Œæ˜¯ä¼šä»¥sidecaræ¨¡å¼ï¼Œé€šè¿‡å…±äº«çš„volumeå°†agentæ‰€éœ€çš„ç›¸å…³æ–‡ä»¶ç›´æ¥æŒ‚è½½åˆ°å·²ç»å­˜åœ¨çš„æœåŠ¡é•œåƒä¸­ã€‚</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="åˆå§‹åŒ–å®¹å™¨initcontainers">åˆå§‹åŒ–å®¹å™¨InitContainers<a class="hash-link" href="#åˆå§‹åŒ–å®¹å™¨initcontainers" title="Direct link to heading">â€‹</a></h3><p>InitContainers å°±æ˜¯ç”¨æ¥åšåˆå§‹åŒ–å·¥ä½œçš„å®¹å™¨ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼Œå¦‚æœæœ‰å¤šä¸ªçš„è¯ï¼Œè¿™äº›å®¹å™¨ä¼šæŒ‰å®šä¹‰çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œåªæœ‰æ‰€æœ‰çš„initContainersæ‰§è¡Œå®Œåï¼Œä¸»å®¹å™¨æ‰ä¼šè¢«å¯åŠ¨ã€‚æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªPodé‡Œé¢çš„æ‰€æœ‰å®¹å™¨æ˜¯å…±äº«æ•°æ®å·å’Œç½‘ç»œå‘½åç©ºé—´çš„ï¼Œæ‰€ä»¥<code>initContainers</code>é‡Œé¢äº§ç”Ÿçš„æ•°æ®å¯ä»¥è¢«ä¸»å®¹å™¨ä½¿ç”¨åˆ°çš„</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="è‡ªå®šä¹‰skywalking-agenté•œåƒ"><strong>è‡ªå®šä¹‰SkyWalking Agenté•œåƒ</strong><a class="hash-link" href="#è‡ªå®šä¹‰skywalking-agenté•œåƒ" title="Direct link to heading">â€‹</a></h3><ul><li>ä¸‹è½½SkyWalkingå®˜æ–¹å‘è¡ŒåŒ…ï¼Œå¹¶è§£å‹åˆ°æŒ‡å®šç›®å½•</li></ul><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#ä¸‹è½½skywalking-8.6.0 for es7ç‰ˆæœ¬çš„å‘å¸ƒåŒ…ï¼Œä¸éƒ¨ç½²çš„skywalkingåç«¯ç‰ˆæœ¬ä¸€è‡´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ wget https://archive.apache.org/dist/skywalking/8.6.0/apache-skywalking-apm-8.6.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#å°†ä¸‹è½½çš„å‘å¸ƒåŒ…è§£å‹åˆ°å½“å‰ç›®å½•</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tar -zxvf apache-skywalking-apm-es7-8.6.0.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>ä¿®æ”¹é…ç½®ï¼Œç¼–è¾‘config/agent.configæ–‡ä»¶ï¼Œä»¥ä¸‹åªåˆ—å‡ºéƒ¨åˆ†é…ç½®é¡¹</li></ul><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># The agent namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># agent.namespace=${SW_AGENT_NAMESPACE:default-namespace}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># è¡¨ç¤ºæä¾›ç›¸åŒåŠŸèƒ½/é€»è¾‘çš„é€»è¾‘ç»„çš„æœåŠ¡åç§°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">agent.service_name=${SW_AGENT_NAME:Your_ApplicationName}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># OAPæœåŠ¡åœ°å€ï¼Œä¿®æ”¹é»˜è®¤åœ°å€ä¸ºskywalking-oapæœåŠ¡å</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collector.backend_service=${SW_AGENT_COLLECTOR_BACKEND_SERVICES:skywalking-oap:11800}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># æ—¥å¿—æ–‡ä»¶å</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging.file_name=${SW_LOGGING_FILE_NAME:skywalking-api.log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># æ—¥å¿—çº§åˆ«ï¼šTRACEã€DEBUGã€INFOã€WARNã€ERRORã€OFFã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging.level=${SW_LOGGING_LEVEL:INFO}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># æœ€å¤§å†å²æ—¥å¿—æ–‡ä»¶ã€‚å‘ç”Ÿç¿»è½¬æ—¶ï¼Œå¦‚æœæ—¥å¿—æ–‡ä»¶è¶…è¿‡æ­¤æ•°é‡ï¼Œåˆ™æœ€æ—§çš„æ–‡ä»¶å°†è¢«åˆ é™¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè´Ÿæ•°æˆ–é›¶è¡¨ç¤ºå…³é—­ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging.max_history_files=${SW_LOGGING_MAX_HISTORY_FILES:10}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># æŒ‚è½½æ’ä»¶çš„ç‰¹å®šæ–‡ä»¶å¤¹ã€‚å®‰è£…æ–‡ä»¶å¤¹ä¸­çš„æ’ä»¶å¯ä»¥å·¥ä½œã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin.mount=${SW_MOUNT_FOLDERS:plugins,activations,bootstrap-plugins}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># æ’é™¤æ’ä»¶ç›®å½•ä¸­å®šä¹‰çš„ä¸€äº›æ’ä»¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># plugin.exclude_plugins=${SW_EXCLUDE_PLUGINS:}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>æ„å»ºskywalking-agent sidecar é•œåƒå¹¶pushè‡³hubç§æœ‰é•œåƒä»“åº“</li></ul><p>åœ¨å‰é¢æ­¥éª¤ä¸­è§£å‹çš„skywalkingå‘è¡ŒåŒ…ï¼Œè¿›å…¥agentç›®å½•ç¼–å†™Dockerfileæ–‡ä»¶</p><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM busybox:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN set -eux &amp;&amp; mkdir -p /usr/skywalking/agent/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY . /usr/skywalking/agent/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>å®ŒæˆDockeræ–‡ä»¶ç¼–å†™åï¼Œæ‰§è¡Œé•œåƒæ„å»ºå‘½ä»¤ï¼š</li></ul><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># æ„å»ºé•œåƒï¼Œæ³¨æ„æœ€åä¸€ä¸ª.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t &lt;your-registry&gt;/skywalking-agent-sidecar:8.6.0 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># é•œåƒæ¨é€è‡³ç§æœ‰Harborä»“åº“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker push &lt;your-registry&gt;/skywalking-agent-sidecar:8.6.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sidecaræŒ‚è½½">sidecaræŒ‚è½½<a class="hash-link" href="#sidecaræŒ‚è½½" title="Direct link to heading">â€‹</a></h3><p>åœ¨KubeGemsä¸­æ‰¾åˆ° ã€å·¥ä½œè´Ÿè½½ã€‘ï¼Œç¼–è¾‘æ›´æ–°å·¥ä½œè´Ÿè½½è¿›å…¥åˆ°å®¹å™¨é•œåƒé¡µé¢</p><p><strong>è®¾ç½®SWç¯å¢ƒå˜é‡</strong>ï¼Œç¼–è¾‘å·¥ä½œå®¹å™¨ </p><ul><li>SW_AGENT_NAME=\&lt;YourApplicationName<!-- -->&gt;</li><li>JAVA_TOOL_OPTIONS=-javaagent:/usr/skywalking/agent/skywalking-agent.jar</li></ul><p><strong>æ·»åŠ å®¹å™¨é•œåƒ</strong>ï¼Œé€‰æ‹©åˆå§‹åŒ–å®¹å™¨å°†skywalking-agent-sidecardé•œåƒè¿›è¡ŒæŒ‚è½½ï¼Œå¹¶æ·»åŠ å¯åŠ¨å‘½ä»¤</p><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sh -c /usr/skywalking/agent/* /skywalking/agent</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/cad0e71470d041f2ef2dbf86da258abc.png" alt="img" class="img_E7b_"></p><p><strong>æŒ‚è½½emptyDirå·</strong></p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/e34455919c3c6dbd6334609aad32bd26.png" alt="img" class="img_E7b_"></p><p>ç‚¹å‡»ç¡®å®šä¿å­˜å·¥ä½œè´Ÿè½½ä¿¡æ¯ï¼Œè‡ªåŠ¨é‡å¯åè¿›å…¥åº”ç”¨å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°agentç›®æ ‡å·²ç»åŠ è½½åˆ°å®¹å™¨ä¸­äº†</p><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">root@pod-7bc77468ff-7b4xt:/# cd /usr/skywalking/agent/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@pod-7bc77468ff-7b4xt:/usr/skywalking/agent# ll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 17716</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwxrwx 9 root root      194 May 19 08:14 ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 3 root root       27 May 19 08:14 ../</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root      114 May 19 08:14 Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root     4096 May 19 08:14 activations/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       85 May 19 08:14 bootstrap-plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       64 May 19 08:14 config/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       32 May 19 08:14 logs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root     4096 May 19 08:14 optional-plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       45 May 19 08:14 optional-reporter-plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root     4096 May 19 08:14 plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 18121582 May 19 08:14 skywalking-agent.jar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>æ­¤æ—¶æ‰“å¼€skywalking-uiï¼Œå·²ç»å¯ä»¥çœ‹åˆ°ç›‘æ§æ•°æ®äº†</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/144d7ab53fc6553098b3e70193f2a74d.png" alt="img" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalkingåŠ¨æ€é…ç½®">SkyWalkingåŠ¨æ€é…ç½®<a class="hash-link" href="#skywalkingåŠ¨æ€é…ç½®" title="Direct link to heading">â€‹</a></h2><p>SkyWalkingé…ç½®ä¸»è¦æ˜¯é€šè¿‡<code>application.yml</code>æ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡è®¾ç½®çš„ï¼Œå…¶ä¸­ä¸€äº›è¿˜æ”¯æŒæ¥è‡ªä¸Šæ¸¸ç®¡ç†ç³»ç»Ÿçš„åŠ¨æ€è®¾ç½®ã€‚ä¸Šæ¸¸æœåŠ¡æ”¯æŒåŒ…æ‹¬Zookeeperã€Etcdã€Consulã€Apolloã€Nacosã€K8s-configmapç­‰ã€‚</p><p>ç›®å‰SkyWalkingæ”¯æŒä»¥ä¸‹åŠ¨æ€é…ç½®</p><table><thead><tr><th align="center">é…ç½®</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="center">agent-analyzer.default.slowDBAccessThreshold</td><td align="left"><code>receiver-trace/default/slowDBAccessThreshold</code>æ…¢æ•°æ®åº“è¯­å¥çš„é˜ˆå€¼ï¼Œè¦†ç›–<code>application.yml</code>.</td></tr><tr><td align="center">agent-analyzer.default.uninstrumentedGateways</td><td align="left">æœªæ£€æµ‹çš„ç½‘å…³è¦†ç›–<code>gateways.yml</code>.</td></tr><tr><td align="center">alarm.default.alarm-settings</td><td align="left">è­¦æŠ¥è®¾ç½®å°†è¦†ç›–<code>alarm-settings.yml</code>ã€‚</td></tr><tr><td align="center">core.default.apdexThreshold</td><td align="left">apdex é˜ˆå€¼è®¾ç½®ï¼Œå°†è¦†ç›–<code>service-apdex-threshold.yml</code>.</td></tr><tr><td align="center">core.default.endpoint-name-grouping</td><td align="left">ç«¯ç‚¹åç§°åˆ†ç»„è®¾ç½®ï¼Œå°†è¦†ç›–<code>endpoint-name-grouping.yml</code>.</td></tr><tr><td align="center">agent-analyzer.default.sampleRate</td><td align="left">è·Ÿè¸ªé‡‡æ ·ï¼Œè¦†ç›–<code>receiver-trace/default/sampleRate</code>.<code>application.yml</code></td></tr><tr><td align="center">agent-analyzer.default.slowTraceSegmentThreshold</td><td align="left">è®¾ç½®è¿™ä¸ªå…³äºå»¶è¿Ÿçš„é˜ˆå€¼å°†ä½¿æ…¢è·Ÿè¸ªæ®µåœ¨èŠ±è´¹æ›´å¤šæ—¶é—´æ—¶è¢«é‡‡æ ·ï¼Œå³ä½¿é‡‡æ ·æœºåˆ¶è¢«æ¿€æ´»ã€‚é»˜è®¤å€¼ä¸º<code>-1</code>ï¼Œè¿™æ„å‘³ç€ä¸ä¼šå¯¹æ…¢é€Ÿè·Ÿè¸ªè¿›è¡Œé‡‡æ ·ã€‚å•ä½ï¼Œæ¯«ç§’ã€‚çš„è¦†ç›–<code>receiver-trace/default/slowTraceSegmentThreshold</code>ã€‚<code>application.yml</code></td></tr><tr><td align="center">configuration-discovery.default.agentConfigurations</td><td align="left">ConfigurationDiscovery è®¾ç½®</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k8s-configmap">k8s-configmap<a class="hash-link" href="#k8s-configmap" title="Direct link to heading">â€‹</a></h3><blockquote><p>å¾ˆå¤šåº”ç”¨åœ¨å…¶åˆå§‹åŒ–æˆ–è¿è¡ŒæœŸé—´è¦ä¾èµ–ä¸€äº›é…ç½®ä¿¡æ¯ã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œ å­˜åœ¨è¦è°ƒæ•´é…ç½®å‚æ•°æ‰€è®¾ç½®çš„æ•°å€¼çš„éœ€æ±‚ã€‚ ConfigMap æ˜¯ Kubernetes ç”¨æ¥å‘åº”ç”¨ Pod ä¸­æ³¨å…¥é…ç½®æ•°æ®çš„æ–¹æ³•ã€‚</p></blockquote><p>æœ¬æ–‡ä»‹ç»å¦‚ä½•é€šè¿‡KubGemså¹³å°åŠ¨æ€é…ç½®SkyWalkingå‚æ•°</p><ul><li>KubGemså·¥ä½œå° --&gt; é…ç½®ä¸­å¿ƒ --&gt; é…ç½® --&gt; åˆ›å»ºé…ç½®</li><li>æ·»åŠ å‚æ•°åŠå‘Šè­¦è§„åˆ™é…ç½®</li></ul><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/ae9fc31a7b36272e16f1ecaa7a686a4b.png" alt="img" class="img_E7b_"></p><ul><li>ç¼–è¾‘yamlï¼Œæ·»åŠ ä¿®æ”¹appã€compoentæ ‡ç­¾å€¼</li></ul><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: skywalking-dynamic-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: &#x27;2022-05-16T11:14:23Z&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    component: oap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  agent-analyzer.default.sampleRate: &#x27;7000&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  agent-analyzer.default.slowDBAccessThreshold: default:250,mongodb:100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alarm.default.alarm-settings: &gt;-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Rule unique name, must be ended with `_rule`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service_resp_time_rule:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metrics-name: service_resp_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        op: &quot;&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threshold: 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        period: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        silence-period: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message: æœ€è¿‘3åˆ†é’Ÿå†…æœåŠ¡ {name} çš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡2ç§’</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>ä¿®æ”¹skywalking-oapç¯å¢ƒå˜é‡ä¿¡æ¯ï¼Œä½¿ç”¨k8s-configmapé…ç½®</li></ul><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: skywalking-oap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: skywalking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/instance: skywalking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: SW_CLUSTER_K8S_LABEL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: app=skywalking,component=oap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: SW_CONFIGURATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: k8s-configmap</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><blockquote><p><code>SW_CONFIGURATION= k8s-configmap</code>ï¼ŒåŠ¨æ€é…ç½®é‡‡ç”¨k8s-configmap
<code>SW_CLUSTER_K8S_LABEL= app=collector,release=skywalking</code>ï¼Œæ ¹æ®è¿™ä¸ªå€¼è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„configmap</p></blockquote><ul><li>é‡å¯skywalking-oapï¼Œé…ç½®ç”Ÿæ•ˆ</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalkingé…ç½®ä¼˜åŒ–">SkyWalkingé…ç½®ä¼˜åŒ–<a class="hash-link" href="#skywalkingé…ç½®ä¼˜åŒ–" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="oapä¼˜åŒ–">OAPä¼˜åŒ–<a class="hash-link" href="#oapä¼˜åŒ–" title="Direct link to heading">â€‹</a></h3><p> skywalkingå†™å…¥ESçš„æ“ä½œæ˜¯ä½¿ç”¨äº†ESçš„æ‰¹é‡å†™å…¥æ¥å£ï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯è°ƒæ•´ç›¸å…³å‚æ•°å°½é‡é™ä½ESç´¢å¼•çš„å†™å…¥é¢‘ç‡ã€‚ å‚æ•°è°ƒæ•´ä¸»è¦æ˜¯é’ˆå¯¹skywalkingçš„é…ç½®æ–‡ä»¶`<code>application.yml</code>ï¼Œç›¸å…³å‚æ•°å¦‚ä¸‹ï¼š  </p><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">storage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elasticsearch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:4000} # Execute the bulk every 2000 requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bulkSize: ${SW_STORAGE_ES_BULK_SIZE:40} # flush the bulk every 20mb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:30} # flush the bulk every 10 seconds whatever the number of requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:4} # the number of concurrent requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:8000}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>è°ƒæ•´ bulkActions é»˜è®¤2000æ¬¡è¯·æ±‚æ‰¹é‡å†™å…¥ä¸€æ¬¡æ”¹åˆ°4000æ¬¡ï¼›</p><ul><li><p>bulkSizeæ‰¹é‡åˆ·æ–°ä»20Mä¸€æ¬¡åˆ°40Mä¸€æ¬¡ï¼›</p></li><li><p>flushIntervalæ¯10ç§’åˆ·æ–°ä¸€æ¬¡å †æ”¹ä¸ºæ¯30ç§’åˆ·æ–°ï¼›</p></li><li><p>concurrentRequestsæŸ¥è¯¢çš„æœ€å¤§æ•°é‡ç”±5000æ”¹ä¸º8000ã€‚</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="è¿‡æ»¤ä¸éœ€è¦ç›‘æ§çš„æ¥å£">è¿‡æ»¤ä¸éœ€è¦ç›‘æ§çš„æ¥å£<a class="hash-link" href="#è¿‡æ»¤ä¸éœ€è¦ç›‘æ§çš„æ¥å£" title="Direct link to heading">â€‹</a></h3><ul><li><p>åˆ¶ä½œagenté•œåƒæ—¶ï¼Œå°†<code>apm-trace-ignore-plugin-8.6.0.jar</code>å¤åˆ¶åˆ°<code>\plugins</code>ä¸‹é¢</p></li><li><p>configç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ <code>apm-trace-ignore-plugin.config</code>ï¼Œæ–‡ä»¶å†…å®¹ä¸ºï¼š </p></li></ul><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">trace.ignore_path=${SW_AGENT_TRACE_IGNORE_PATH:/actuator,/actuator/**,/admin/**,/nacos/**}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="è®¾ç½®é‡‡æ ·ç‡">è®¾ç½®é‡‡æ ·ç‡<a class="hash-link" href="#è®¾ç½®é‡‡æ ·ç‡" title="Direct link to heading">â€‹</a></h3><p> åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSkyWalkingä¼šé‡‡é›†æ‰€æœ‰è¿½è¸ªçš„æ•°æ®ã€‚ä½†æ˜¯å¦‚æœç³»ç»Ÿæ¯”è¾ƒå¤æ‚ï¼Œé‡‡é›†çš„ç«¯ç‚¹æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå¯èƒ½å­˜å‚¨å‹åŠ›æ¯”è¾ƒå¤§ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä¿®æ”¹é…ç½®ï¼Œåªå­˜å‚¨éƒ¨åˆ†çš„è°ƒç”¨é“¾è·¯ä¿¡æ¯ã€‚æ¯”å¦‚ï¼š50%ã€‚ è®¾ç½®é‡‡æ ·ç‡çš„æ—¶å€™å¹¶ä¸ä¼šå½±å“ç›¸å…³æŒ‡æ ‡çš„è®¡ç®—ã€‚åŒ…æ‹¬æœåŠ¡ï¼ŒæœåŠ¡å®ä¾‹ï¼Œç«¯ç‚¹ï¼Œæ‹“æ‰‘å›¾ç­‰ç›¸å…³æŒ‡æ ‡çš„è®¡ç®—è¿˜æ˜¯ä½¿ç”¨å®Œæ•´çš„æ•°æ®è®¡ç®—çš„ã€‚ </p><p>åœ¨k8s-configmapä¸­ï¼Œæ·»åŠ é…ç½®é¡¹ï¼Œè®¾ç½®é‡‡æ ·ç‡ä¸º70%:</p><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">agent-analyzer.default.sampleRate: &#x27;7000&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="æ€»ç»“">æ€»ç»“<a class="hash-link" href="#æ€»ç»“" title="Direct link to heading">â€‹</a></h2><p>æœ¬æ–‡ç”¨äºæŒ‡å¯¼ç”¨äºåœ¨ KubeGems ä¸­å¿«é€Ÿéƒ¨ç½²å¹¶è¿è¡Œ SkyWalkingæœåŠ¡ï¼Œç”¨æˆ·å¯åœ¨ç ”å‘ç¯å¢ƒä¸­å¿«é€Ÿå¯ç”¨æ­¤åŠŸèƒ½æ¥éªŒè¯ APM ç›¸å…³åŠŸèƒ½ã€‚æ›´å¤šå…³äºKubeGems ä¸ SkyWalking çš„é…ç½®ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä¼šæŒç»­æ›´æ–°ï¼Œæ•¬è¯·å…³æ³¨ã€‚</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/tracing">tracing</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/observability">observability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about åŸºäºKubeGemså¯è§†åŒ–æ­å»ºSkyWalking" href="/blog/kubegems-skywalking"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-observ">OpenTelemetry æŠ€æœ¯åˆ†äº« Golang ç¯‡</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-10T00:00:00.000Z" itemprop="datePublished">2022å¹´2æœˆ10æ—¥</time> Â· <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/jojotong" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/jojotong.png" alt="jojotong"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jojotong" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">jojotong</span></a></div><small class="avatar__subtitle" itemprop="description">developer@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><iframe width="360" height="200" src="https://www.youtube.com/embed/3i9dRLQxeaA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><iframe src="//player.bilibili.com/player.html?aid=224241127&amp;bvid=BV1m8411T7MG&amp;cid=1002257669&amp;page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="360" height="200">  </iframe><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opentelemetry">OpenTelemetry<a class="hash-link" href="#opentelemetry" title="Direct link to heading">â€‹</a></h2><p>Opentelemetry æ˜¯ä¸€ä¸ªCNCFç¤¾åŒºä¸‹ä¸€ä¸ªå¼€æºçš„å¯è§‚æµ‹æ€§æ¡†æ¶ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç»„å·¥å…·ã€API å’Œ SDK çš„é›†åˆï¼Œæ¥æ£€æµ‹ã€ç”Ÿæˆã€æ”¶é›†å’Œå¯¼å‡ºå¯è§‚æµ‹æ€§æ•°æ®ï¼ˆ<strong>æŒ‡æ ‡ã€æ—¥å¿—å’Œé“¾è·¯</strong>ï¼‰ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬åˆ†æè½¯ä»¶çš„æ€§èƒ½å’Œè¡Œä¸ºã€‚</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ä¼˜ç‚¹">ä¼˜ç‚¹<a class="hash-link" href="#ä¼˜ç‚¹" title="Direct link to heading">â€‹</a></h4><p>è¿‡å»ï¼Œæ£€æµ‹ä»£ç çš„æ–¹å¼ä¼šæœ‰æ‰€ä¸åŒï¼Œå› ä¸ºæ¯ä¸ªå¯è§‚æµ‹æ€§åç«¯éƒ½æœ‰è‡ªå·±çš„æ£€æµ‹åº“å’Œä»£ç†ï¼Œç”¨äºå‘å·¥å…·å‘é€æ•°æ®ã€‚</p><p>è¿™æ„å‘³ç€æ²¡æœ‰ç”¨äºå°†æ•°æ®å‘é€åˆ°å¯è§‚å¯Ÿæ€§åç«¯çš„æ ‡å‡†åŒ–æ•°æ®æ ¼å¼ï¼Œç”±äºç¼ºä¹æ ‡å‡†åŒ–ï¼Œæœ€ç»ˆç»“æœæ˜¯ç¼ºä¹æ•°æ®å¯ç§»æ¤æ€§å’Œç”¨æˆ·ç»´æŠ¤ä»ªå™¨åº“çš„è´Ÿæ‹…ã€‚</p><p>Opentelemetryå› æ­¤è€Œç”Ÿï¼Œæ‹¥æœ‰æ¥è‡ªäº‘æä¾›å•†ã€ <a href="https://opentelemetry.io/ecosystem/vendors/" target="_blank" rel="noopener noreferrer">ä¾›åº”å•†</a>å’Œæœ€ç»ˆç”¨æˆ·çš„å¹¿æ³›è¡Œä¸šæ”¯æŒå’Œé‡‡ç”¨ï¼Œæä¾›äº†ï¼š</p><ul><li><p><a href="https://opentelemetry.io/docs/instrumentation" target="_blank" rel="noopener noreferrer">æ¯ç§è¯­è¨€</a>éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹äºä¾›åº”å•†çš„instrumentation library ï¼Œæ”¯æŒè‡ªåŠ¨å’Œæ‰‹åŠ¨ã€‚</p></li><li><p>å¯ä»¥ä»¥å¤šç§æ–¹å¼éƒ¨ç½²çš„å•ä¸ªä¾›åº”å•†ä¸­ç«‹çš„<a href="https://opentelemetry.io/docs/collector" target="_blank" rel="noopener noreferrer">æ”¶é›†å™¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</a></p></li><li><p>ç”Ÿæˆã€å‘å‡ºã€æ”¶é›†ã€å¤„ç†å’Œå¯¼å‡ºé¥æµ‹æ•°æ®çš„ç«¯åˆ°ç«¯å®ç°ã€‚</p></li><li><p>å®Œå…¨æ§åˆ¶æ‚¨çš„æ•°æ®ï¼Œèƒ½å¤Ÿé€šè¿‡é…ç½®å°†æ•°æ®å¹¶è¡Œå‘é€åˆ°å¤šä¸ªç›®çš„åœ°ã€‚</p></li><li><p>å¼€æ”¾æ ‡å‡†è¯­ä¹‰çº¦å®šä»¥ç¡®ä¿ä¸ä¾›åº”å•†æ— å…³çš„æ•°æ®æ”¶é›†</p></li><li><p>èƒ½å¤Ÿå¹¶è¡Œæ”¯æŒå¤šç§ <a href="https://opentelemetry.io/docs/reference/specification/overview/#context-propagation" target="_blank" rel="noopener noreferrer">ä¸Šä¸‹æ–‡ä¼ æ’­</a> æ ¼å¼ï¼Œä»¥ååŠ©éšç€æ ‡å‡†çš„å‘å±•è¿›è¡Œè¿ç§»ã€‚</p></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ç¼ºç‚¹">ç¼ºç‚¹<a class="hash-link" href="#ç¼ºç‚¹" title="Direct link to heading">â€‹</a></h4><p>æœ‰åˆ«äº Istio ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å·¥å…·ï¼Œä¹Ÿæ˜¯æ›´æœ‰ä¾µå…¥æ€§çš„ï¼Œä½†æ˜¯æ ¹æ®æˆ‘ä»¬çš„ç»éªŒï¼š</p><blockquote><p>è¶Šä¸å…·ä¾µå…¥æ€§çš„å·¥å…·ï¼Œå°±è¶Šæ— æ³•åšå‡ºæ›´æ·±æ›´å¹¿çš„è§‚æµ‹</p></blockquote><p>æˆ‘ä»¬ä¸ºäº†è·å–æ›´æ·±ã€æ›´å¹¿çš„æŒ‡æ ‡ï¼ŒåŠ¿å¿…è¦ä¾µå…¥æ€§åœ°è¿›è¡Œè§‚æµ‹ï¼Œå› æ­¤ï¼Œé‡‡ç”¨Istio envoyæä¾›çš„æŒ‡æ ‡æ˜¯ä¸å¤Ÿçš„ã€‚è€Œæ­¤æ—¶ï¼ŒOpentelemetryæ­£åœ¨é€æ¸å½¢æˆè¡Œä¸šæ ‡å‡†ï¼Œå—åˆ°è®¸å¤šä¾›åº”å•†æ”¯æŒï¼Œæ˜¯æˆ‘ä»¬ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opentelemetry-æ¶æ„">OpenTelemetry æ¶æ„<a class="hash-link" href="#opentelemetry-æ¶æ„" title="Direct link to heading">â€‹</a></h2><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/otel_diagram.png" alt="OpenTelemetry Reference Architecture" class="img_E7b_"></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•´ä½“çš„ç»„ç»‡æ¶æ„å®é™…å¯ä»¥ç†è§£ä¸ºä¸¤éƒ¨åˆ†:</p><ol><li>å°†å¯è§‚æµ‹æ€§æ•°æ®(trace, metric, log)å…¨éƒ¨å¯¼å‡ºï¼ˆ<strong>push</strong>ï¼‰åˆ° <code>otel collector</code>ï¼Œæ— è®ºä½ æ˜¯é€šè¿‡ä»€ä¹ˆå½¢å¼ï¼Œæ¥è‡ªä»€ä¹ˆç»„ä»¶ï¼Œå¦‚:</li></ol><ul><li><p>ä»é¡¹ç›®ä»£ç é€šè¿‡<code>otlp</code>åè®®å¯¼å‡º</p><ul><li>è¯­è¨€ï¼šgo, java, python...</li><li>é›†æˆæ–¹å¼: auto/manual instrumentation, api, sdk</li></ul></li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># example config for otel collector&#x27;s receivers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">receivers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">otlp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">protocols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">grpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4317</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4318</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>é€šè¿‡åŸºç¡€è®¾æ–½(æœ¬è´¨ä¸Šè¿˜æ˜¯é€šè¿‡åº”ç”¨ç¨‹åºå¯¼å‡º)<ul><li>k8s</li><li>aws</li><li>others...</li></ul></li><li>é€šè¿‡å…¶ä»–æœåŠ¡ï¼Œç›´æ¥å°†ä¸€äº›æœåŠ¡æ•°æ®å¯¼å‡ºåˆ°<code>otel collector</code>ï¼Œå¦‚<ul><li>prometheus</li><li>jarger</li><li>others...</li></ul></li></ul><ol start="2"><li><p>å°†ä¸åŒç±»å‹çš„æ•°æ®æŒ‰éœ€æ±‚å¯¼å‡º(<strong>push or pull</strong>)åˆ°å…·ä½“çš„å¯è§‚æµ‹æ€§å·¥å…·ï¼Œå¦‚</p><ul><li>metrics æŒ‡æ ‡å¯ä»¥å¯¼å‡ºè‡³ç›‘æ§æœåŠ¡(å¦‚é€šè¿‡prometheues)</li><li>trace æŒ‡æ ‡å¯ä»¥å¯¼å‡ºè‡³é“¾è·¯è¿½è¸ªæœåŠ¡(å¦‚jaeger)</li><li>log æŒ‡æ ‡å¯ä»¥å¯¼å‡ºè‡³æ—¥å¿—æœåŠ¡(å¦‚loki)</li></ul></li></ol><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># example config for otel collector&#x27;s exporters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">exporters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">jaeger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector.observability</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">14250</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">insecure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">loki</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3100/loki/api/v1/push</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8889</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">resource_to_telemetry_conversion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="é¡¹ç›®ç»„ç»‡ç»“æ„">é¡¹ç›®ç»„ç»‡ç»“æ„<a class="hash-link" href="#é¡¹ç›®ç»„ç»‡ç»“æ„" title="Direct link to heading">â€‹</a></h3><p>Opentelemetryé¡¹ç›®ç»„ç»‡ç»“æ„ç¹å¤šè€Œå¤æ‚ï¼Œå®˜æ–¹å…±æœ‰59ä¸ªrepoï¼Œä½†æˆ‘å¯ä»¥å¤§è‡´æŒ‰ä»¥ä¸‹ç»“æ„è¿›è¡Œæ¢³ç†:</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230209133513547.png" class="img_E7b_"></p><p>é¦–å…ˆï¼ŒOpentelemetryæä¾›äº†å®˜æ–¹çš„<code>opentelemetry-collector</code>ï¼Œä½œä¸ºæ•´ä¸ªé¡¹ç›®çš„æ ¸å¿ƒä»“åº“ï¼Œç”¨ä»¥æ•´å’Œæ‰€æœ‰å¯è§‚æµ‹æ€§æŒ‡æ ‡ï¼Œä¹Ÿæ•´åˆäº†<code>opentelemetry-collector-contrib</code>æä¾›çš„ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œè¿™ä¸¤ä¸ªé¡¹ç›®ç»Ÿä¸€æ„æˆ<code>collector</code>ï¼Œä½†æ˜¯ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿‡å¤šå…³å¿ƒã€‚</p><p>ç„¶åï¼Œé’ˆå¯¹ä¸åŒçš„è¯­è¨€ï¼ŒåŸºæœ¬æ¯ç§è¯­è¨€éƒ½æä¾›äº†ä¸‰ä¸ªä»“åº“ä½œä»¥ä¸‹ç”¨é€”:</p><ul><li><p><strong>æ ¸å¿ƒä»“åº“(é»„è‰²)</strong>: æä¾›è¯¥è¯­è¨€çš„åŸºç¡€SDKï¼Œä¸º<code>instrumentation</code>å’Œ<code>contrib</code>ä»“åº“æä¾›æ¥å…¥çš„ç»Ÿä¸€æ ‡å‡†ï¼Œé€šè¿‡è¿™ä¸ªä»“åº“ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ä¸ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªåº“çš„æƒ…å†µä¸‹æ¥å…¥opentelemetryã€‚</p></li><li><p><strong>instrumentation(ç»¿è‰²)</strong>: ç‰¹å®šçš„è¯­è¨€å®ç°ï¼Œé€šè¿‡å®ƒï¼Œä½ å¯ä»¥åœ¨ä¸ç”šäº†è§£otelçš„æƒ…å†µä¸‹ï¼Œå®ç°<strong>ä¸€ä½“åŒ–ã€å¼€ç®±å³ç”¨åœ°ã€ä¸€é”®åœ°</strong>ä¸ºä½ çš„å·¥ç¨‹å¼•å…¥opentelemetryã€‚</p><p>å¦‚<code>opentelemetry-java-instrumentation</code>å¯ä»¥ç›´æ¥ä»¥</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">java -javaagent:path/to/opentelemetry-javaagent.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -jar myapp.jar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>çš„å½¢å¼æ¥å…¥opentelemetryã€‚</p></li><li><p><strong>contrib(è“è‰²)</strong>: æä¾›ä¸€äº›ä¸ºç¬¬ä¸‰æ–¹åº“ä»¥ç›¸å¯¹ä¾¿æ·çš„å½¢å¼æ¥å…¥Opentelemetryçš„åº“ã€‚</p><p>å¦‚<code>opentelemetry-go-contrib</code>æä¾›äº†é’ˆå¯¹<code>gin</code>, <code>beego</code>æ¡†æ¶ç­‰ç¬¬ä¸‰æ–¹åº“æ¥å…¥opentelemetryçš„ä¾¿æ·æ–¹æ³•ã€‚</p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="golang-å®è·µæŒ‡å—">Golang å®è·µæŒ‡å—<a class="hash-link" href="#golang-å®è·µæŒ‡å—" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tracestable">Traceï¼ˆstableï¼‰<a class="hash-link" href="#tracestable" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="åˆå§‹åŒ–">åˆå§‹åŒ–<a class="hash-link" href="#åˆå§‹åŒ–" title="Direct link to heading">â€‹</a></h4><p>æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªå…¨å±€çš„<code>TraceProvider</code>ï¼Œä¸‹é¢çš„ä¾‹å­æ„é€ çš„provider é‡‡ç”¨çš„ <code>http exporter</code>ï¼Œå³å°†tracesé€šè¿‡httpåè®®å‘é€ç»™æŒ‡å®šçš„<code>opentelemetry-collector</code></p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdktrace </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/sdk/trace&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initTracer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TracerProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otlptracehttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTracerProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithBatcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTracerProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TraceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> tp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>æ³¨æ„: </p><ol><li>å…¨å±€<code>TraceProvider</code>é€šè¿‡<code>otel.SetTracerProvider()</code>è®¾ç½®ï¼Œè·å–æ—¶ï¼Œä¹Ÿå¯ç›´æ¥è°ƒ<code>otel.GetTracerProvider()</code>ã€‚</li></ol><p>æˆ‘å»ºè®®å¤§å®¶ç›´æ¥è®¾ç½®ä¸ºå…¨å±€çš„ï¼Œè€Œä¸æ˜¯ä½œä¸ºå±€éƒ¨å˜é‡ä¼ æ¥ä¼ å»çš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå½“æˆ‘ä»¬å¼•ç”¨äº†ç¬¬ä¸‰æ–¹åº“ï¼Œå®ƒé€šå¸¸ä¹Ÿä¼šé»˜è®¤ä½¿ç”¨å…¨å±€çš„providerï¼Œè¿™æ ·å°±èƒ½ç®€å•çš„ä¿è¯æˆ‘ä»¬ä¸€ä¸ªç¨‹åºåªæœ‰ä¸€ä¸ªproviderï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªä¼šæŠŠæ•°æ®å‘é€åˆ°ä¸€ä¸ªcollectorã€‚</p><ol start="2"><li>åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦æŒ‡å®š <code>opentelemetry-collector endpoint</code>ç­‰é…ç½®ï¼Œæˆ‘ä»¬ç»Ÿä¸€é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ã€‚å¦‚ï¼š</li></ol><ul><li><code>otlptracehttp.WithEndpoint()</code> =&gt; <code>OTEL_EXPORTER_OTLP_ENDPOINT</code></li><li><code>otlptracehttp.WithInsecure</code> =&gt; <code>OTEL_EXPORTER_OTLP_INSECURE</code></li></ul><p>æ”¯æŒçš„ç¯å¢ƒå˜é‡ï¼š</p><ul><li>åŸºç¡€é…ç½®: <a href="https://opentelemetry.io/docs/concepts/sdk-configuration/general-sdk-configuration/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/concepts/sdk-configuration/general-sdk-configuration/</a></li><li>å¯¼å‡ºå™¨: <a href="https://opentelemetry.io/docs/concepts/sdk-configuration/otlp-exporter-configuration/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/concepts/sdk-configuration/otlp-exporter-configuration/</a></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="é‡‡æ ·å™¨">é‡‡æ ·å™¨<a class="hash-link" href="#é‡‡æ ·å™¨" title="Direct link to heading">â€‹</a></h4><p>Go SDK æä¾›äº†å‡ ä¸ªåŸºæœ¬çš„é‡‡æ ·å™¨:</p><ul><li><code>AlwaysSample()</code>: å…¨éƒ¨é‡‡æ ·</li><li><code>NeverSample()</code>: å…¨éƒ¨ä¸¢å¼ƒ</li><li><code>TraceIDRatioBased(fraction float64)</code>: è®¾ç½®é‡‡æ ·ç‡</li><li><code>ParentBased(root Sampler, samplers ...ParentBasedSamplerOption)</code>: åŸºäºparent span è®¾ç½®é‡‡æ ·ç­–ç•¥</li></ul><p>é™¤æ­¤ä¹‹å¤–ï¼Œæ ¹æ®<code>Sampler</code>æ¥å£ï¼š</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Sampler decides whether a trace should be sampled and exported.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Sampler </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DO NOT CHANGE: any modification will not be backwards compatible and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// must never be done outside of a new major release.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ShouldSample returns a SamplingResult based on a decision made from the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// passed parameters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ShouldSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parameters SamplingParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> SamplingResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DO NOT CHANGE: any modification will not be backwards compatible and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// must never be done outside of a new major release.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Description returns information describing the Sampler.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DO NOT CHANGE: any modification will not be backwards compatible and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// must never be done outside of a new major release.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå·±çš„é‡‡æ ·å™¨ï¼Œeg:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdktrace </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/sdk/trace&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// kubegems sampler, ignore samples whitch contains &quot;kubegems.ignore&quot; attrbute.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> kubegemsSampler </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">as kubegemsSampler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ShouldSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SamplingParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SamplingResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SamplingResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tracestate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContextFromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ParentContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldSample </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> att </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Attributes </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> att</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Key </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubegems.ignore&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> att</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AsBool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            shouldSample </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> shouldSample </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Decision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RecordAndSample</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Decision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Drop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">as kubegemsSampler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;KubegemsSampler&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ä½¿ç”¨é‡‡æ ·å™¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹é—®é¢˜ï¼š</p><p>å‡å¦‚æœ‰ä¸¤ä¸ªæœåŠ¡ä¸ºAï¼ŒBï¼Œ è°ƒç”¨å…³ç³»ä¸º A -&gt; B, æˆ‘ä»¬æƒ³è¦ä¸ºå…¶è®¾ç½®é‡‡æ ·ç‡ä¸º50%ï¼Œæ€ä¹ˆè®¾ï¼Ÿ</p><ol><li><p>ç›´æ¥ä¸ºä¸¤ä¸ªæœåŠ¡éƒ½è®¾ç½®</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceIDRatioBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>è¿™æ ·è®¾ç½®åï¼ŒAçš„é‡‡æ ·ç‡è‡ªç„¶æ˜¯50%ï¼Œä½†Bçš„é‡‡æ ·ç‡å¹¶ä¸ä¼šæˆäº†25%ï¼Œæµ‹è¯•å‘ç°å®ƒä»ç„¶æ˜¯50%ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥é˜…<a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/sdk.md#traceidratiobased" target="_blank" rel="noopener noreferrer">è®¾è®¡æ–‡æ¡£</a>ï¼š</p><blockquote><ul><li>The <code>TraceIdRatioBased</code> MUST ignore the parent <code>SampledFlag</code>. To respect the parent <code>SampledFlag</code>, the <code>TraceIdRatioBased</code> should be used as a delegate of the <code>ParentBased</code> sampler specified below.</li></ul></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒ<strong>åªä¼šæ ¹æ®parent spanæ¥å†³å®šæ˜¯å¦è¢«é‡‡æ ·</strong></p></li><li><p>ä½¿ç”¨<code>ParentBased</code>é‡‡æ ·å™¨ï¼ˆæœ€å¥½çš„æ–¹æ³•ï¼‰</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ParentBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceIDRatioBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>ParentBased Sampler</code>æ˜¾å¼åœ°é…ç½®æœ‰<code>parent span</code>æƒ…å†µä¸‹åœ°é‡‡æ ·ç­–ç•¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨å¦‚ä¸‹ç­–ç•¥ï¼š</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">configureSamplersForParentBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">samplers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">ParentBasedSamplerOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> samplerConfig </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> samplerConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remoteParentSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remoteParentNotSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NeverSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        localParentSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        localParentNotSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">NeverSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> so </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> samplers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ä»¥<code>		remoteParentSampled:    AlwaysSample()</code>ä¸ºä¾‹ï¼šå®ƒæ˜¯è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè¿™ä¸ªspanæ¥è‡ªè¿œç¨‹çš„<code>parent span</code>ï¼Œè€Œä¸”<code>parent spane</code>å·²ç»è¢«é‡‡æ ·äº†ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªspanä¹Ÿä¼šè¢«é‡‡æ ·ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒæ•´<code>ParentBasedSamplerOption</code>å‚æ•°ï¼Œeg:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ParentBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceIDRatioBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithRemoteParentSampled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NeverSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>å®ƒè¡¨ç¤ºï¼Œå½“<code>parent span</code>è¢«é‡‡æ ·æ—¶ï¼Œè‡ªå·±ä¸é‡‡æ ·ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯ä¸åˆç†çš„ã€‚</p></li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="åŸ‹ç‚¹">åŸ‹ç‚¹<a class="hash-link" href="#åŸ‹ç‚¹" title="Direct link to heading">â€‹</a></h4><p>æˆ‘ä»¬å¯ä»¥åœ¨æƒ³è¦è®°å½•traceçš„åœ°æ–¹ï¼Œé€šè¿‡<code>tracer.Start()</code>åˆ›å»ºä¸€ä¸ªæ–°spanæ¥åŸ‹ç‚¹ã€‚</p><p>å½“ç„¶ï¼Œåœ¨spanä¸­ï¼Œæˆ‘å¯ä»¥ä¸»è¦å¯ä»¥æ·»åŠ ä»¥ä¸‹å‡ ç±»ä¿¡æ¯ï¼š</p><ul><li><p><code>SetAttributes</code>: è®¾ç½®ä¸€äº›å±æ€§(è®°å½•ä¸ºtag)</p></li><li><p><code>AddEvent</code>: æ·»åŠ äº‹ä»¶(è®°å½•ä¸ºlog)ï¼Œ é€šå¸¸ç”¨æ¥è®°å½•ä¸€äº›é‡è¦æ“ä½œ</p></li><li><p><code>SetStatus</code>: è®¾ç½®spançŠ¶æ€ã€‚</p></li></ul><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// get user name by user id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// start a new span from context.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newCtx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;getUser&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// add start event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;start to get user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithTimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> username </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// get user name from db, if you want to trace it, `WithContext` is necessary.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getDB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newCtx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">`select username from users where id = ?`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Scan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowsAffected </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user %s not found&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// set user info in span&#x27;s attributes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// add end event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;end to get user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithTimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>å±Šæ—¶ï¼Œspanå¤§æ¦‚é•¿è¿™ä¸ªæ ·å­:</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230209175821923.png" class="img_E7b_"></p><p>å¦å¤–ï¼Œå…³äºspançš„çˆ¶å­å…³ç³»ï¼Œæ˜¯é€šè¿‡contextä¸Šä¸‹æ–‡æ¥ä¼ é€’çš„ã€‚</p><p>åœ¨<code>tracer.Start(ctx context.Context, ...)</code>ä¸­ï¼Œå¦‚æœä¼ å…¥çš„ctx ä¸­æ²¡æœ‰spanï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯<code>root span</code>ï¼›å¦‚æœæœ‰ï¼Œé‚£è¿”å›çš„å°±æ˜¯è¯¥spançš„å­spanã€‚</p><p><strong>å› æ­¤ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡contextä¸²è”èµ·æ¸…æ™°çš„é“¾è·¯è°ƒç”¨ï¼Œä½†ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦éå¸¸å…³æ³¨contextçš„ä½¿ç”¨ã€‚</strong></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="è·¨è¿›ç¨‹ä¼ æ’­">è·¨è¿›ç¨‹ä¼ æ’­<a class="hash-link" href="#è·¨è¿›ç¨‹ä¼ æ’­" title="Direct link to heading">â€‹</a></h4><p>Openletemetry æä¾› <code>propagator</code>åœ¨è¿›ç¨‹é—´äº¤æ¢çš„æ¶ˆæ¯ä¸­è¯»å–å’Œå†™å…¥ä¸Šä¸‹æ–‡æ•°æ®çš„å¯¹è±¡ï¼Œè¯¦è§ <a href="https://opentelemetry.io/docs/reference/specification/context/api-propagators/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/reference/specification/context/api-propagators/</a></p><p>Openletemetry å®ç°äº†ä¸¤ç§propagator APIï¼š</p><ul><li><code>TraceContext</code>:  ç”¨ä»¥ä¼ æ’­<code>traceparent</code>å’Œ<code>tracestate</code>ä¿¡æ¯æ¥ä¿è¯ä¸€æ¡traceçš„è°ƒç”¨ä¿¡æ¯ä¸ä¼šå› ä¸ºè·¨è¿›ç¨‹è€Œä¸­æ–­</li><li><code>Baggage</code>: ç”¨ä»¥ä¼ æ’­ç”¨æˆ·è‡ªå®šä¹‰ä¿¡æ¯</li></ul><p><code>propagator</code>å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>Inject(ctx context.Context, carrier TextMapCarrier)</code>: Injects the value into a carrier. For example, into the headers of an HTTP request.</li><li><code>Extract(ctx context.Context, carrier TextMapCarrier) context.Context</code>: Extracts the value from an incoming request. For example, from the headers of an HTTP request.</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tracecontext">TraceContext<a class="hash-link" href="#tracecontext" title="Direct link to heading">â€‹</a></h5><p>ä½¿ç”¨TraceContextåœ¨ä¸‹æ¸¸<code>Inject</code>å’Œä¸Šæ¸¸<code>Extract</code>æ¥æ‰“é€šæœåŠ¡é—´è°ƒç”¨é“¾è·¯, eg:</p><ol><li>è®¾ç½®propagater:</li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TraceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="2"><li>client: </li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DoRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewRequestWithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// inject to http.Request by propagator to do distribute tracing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Inject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="3"><li>server:</li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HandleRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// extract from http.Request by propagator to do distribute tracing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Propagators</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spanName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº<code>TraceContext</code>çš„ä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»æ–‡æ¡£ï¼š<a href="https://www.w3.org/TR/trace-context/%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E9%81%B5%E4%BB%8E%60W3C" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/trace-context/ï¼Œå› ä¸ºå®ƒéµä»`W3C</a> Trace Context format`æ ‡å‡†ã€‚</p><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="baggage">Baggage<a class="hash-link" href="#baggage" title="Direct link to heading">â€‹</a></h5><p>ä½¿ç”¨Baggageåœ¨è¿›ç¨‹é—´ä¼ é€’ä¿¡æ¯ï¼Œåœ¨ä½¿ç”¨å®ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¼„æ¸…æ¥šä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li><p><strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ Baggage?</strong></p><ul><li>åœ¨æ•´æ¡traceä¸­ä¼ æ’­ä¿¡æ¯</li><li>å‡å¦‚æˆ‘ä»¬å¸Œæœ›å°†åº”ç”¨ç¨‹åºä¸­çš„ä¿¡æ¯é™„åŠ åˆ°ä¸€ä¸ª spanï¼Œ å¹¶åœ¨ç¨åæ£€ç´¢è¯¥ä¿¡æ¯ï¼Œç„¶åå°†å…¶ç”¨äºå¦ä¸€ä¸ª spanã€‚ç”±äºspanä¸€ç»åˆ›å»ºå°±ä¸èƒ½ä¿®æ”¹ï¼Œè€ŒBaggage å…è®¸é€šè¿‡æä¾›ä¸€ä¸ªå­˜å‚¨å’Œæ£€ç´¢ä¿¡æ¯çš„åœ°æ–¹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</li></ul></li><li><p><strong>Baggageåº”è¯¥ç”¨æ¥åšä»€ä¹ˆ?</strong></p><p>Baggage åº”è¯¥ç”¨äºæˆ‘ä»¬å¯ä»¥å‘ç¬¬ä¸‰æ–¹å…¬å¼€çš„éæ•æ„Ÿæ•°æ®ï¼Œå› ä¸ºå®ƒä¸å½“å‰ä¸Šä¸‹æ–‡ä¸€èµ·å­˜å‚¨åœ¨ HTTP æ ‡å¤´ä¸­ã€‚</p><p>å»ºè®®ç”¨æ¥ä¼ æ’­åŒ…æ‹¬<strong>å¸æˆ·æ ‡è¯†ã€ç”¨æˆ· IDã€äº§å“ ID å’ŒåŸå§‹ IP </strong>ç­‰å†…å®¹ã€‚å°†å®ƒä»¬å‘ä¸‹ä¼ é€’ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å®ƒä»¬æ·»åŠ åˆ°ä¸‹æ¸¸æœåŠ¡ä¸­çš„ Span ä¸­ï¼Œä»¥ä¾¿åœ¨åœ¨å¯è§‚å¯Ÿæ€§åç«¯ä¸­è¿›è¡Œæœç´¢æ—¶æ›´è½»æ¾åœ°è¿›è¡Œè¿‡æ»¤ã€‚</p></li></ol><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/otel_baggage.png" class="img_E7b_"></p><p>æ¯”å¦‚è¯´ï¼Œåœ¨kubegemsä¸­æœ‰ä¸¤ä¸ªæœåŠ¡ï¼š<code>api</code> å’Œ<code>agent</code>ï¼Œä»¥ä¸€æ¬¡ç”¨æˆ·è¯·æ±‚è·å–k8sèµ„æºä¸ºä¾‹ï¼š</p><ul><li>api: è§£æç”¨æˆ·tokenï¼Œæ ¡éªŒç”¨æˆ·ä¿¡æ¯ï¼Œå†äº¤ç»™<code>agent</code>è·å–å¯¹åº”é›†ç¾¤çš„k8sèµ„æº</li><li>agent: ä¸å†å¤„ç†ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥è°ƒç”¨k8s apiå¹¶è¿”å›</li></ul><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬æƒ³è¦åœ¨agentçš„traceä¿¡æ¯ä¸­ï¼ŒçŸ¥é“è¿™ä¸ªè¯·æ±‚æ—¶å“ªä¸ªç”¨æˆ·å‘èµ·çš„ï¼Œå°±å¯ä»¥å€ŸåŠ©baggageæ¥å®ç°:</p><p>é¦–å…ˆï¼Œåˆå§‹åŒ–<code>TextMapPropagator</code>æ—¶ï¼Œéœ€è¦åŠ ä¸Š<code>Baggage Propagator</code>:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewCompositeTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TraceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Baggage</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ç„¶åï¼Œåœ¨<code>api</code>å‘<code>agent</code>å‘èµ·è¯·æ±‚æ—¶ï¼Œæ³¨å…¥<code>user name</code>çš„<code>baggage</code>:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/baggage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DoRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userBaggage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id=%d,user.name=%s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewRequestWithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ContextWithBaggage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> userBaggage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clientreq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Inject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>æœ€åï¼Œåœ¨<code>agent</code>è§£æbaggageå¹¶è®¾ç½®ä¸ºattributes:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/baggage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HandleRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// extract from http.Request by propagator to do distribute tracing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Propagators</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spanName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqBaggage </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº<code>Baggage</code>çš„ä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»æ–‡æ¡£ï¼š<a href="https://www.w3.org/TR/baggage/%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E9%81%B5%E4%BB%8E%60W3C" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/baggage/ï¼Œå› ä¸ºå®ƒéµä»`W3C</a> Baggage format`æ ‡å‡†ã€‚</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ç†è§£propagator">ç†è§£propagator<a class="hash-link" href="#ç†è§£propagator" title="Direct link to heading">â€‹</a></h4><p>æ— è®ºæ˜¯<code>TraceContext</code>è¿˜æ˜¯<code>Baggage</code>ï¼Œåœ¨æˆ‘ä»¬é€‰ç”¨çš„<code>TextMapPropagator</code>ä¸­ï¼Œéƒ½æ˜¯é‡‡ç”¨<code>TextMapCarrier</code>æ¥å®ç°</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// TextMapCarrier is the storage medium used by a TextMapPropagator.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TextMapCarrier </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>è€Œ<code>TextMapCarrier</code>ï¼Œç›®å‰çš„å”¯ä¸€å®ç°æ˜¯<code>HeaderCarrier</code>ï¼š</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// HeaderCarrier adapts http.Header to satisfy the TextMapCarrier interface.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> HeaderCarrier http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡æˆ‘ä»¬é‡‡ç”¨<code>http</code>è¿˜æ˜¯<code>grpc</code>åè®®ï¼Œåªè¦æˆ‘ä»¬é‡‡ç”¨<code>TextMapPropagator</code>ï¼Œå®ç°ä¿¡æ¯ä¼ æ’­çš„ï¼Œæ˜¯httpåè®® headerã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Debugæ¥è¿½è¸ªè¿™ä¸€è¿‡ç¨‹ï¼Œé¦–å…ˆï¼Œ åœ¨<code>client</code>ç«¯çš„<code>Inject</code>æ–¹æ³•æ‰“ä¸Šæ–­ç‚¹ï¼Œè§‚å¯Ÿå®ƒæ˜¯æ€ä¹ˆæŠŠè¦ä¼ æ’­çš„ä¿¡æ¯æ³¨å…¥è¿›å»çš„ï¼š</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203142016813.png" class="img_E7b_"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ³¨å…¥å‰ context å·²ç»å¸¦æœ‰äº†<code>user.id</code>å’Œ<code>user.name</code>ä¿¡æ¯ï¼Œç„¶åä¸‹ä¸€æ­¥ï¼š</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203142429754.png" class="img_E7b_"></p><p>é€šè¿‡æŠŠctxå¸¦çš„ä¿¡æ¯æ³¨å…¥è¿›<code>headr</code>ï¼Œ æ­¤æ—¶è¯·æ±‚çš„<code>Header</code>ä¸­å·²ç»å¸¦æœ‰äº†<code>Traceparent</code>å’Œ<code>Baggage</code>ä¿¡æ¯ã€‚</p><p>ç„¶åæˆ‘ä»¬åœ¨<code>server</code>ç«¯çš„<code>Extract</code>æ–¹æ³•æ‰“ä¸Šæ–­ç‚¹ï¼Œè§‚å¯Ÿå®ƒæ˜¯æ€ä¹ˆè§£æå‡ºä¼ æ’­çš„ä¿¡æ¯çš„ã€‚</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203142842480.png" class="img_E7b_"></p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203143250673.png" class="img_E7b_"></p><p>å¾ˆæ˜¾ç„¶ï¼Œå®ƒé€šè¿‡ä»<code>client</code>è¯·æ±‚çš„headerä¸­æå–<code>Traceparent</code>æ¥è·å–<code>traceID</code>å’Œ<code>spanID</code>,æ¥å…³è”ä¸Šä¸‹æ¸¸ï¼Œå†æå–<code>Baggage</code>æ¥è·å–æ¥è‡ª<code>client</code>çš„ä¿¡æ¯ã€‚</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="å…¶ä»–å½¢å¼çš„propagator">å…¶ä»–å½¢å¼çš„propagator<a class="hash-link" href="#å…¶ä»–å½¢å¼çš„propagator" title="Direct link to heading">â€‹</a></h4><p>å¯¹åŸºäºhttpåè®®çš„è¿›ç¨‹é—´é€šä¿¡ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>TextMapPropagator</code>å®Œå…¨è¶³å¤Ÿï¼Œä½†å¦‚æœè¯´è¦é’ˆå¯¹æ²¡æœ‰<code>HeaderCarrier</code>å®ç°çš„é€šä¿¡åè®®ï¼Œå®˜æ–¹æœ‰è®¡åˆ’å¼€å‘<code>binary propagator</code>æ¥å®ç°ï¼Œ è¯¦è§ <a href="https://github.com/open-telemetry/opentelemetry-specification/issues/437" target="_blank" rel="noopener noreferrer">https://github.com/open-telemetry/opentelemetry-specification/issues/437</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="metricsalpha">Metricsï¼ˆalphaï¼‰<a class="hash-link" href="#metricsalpha" title="Direct link to heading">â€‹</a></h3><p>ç”±äºopentelemety goæ ‡å‡†åº“çš„metricå®ç°è¿˜æ˜¯alphaï¼Œ<strong>æä¸ç¨³å®š</strong>ï¼Œæ–‡æ¡£å‡ ä¹æ²¡æœ‰ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="åˆå§‹åŒ–-1">åˆå§‹åŒ–<a class="hash-link" href="#åˆå§‹åŒ–-1" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetrichttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/global&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdkmetric </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/sdk/metric&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initMeter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MeterProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otlpmetrichttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewMeterProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewPeriodicReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">15</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetMeterProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> mp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>è¦æ³¨æ„çš„é…ç½®ä¸»è¦æ˜¯<code>NewPeriodicReader()</code>ï¼Œ å®ƒç”¨æ¥è®¾ç½®æˆ‘ä»¬æ”¶é›†å¹¶å‘<code>opentelemetry collector</code>å‘é€æŒ‡æ ‡çš„æ—¶é—´é—´éš”ã€‚</p><p>åœ¨kubegemsä¸Šï¼Œæˆ‘ä»¬çš„<code>opentelemetry collector</code>ä½¿ç”¨çš„æ˜¯<code>pometheus exporter</code>æ¥å¯¼å‡ºç›‘æ§æŒ‡æ ‡ï¼Œå¹¶è®¾ç½®æœ‰<code>30s</code>çš„<code>scrape_interval</code>ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿™é‡Œçš„<code>WithInterval()</code>æœ€å¥½æ˜¯å°äº<code>30s</code>ä»¥ä¿è¯ç›‘æ§æ•°æ®çš„åŠæ—¶æ€§ã€‚</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ä½¿ç”¨">ä½¿ç”¨<a class="hash-link" href="#ä½¿ç”¨" title="Direct link to heading">â€‹</a></h4><p>ä»¥ä¸‹çš„ç¤ºä¾‹æ˜¯kubegemsä¸º<code>gin</code>æ¡†æ¶æ·»åŠ çš„<code>metrics</code>å®ç°ï¼Œå‚ç…§äº†<code>net/http</code>çš„<code>opentelemetry</code>å®ç°ï¼ˆ<a href="https://github.com/open-telemetry/opentelemetry-go-contrib/tree/main/instrumentation/net/http/otelhttp%EF%BC%89%EF%BC%8C%E8%AE%B0%E5%BD%95%E4%BA%86%E4%B8%A4%E4%B8%AA%E6%8C%87%E6%A0%87" target="_blank" rel="noopener noreferrer">https://github.com/open-telemetry/opentelemetry-go-contrib/tree/main/instrumentation/net/http/otelhttpï¼‰ï¼Œè®°å½•äº†ä¸¤ä¸ªæŒ‡æ ‡</a>:</p><ul><li><code>http.server.request_count</code>: è¯·æ±‚æ€»é‡</li><li><code>http.server.duration</code>ï¼šè¯·æ±‚è€—æ—¶ï¼ˆms)</li></ul><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/gin-gonic/gin&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/global&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/instrument/syncfloat64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/instrument/syncint64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    semconv </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/semconv/v1.12.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Server HTTP metrics.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RequestCount          </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http.server.request_count&quot;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// Incoming request count total</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerLatency         </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http.server.duration&quot;</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Incoming end to end duration, microseconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrumentationName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counters       </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncint64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueRecorders </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncfloat64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Histogram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MeterMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">service </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HandlerFunc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counters </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncint64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Counter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueRecorders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncfloat64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Histogram</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    meter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MeterProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Meter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrumentationName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestCounter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> meter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SyncInt64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Counter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RequestCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverLatencyMeasure</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> meter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SyncFloat64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Histogram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ServerLatency</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counters</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">RequestCount</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requestCounter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueRecorders</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ServerLatency</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> serverLatencyMeasure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestStartTime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attributes </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> semconv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HTTPServerMetricAttributesFromHTTPRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Use floating point division here for higher precision (instead of Millisecond method).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ç”±äºBucketåˆ†è¾¨ç‡çš„é—®é¢˜ï¼Œè¿™é‡Œåªèƒ½è®°å½•ä¸ºmillsecondsè€Œä¸æ˜¯seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        elapsedTime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Since</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestStartTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Millisecond</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        counters</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">RequestCount</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        valueRecorders</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ServerLatency</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Record</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elapsedTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="log-not-implemented-yet">Log (not implemented yet)<a class="hash-link" href="#log-not-implemented-yet" title="Direct link to heading">â€‹</a></h3><p>opentelemetry ç›®å‰è¿˜æœªé’ˆå¯¹goæœ‰ç›¸å…³çš„å®ç°ã€‚</p><p>ä½†æ˜¯ï¼Œå‡å¦‚æˆ‘ä»¬çš„åº”ç”¨è¿è¡Œåœ¨<code>kubegems</code>ä¸Šï¼Œå…¶ä¸­çš„æ—¥å¿—æ”¶é›†ã€æŸ¥è¯¢åŠŸèƒ½æœ¬èº«å°±æä¾›äº†ç›¸å…³çš„èƒ½åŠ›ï¼Œæ‰€ä»¥åœ¨å®˜æ–¹çš„æ ‡å‡†æ¨å‡ºä¹‹å‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆé€šè¿‡<code>span.SpanContext().TraceID()</code>è·å–<code>trace-id</code>ï¼Œè‡ªè¡Œåœ¨æ—¥å¿—ä¸­æ‰“å°<code>trace-id</code>ï¼Œæ¥å®ç°<code>trace-log</code>å…³è”ã€‚</p><p>ä¸‹é¢ä»¥gin å’Œbeegoæ¡†æ¶ä¸ºä¾‹ï¼Œç®€å•è®²è§£ä¸€ä¸‹ï¼š</p><p>ginå¯ä»¥æ·»åŠ ä¸ªæ‰“å°æ—¥å¿—çš„<code>middleware</code>ï¼š</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">logMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HandlerFunc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanFromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        statusCode </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Writer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;method&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">URL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;trace-id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;code&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     statusCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;latency&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Since</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;sampled&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsSampled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StatusText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">statusCode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>beegoå¯ä»¥æ·»åŠ ä¸ª<code>filter</code>:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    beego</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InsertFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beego</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BeforeRouter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">bcontext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;getUserFromBaggage&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;method&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">URL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;trace-id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;sampled&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsSampled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;handle request&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reqBaggage </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubegemsæ¥å…¥opentelemetry">Kubegemsæ¥å…¥Opentelemetry<a class="hash-link" href="#kubegemsæ¥å…¥opentelemetry" title="Direct link to heading">â€‹</a></h2><p>å‡å¦‚æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œå·²ç»åœ¨ä»£ç å±‚é¢æ¥å…¥äº†opentelemetryï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºå…¶æ·»åŠ å‡ ä¸ªç¯å¢ƒå˜é‡ï¼ˆä¸ºç»Ÿä¸€kubegemsä¸Šåº”ç”¨ç¨‹åºçš„æ¥å…¥ï¼Œä¸å»ºè®®ä¿®æ”¹ï¼‰:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_K8S_NODE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.nodeName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_K8S_POD_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_SERVICE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.labels</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;app&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_K8S_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_RESOURCE_ATTRIBUTES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service.name=$(OTEL_SERVICE_NAME)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">namespace=$(OTEL_K8S_NAMESPACE)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">node=$(OTEL_K8S_NODE_NAME)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pod=$(OTEL_K8S_POD_NAME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_EXPORTER_OTLP_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//opentelemetry</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector.observability</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4318</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># grpc change to 4317 port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_EXPORTER_OTLP_INSECURE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ç¤ºä¾‹ç¨‹åº">ç¤ºä¾‹ç¨‹åº<a class="hash-link" href="#ç¤ºä¾‹ç¨‹åº" title="Direct link to heading">â€‹</a></h3><p>æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹ç¨‹åº <a href="https://github.com/jojotong/otel-demo" target="_blank" rel="noopener noreferrer">otel-demo</a>æ¥æ¼”ç¤ºã€ä½¿ç”¨opentelemetryåŸºæœ¬åŠŸèƒ½ï¼Œè¯¥demoåŠŸèƒ½å¦‚ä¸‹ï¼š</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230209184206292.png" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ä»£ç æ¼”ç¤º">ä»£ç æ¼”ç¤º<a class="hash-link" href="#ä»£ç æ¼”ç¤º" title="Direct link to heading">â€‹</a></h3><p>è·å–ä»£ç å¹¶éƒ¨ç½²:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/jojotong/otel-demo.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> otel-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> build docker-build docker-push deploy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>é‡ç‚¹ï¼šsampler, propagator, baggageä½¿ç”¨ï¼Œgormæ¥å…¥</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubegemsåŠŸèƒ½æ¼”ç¤º">kubegemsåŠŸèƒ½æ¼”ç¤º<a class="hash-link" href="#kubegemsåŠŸèƒ½æ¼”ç¤º" title="Direct link to heading">â€‹</a></h3><p>é‡ç‚¹ï¼štrace, metric, log è”åŠ¨æŸ¥è¯¢</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="åº”ç”¨æ€§èƒ½">åº”ç”¨æ€§èƒ½<a class="hash-link" href="#åº”ç”¨æ€§èƒ½" title="Direct link to heading">â€‹</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210180904.png" class="img_E7b_">
<img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210180918.png" class="img_E7b_">
<img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181435.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="traceè¯¦æƒ…">traceè¯¦æƒ…<a class="hash-link" href="#traceè¯¦æƒ…" title="Direct link to heading">â€‹</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181009.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="trace---log">trace -&gt; log<a class="hash-link" href="#trace---log" title="Direct link to heading">â€‹</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181106.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="log---monitor">log -&gt; monitor<a class="hash-link" href="#log---monitor" title="Direct link to heading">â€‹</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181130.png" class="img_E7b_"></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/opentelemetry">opentelemetry</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/tracing">tracing</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/promtheus">promtheus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/loki">loki</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/observability">observability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about OpenTelemetry æŠ€æœ¯åˆ†äº« Golang ç¯‡" href="/blog/kubegems-observ"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer" id="footer"><div class="text--center">Copyright Â© 2023 KubeGems.io .</div></footer></div>
<script src="/assets/js/runtime~main.d5b5010d.js"></script>
<script src="/assets/js/main.8b3d5ac5.js"></script>
</body>
</html>