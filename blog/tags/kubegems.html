<!doctype html>
<html lang="zh-CN" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KubeGems RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KubeGems Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XB3JTSLM8D"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XB3JTSLM8D",{anonymize_ip:!0})</script><title data-rh="true">One post tagged with &quot;kubegems&quot; | KubeGems</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kubegems.io/blog/tags/kubegems"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="go-import" content="kubegems.io/kubegems git https://github.com/kubegems/kubegems"><meta data-rh="true" name="go-import" content="kubegems.io/bundle-controller git https://github.com/kubegems/bundle-controller"><meta data-rh="true" name="go-import" content="kubegems.io/configer git https://github.com/kubegems/configer"><meta data-rh="true" name="go-import" content="kubegems.io/ingress-nginx-operator git https://github.com/kubegems/ingress-nginx-operator"><meta data-rh="true" name="go-source" content="kubegems.io/kubegems https://github.com/kubegems/kubegems https://github.com/kubegems/kubegems/tree/master{/dir} https://github.com/kubegems/kubegems/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/bundle-controller https://github.com/kubegems/bundle-controller https://github.com/kubegems/bundle-controller/tree/master{/dir} https://github.com/kubegems/bundle-controller/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/configer https://github.com/kubegems/configer https://github.com/kubegems/configer/tree/master{/dir} https://github.com/kubegems/configer/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" name="go-source" content="kubegems.io/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator https://github.com/kubegems/ingress-nginx-operator/tree/master{/dir} https://github.com/kubegems/ingress-nginx-operator/blob/master{/dir}/{file}#L{line}"><meta data-rh="true" property="og:title" content="One post tagged with &quot;kubegems&quot; | KubeGems"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kubegems.io/blog/tags/kubegems"><link data-rh="true" rel="alternate" href="https://kubegems.io/blog/tags/kubegems" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kubegems.io/blog/tags/kubegems" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.462b57f5.css">
<link rel="preload" href="/assets/js/runtime~main.3344d940.js" as="script">
<link rel="preload" href="/assets/js/main.7e3053f7.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link" href="/docs/concepts/what-is-kubegems">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">博客</a><a class="navbar__item navbar__link" href="/community/support">社群</a><a href="https://wj.qq.com/s2/10923500/96e0/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Contact</a></div><div class="navbar__items navbar__items--right"><div class="navbar__items navbar__item--dock"><div class="toggle navbar__dark toggle--disabled" role="button" tabindex="-1"><div class="toggle__icon toggle__icon--unchecked kubegems-icon icon-light"></div><div class="toggle__icon toggle__icon--checked kubegems-icon icon-dark"></div><input type="checkbox" class="toggle__screenreader-only" aria-label="Switch between dark and light mode"></div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="navbar__github"></a></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">最新博客</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-observ">OpenTelemetry 技术分享 Golang 篇</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems">KubeGems v1.23 正式 GA</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-ai">在 KubeGems 上运行 HuggingFace 模型</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-modelx">ModelX一款开源的机器学习模型管理仓库</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-nacos">KubeGems 启用 Nacos 配置中心</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-kind">使用 Kind 快速部署体验 KubeGems</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-skywalking">基于KubeGems可视化搭建SkyWalking</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-logging">KubeGems 中的日志设计</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/kubegems-auth">KubeGems 用户认证和登录设计</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;kubegems&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-observ">OpenTelemetry 技术分享 Golang 篇</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-02-10T00:00:00.000Z" itemprop="datePublished">2023年2月10日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/jojotong" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/jojotong.png" alt="jojotong"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/jojotong" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">jojotong</span></a></div><small class="avatar__subtitle" itemprop="description">developer@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><iframe width="360" height="200" src="https://www.youtube.com/embed/3i9dRLQxeaA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe><iframe src="//player.bilibili.com/player.html?aid=224241127&amp;bvid=BV1m8411T7MG&amp;cid=1002257669&amp;page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="360" height="200">  </iframe><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opentelemetry">OpenTelemetry<a class="hash-link" href="#opentelemetry" title="Direct link to heading">​</a></h2><p>Opentelemetry 是一个CNCF社区下一个开源的可观测性框架，或者也可以说是一组工具、API 和 SDK 的集合，来检测、生成、收集和导出可观测性数据（<strong>指标、日志和链路</strong>），以帮助我们分析软件的性能和行为。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="优点">优点<a class="hash-link" href="#优点" title="Direct link to heading">​</a></h4><p>过去，检测代码的方式会有所不同，因为每个可观测性后端都有自己的检测库和代理，用于向工具发送数据。</p><p>这意味着没有用于将数据发送到可观察性后端的标准化数据格式，由于缺乏标准化，最终结果是缺乏数据可移植性和用户维护仪器库的负担。</p><p>Opentelemetry因此而生，拥有来自云提供商、 <a href="https://opentelemetry.io/ecosystem/vendors/" target="_blank" rel="noopener noreferrer">供应商</a>和最终用户的广泛行业支持和采用，提供了：</p><ul><li><p><a href="https://opentelemetry.io/docs/instrumentation" target="_blank" rel="noopener noreferrer">每种语言</a>都有一个独立于供应商的instrumentation library ，支持自动和手动。</p></li><li><p>可以以多种方式部署的单个供应商中立的<a href="https://opentelemetry.io/docs/collector" target="_blank" rel="noopener noreferrer">收集器二进制文件。</a></p></li><li><p>生成、发出、收集、处理和导出遥测数据的端到端实现。</p></li><li><p>完全控制您的数据，能够通过配置将数据并行发送到多个目的地。</p></li><li><p>开放标准语义约定以确保与供应商无关的数据收集</p></li><li><p>能够并行支持多种 <a href="https://opentelemetry.io/docs/reference/specification/overview/#context-propagation" target="_blank" rel="noopener noreferrer">上下文传播</a> 格式，以协助随着标准的发展进行迁移。</p></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="缺点">缺点<a class="hash-link" href="#缺点" title="Direct link to heading">​</a></h4><p>有别于 Istio ，它并不是一个开箱即用的工具，也是更有侵入性的，但是根据我们的经验：</p><blockquote><p>越不具侵入性的工具，就越无法做出更深更广的观测</p></blockquote><p>我们为了获取更深、更广的指标，势必要侵入性地进行观测，因此，采用Istio envoy提供的指标是不够的。而此时，Opentelemetry正在逐渐形成行业标准，受到许多供应商支持，是我们一个很好的选择。</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="opentelemetry-架构">OpenTelemetry 架构<a class="hash-link" href="#opentelemetry-架构" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/otel_diagram.png" alt="OpenTelemetry Reference Architecture" class="img_E7b_"></p><p>如上图所示，整体的组织架构实际可以理解为两部分:</p><ol><li>将可观测性数据(trace, metric, log)全部导出（<strong>push</strong>）到 <code>otel collector</code>，无论你是通过什么形式，来自什么组件，如:</li></ol><ul><li><p>从项目代码通过<code>otlp</code>协议导出</p><ul><li>语言：go, java, python...</li><li>集成方式: auto/manual instrumentation, api, sdk</li></ul></li></ul><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># example config for otel collector&#x27;s receivers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">receivers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">otlp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">protocols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">grpc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4317</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4318</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>通过基础设施(本质上还是通过应用程序导出)<ul><li>k8s</li><li>aws</li><li>others...</li></ul></li><li>通过其他服务，直接将一些服务数据导出到<code>otel collector</code>，如<ul><li>prometheus</li><li>jarger</li><li>others...</li></ul></li></ul><ol start="2"><li><p>将不同类型的数据按需求导出(<strong>push or pull</strong>)到具体的可观测性工具，如</p><ul><li>metrics 指标可以导出至监控服务(如通过prometheues)</li><li>trace 指标可以导出至链路追踪服务(如jaeger)</li><li>log 指标可以导出至日志服务(如loki)</li></ul></li></ol><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># example config for otel collector&#x27;s exporters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">exporters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">jaeger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">operator</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">jaeger</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector.observability</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">14250</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">tls</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">insecure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">loki</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">3100/loki/api/v1/push</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">prometheus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0.0.0.0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8889</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token key atrule" style="color:#00a4db">resource_to_telemetry_conversion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="项目组织结构">项目组织结构<a class="hash-link" href="#项目组织结构" title="Direct link to heading">​</a></h3><p>Opentelemetry项目组织结构繁多而复杂，官方共有59个repo，但我可以大致按以下结构进行梳理:</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230209133513547.png" class="img_E7b_"></p><p>首先，Opentelemetry提供了官方的<code>opentelemetry-collector</code>，作为整个项目的核心仓库，用以整和所有可观测性指标，也整合了<code>opentelemetry-collector-contrib</code>提供的第三方服务，这两个项目统一构成<code>collector</code>，但是作为开发者，我们不需要过多关心。</p><p>然后，针对不同的语言，基本每种语言都提供了三个仓库作以下用途:</p><ul><li><p><strong>核心仓库(黄色)</strong>: 提供该语言的基础SDK，为<code>instrumentation</code>和<code>contrib</code>仓库提供接入的统一标准，通过这个仓库，你也可以在不使用以下两个库的情况下接入opentelemetry。</p></li><li><p><strong>instrumentation(绿色)</strong>: 特定的语言实现，通过它，你可以在不甚了解otel的情况下，实现<strong>一体化、开箱即用地、一键地</strong>为你的工程引入opentelemetry。</p><p>如<code>opentelemetry-java-instrumentation</code>可以直接以</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">java -javaagent:path/to/opentelemetry-javaagent.jar \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -jar myapp.jar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>的形式接入opentelemetry。</p></li><li><p><strong>contrib(蓝色)</strong>: 提供一些为第三方库以相对便捷的形式接入Opentelemetry的库。</p><p>如<code>opentelemetry-go-contrib</code>提供了针对<code>gin</code>, <code>beego</code>框架等第三方库接入opentelemetry的便捷方法。</p></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="golang-实践指南">Golang 实践指南<a class="hash-link" href="#golang-实践指南" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tracestable">Trace（stable）<a class="hash-link" href="#tracestable" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="初始化">初始化<a class="hash-link" href="#初始化" title="Direct link to heading">​</a></h4><p>我们需要构造一个全局的<code>TraceProvider</code>，下面的例子构造的provider 采用的 <code>http exporter</code>，即将traces通过http协议发送给指定的<code>opentelemetry-collector</code></p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdktrace </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/sdk/trace&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initTracer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TracerProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otlptracehttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTracerProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithBatcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTracerProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TraceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> tp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>注意: </p><ol><li>全局<code>TraceProvider</code>通过<code>otel.SetTracerProvider()</code>设置，获取时，也可直接调<code>otel.GetTracerProvider()</code>。</li></ol><p>我建议大家直接设置为全局的，而不是作为局部变量传来传去的一个好处是，当我们引用了第三方库，它通常也会默认使用全局的provider，这样就能简单的保证我们一个程序只有一个provider，也就是说，只会把数据发送到一个collector。</p><ol start="2"><li>初始化的过程中，不需要指定 <code>opentelemetry-collector endpoint</code>等配置，我们统一通过环境变量注入。如：</li></ol><ul><li><code>otlptracehttp.WithEndpoint()</code> =&gt; <code>OTEL_EXPORTER_OTLP_ENDPOINT</code></li><li><code>otlptracehttp.WithInsecure</code> =&gt; <code>OTEL_EXPORTER_OTLP_INSECURE</code></li></ul><p>支持的环境变量：</p><ul><li>基础配置: <a href="https://opentelemetry.io/docs/concepts/sdk-configuration/general-sdk-configuration/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/concepts/sdk-configuration/general-sdk-configuration/</a></li><li>导出器: <a href="https://opentelemetry.io/docs/concepts/sdk-configuration/otlp-exporter-configuration/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/concepts/sdk-configuration/otlp-exporter-configuration/</a></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="采样器">采样器<a class="hash-link" href="#采样器" title="Direct link to heading">​</a></h4><p>Go SDK 提供了几个基本的采样器:</p><ul><li><code>AlwaysSample()</code>: 全部采样</li><li><code>NeverSample()</code>: 全部丢弃</li><li><code>TraceIDRatioBased(fraction float64)</code>: 设置采样率</li><li><code>ParentBased(root Sampler, samplers ...ParentBasedSamplerOption)</code>: 基于parent span 设置采样策略</li></ul><p>除此之外，根据<code>Sampler</code>接口：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Sampler decides whether a trace should be sampled and exported.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Sampler </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DO NOT CHANGE: any modification will not be backwards compatible and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// must never be done outside of a new major release.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ShouldSample returns a SamplingResult based on a decision made from the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// passed parameters.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ShouldSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parameters SamplingParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> SamplingResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DO NOT CHANGE: any modification will not be backwards compatible and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// must never be done outside of a new major release.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Description returns information describing the Sampler.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// DO NOT CHANGE: any modification will not be backwards compatible and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// must never be done outside of a new major release.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>我们可以编写自己的采样器，eg:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdktrace </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/sdk/trace&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// kubegems sampler, ignore samples whitch contains &quot;kubegems.ignore&quot; attrbute.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> kubegemsSampler </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">as kubegemsSampler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ShouldSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SamplingParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SamplingResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SamplingResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Tracestate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContextFromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ParentContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shouldSample </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> att </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Attributes </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> att</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Key </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;kubegems.ignore&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> att</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AsBool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            shouldSample </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> shouldSample </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Decision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RecordAndSample</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Decision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Drop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">as kubegemsSampler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;KubegemsSampler&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>使用采样器时，我们需要注意以下问题：</p><p>假如有两个服务为A，B， 调用关系为 A -&gt; B, 我们想要为其设置采样率为50%，怎么设？</p><ol><li><p>直接为两个服务都设置</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceIDRatioBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>这样设置后，A的采样率自然是50%，但B的采样率并不会成了25%，测试发现它仍然是50%。我们可以查阅<a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/sdk.md#traceidratiobased" target="_blank" rel="noopener noreferrer">设计文档</a>：</p><blockquote><ul><li>The <code>TraceIdRatioBased</code> MUST ignore the parent <code>SampledFlag</code>. To respect the parent <code>SampledFlag</code>, the <code>TraceIdRatioBased</code> should be used as a delegate of the <code>ParentBased</code> sampler specified below.</li></ul></blockquote><p>也就是说，它<strong>只会根据parent span来决定是否被采样</strong></p></li><li><p>使用<code>ParentBased</code>采样器（最好的方法）</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ParentBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceIDRatioBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>ParentBased Sampler</code>显式地配置有<code>parent span</code>情况下地采样策略，默认情况下使用如下策略：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">configureSamplersForParentBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">samplers </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">ParentBasedSamplerOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> samplerConfig </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> samplerConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remoteParentSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        remoteParentNotSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NeverSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        localParentSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token function" style="color:#d73a49">AlwaysSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        localParentNotSampled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">NeverSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> so </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> samplers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> so</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>以<code>		remoteParentSampled:    AlwaysSample()</code>为例：它是说，默认情况下，如果这个span来自远程的<code>parent span</code>，而且<code>parent spane</code>已经被采样了，那么，这个span也会被采样。</p><p>我们也可以调整<code>ParentBasedSamplerOption</code>参数，eg:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithSampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ParentBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceIDRatioBased</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithRemoteParentSampled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdktrace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NeverSample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>它表示，当<code>parent span</code>被采样时，自己不采样，当然，这是不合理的。</p></li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="埋点">埋点<a class="hash-link" href="#埋点" title="Direct link to heading">​</a></h4><p>我们可以在想要记录trace的地方，通过<code>tracer.Start()</code>创建一个新span来埋点。</p><p>当然，在span中，我可以主要可以添加以下几类信息：</p><ul><li><p><code>SetAttributes</code>: 设置一些属性(记录为tag)</p></li><li><p><code>AddEvent</code>: 添加事件(记录为log)， 通常用来记录一些重要操作</p></li><li><p><code>SetStatus</code>: 设置span状态。</p></li></ul><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// get user name by user id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// start a new span from context.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    newCtx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;getUser&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// add start event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;start to get user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithTimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> username </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// get user name from db, if you want to trace it, `WithContext` is necessary.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getDB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newCtx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">`select username from users where id = ?`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Scan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowsAffected </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user %s not found&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// set user info in span&#x27;s attributes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// add end event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;end to get user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithTimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>届时，span大概长这个样子:</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230209175821923.png" class="img_E7b_"></p><p>另外，关于span的父子关系，是通过context上下文来传递的。</p><p>在<code>tracer.Start(ctx context.Context, ...)</code>中，如果传入的ctx 中没有span，那么返回的就是<code>root span</code>；如果有，那返回的就是该span的子span。</p><p><strong>因此，我们能通过context串联起清晰的链路调用，但也因此，我们需要非常关注context的使用。</strong></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="跨进程传播">跨进程传播<a class="hash-link" href="#跨进程传播" title="Direct link to heading">​</a></h4><p>Openletemetry 提供 <code>propagator</code>在进程间交换的消息中读取和写入上下文数据的对象，详见 <a href="https://opentelemetry.io/docs/reference/specification/context/api-propagators/" target="_blank" rel="noopener noreferrer">https://opentelemetry.io/docs/reference/specification/context/api-propagators/</a></p><p>Openletemetry 实现了两种propagator API：</p><ul><li><code>TraceContext</code>:  用以传播<code>traceparent</code>和<code>tracestate</code>信息来保证一条trace的调用信息不会因为跨进程而中断</li><li><code>Baggage</code>: 用以传播用户自定义信息</li></ul><p><code>propagator</code>实现两个方法：</p><ul><li><code>Inject(ctx context.Context, carrier TextMapCarrier)</code>: Injects the value into a carrier. For example, into the headers of an HTTP request.</li><li><code>Extract(ctx context.Context, carrier TextMapCarrier) context.Context</code>: Extracts the value from an incoming request. For example, from the headers of an HTTP request.</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tracecontext">TraceContext<a class="hash-link" href="#tracecontext" title="Direct link to heading">​</a></h5><p>使用TraceContext在下游<code>Inject</code>和上游<code>Extract</code>来打通服务间调用链路, eg:</p><ol><li>设置propagater:</li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TraceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="2"><li>client: </li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DoRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewRequestWithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// inject to http.Request by propagator to do distribute tracing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Inject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ol start="3"><li>server:</li></ol><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HandleRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// extract from http.Request by propagator to do distribute tracing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Propagators</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spanName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>如果你想了解更多关于<code>TraceContext</code>的信息，可以阅读文档：<a href="https://www.w3.org/TR/trace-context/%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E9%81%B5%E4%BB%8E%60W3C" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/trace-context/，因为它遵从`W3C</a> Trace Context format`标准。</p><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="baggage">Baggage<a class="hash-link" href="#baggage" title="Direct link to heading">​</a></h5><p>使用Baggage在进程间传递信息，在使用它之前，我们需要弄清楚两个问题：</p><ol><li><p><strong>为什么我们需要 Baggage?</strong></p><ul><li>在整条trace中传播信息</li><li>假如我们希望将应用程序中的信息附加到一个 span， 并在稍后检索该信息，然后将其用于另一个 span。由于span一经创建就不能修改，而Baggage 允许通过提供一个存储和检索信息的地方来解决这个问题。</li></ul></li><li><p><strong>Baggage应该用来做什么?</strong></p><p>Baggage 应该用于我们可以向第三方公开的非敏感数据，因为它与当前上下文一起存储在 HTTP 标头中。</p><p>建议用来传播包括<strong>帐户标识、用户 ID、产品 ID 和原始 IP </strong>等内容。将它们向下传递之后，我们就可以将它们添加到下游服务中的 Span 中，以便在在可观察性后端中进行搜索时更轻松地进行过滤。</p></li></ol><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/otel_baggage.png" class="img_E7b_"></p><p>比如说，在kubegems中有两个服务：<code>api</code> 和<code>agent</code>，以一次用户请求获取k8s资源为例：</p><ul><li>api: 解析用户token，校验用户信息，再交给<code>agent</code>获取对应集群的k8s资源</li><li>agent: 不再处理用户信息，直接调用k8s api并返回</li></ul><p>在这种情况下，假如我们想要在agent的trace信息中，知道这个请求时哪个用户发起的，就可以借助baggage来实现:</p><p>首先，初始化<code>TextMapPropagator</code>时，需要加上<code>Baggage Propagator</code>:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewCompositeTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TraceContext</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Baggage</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>然后，在<code>api</code>向<code>agent</code>发起请求时，注入<code>user name</code>的<code>baggage</code>:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;net/http&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/baggage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DoRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userBaggage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id=%d,user.name=%s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Handle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewRequestWithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ContextWithBaggage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> userBaggage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clientreq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Inject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>最后，在<code>agent</code>解析baggage并设置为attributes:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/baggage&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HandleRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// extract from http.Request by propagator to do distribute tracing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Propagators</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spanName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reqBaggage </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>如果你想了解更多关于<code>Baggage</code>的信息，可以阅读文档：<a href="https://www.w3.org/TR/baggage/%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E9%81%B5%E4%BB%8E%60W3C" target="_blank" rel="noopener noreferrer">https://www.w3.org/TR/baggage/，因为它遵从`W3C</a> Baggage format`标准。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="理解propagator">理解propagator<a class="hash-link" href="#理解propagator" title="Direct link to heading">​</a></h4><p>无论是<code>TraceContext</code>还是<code>Baggage</code>，在我们选用的<code>TextMapPropagator</code>中，都是采用<code>TextMapCarrier</code>来实现</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// TextMapCarrier is the storage medium used by a TextMapPropagator.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> TextMapCarrier </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>而<code>TextMapCarrier</code>，目前的唯一实现是<code>HeaderCarrier</code>：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// HeaderCarrier adapts http.Header to satisfy the TextMapCarrier interface.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> HeaderCarrier http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>也就是说，不管我们采用<code>http</code>还是<code>grpc</code>协议，只要我们采用<code>TextMapPropagator</code>，实现信息传播的，是http协议 header。</p><p>我们可以通过Debug来追踪这一过程，首先， 在<code>client</code>端的<code>Inject</code>方法打上断点，观察它是怎么把要传播的信息注入进去的：</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203142016813.png" class="img_E7b_"></p><p>可以看到，注入前 context 已经带有了<code>user.id</code>和<code>user.name</code>信息，然后下一步：</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203142429754.png" class="img_E7b_"></p><p>通过把ctx带的信息注入进<code>headr</code>， 此时请求的<code>Header</code>中已经带有了<code>Traceparent</code>和<code>Baggage</code>信息。</p><p>然后我们在<code>server</code>端的<code>Extract</code>方法打上断点，观察它是怎么解析出传播的信息的。</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203142842480.png" class="img_E7b_"></p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230203143250673.png" class="img_E7b_"></p><p>很显然，它通过从<code>client</code>请求的header中提取<code>Traceparent</code>来获取<code>traceID</code>和<code>spanID</code>,来关联上下游，再提取<code>Baggage</code>来获取来自<code>client</code>的信息。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="其他形式的propagator">其他形式的propagator<a class="hash-link" href="#其他形式的propagator" title="Direct link to heading">​</a></h4><p>对基于http协议的进程间通信，我们使用<code>TextMapPropagator</code>完全足够，但如果说要针对没有<code>HeaderCarrier</code>实现的通信协议，官方有计划开发<code>binary propagator</code>来实现， 详见 <a href="https://github.com/open-telemetry/opentelemetry-specification/issues/437" target="_blank" rel="noopener noreferrer">https://github.com/open-telemetry/opentelemetry-specification/issues/437</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="metricsalpha">Metrics（alpha）<a class="hash-link" href="#metricsalpha" title="Direct link to heading">​</a></h3><p>由于opentelemety go标准库的metric实现还是alpha，<strong>极不稳定</strong>，文档几乎没有，请谨慎使用。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="初始化-1">初始化<a class="hash-link" href="#初始化-1" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetrichttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/global&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sdkmetric </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/sdk/metric&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initMeter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MeterProvider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otlpmetrichttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewMeterProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewPeriodicReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sdkmetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">15</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetMeterProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> mp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>要注意的配置主要是<code>NewPeriodicReader()</code>， 它用来设置我们收集并向<code>opentelemetry collector</code>发送指标的时间间隔。</p><p>在kubegems上，我们的<code>opentelemetry collector</code>使用的是<code>pometheus exporter</code>来导出监控指标，并设置有<code>30s</code>的<code>scrape_interval</code>，因此，我们这里的<code>WithInterval()</code>最好是小于<code>30s</code>以保证监控数据的及时性。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="使用">使用<a class="hash-link" href="#使用" title="Direct link to heading">​</a></h4><p>以下的示例是kubegems为<code>gin</code>框架添加的<code>metrics</code>实现，参照了<code>net/http</code>的<code>opentelemetry</code>实现（<a href="https://github.com/open-telemetry/opentelemetry-go-contrib/tree/main/instrumentation/net/http/otelhttp%EF%BC%89%EF%BC%8C%E8%AE%B0%E5%BD%95%E4%BA%86%E4%B8%A4%E4%B8%AA%E6%8C%87%E6%A0%87" target="_blank" rel="noopener noreferrer">https://github.com/open-telemetry/opentelemetry-go-contrib/tree/main/instrumentation/net/http/otelhttp），记录了两个指标</a>:</p><ul><li><code>http.server.request_count</code>: 请求总量</li><li><code>http.server.duration</code>：请求耗时（ms)</li></ul><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;github.com/gin-gonic/gin&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/global&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/instrument/syncfloat64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/metric/instrument/syncint64&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/propagation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    semconv </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/otel/semconv/v1.12.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Server HTTP metrics.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RequestCount          </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http.server.request_count&quot;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// Incoming request count total</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerLatency         </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http.server.duration&quot;</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Incoming end to end duration, microseconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrumentationName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counters       </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncint64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueRecorders </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncfloat64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Histogram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MeterMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">service </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HandlerFunc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counters </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncint64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Counter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueRecorders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">syncfloat64</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Histogram</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    meter </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MeterProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Meter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrumentationName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestCounter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> meter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SyncInt64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Counter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">RequestCount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    serverLatencyMeasure</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> meter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SyncFloat64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Histogram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ServerLatency</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counters</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">RequestCount</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requestCounter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valueRecorders</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ServerLatency</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> serverLatencyMeasure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestStartTime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attributes </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> semconv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HTTPServerMetricAttributesFromHTTPRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Use floating point division here for higher precision (instead of Millisecond method).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 由于Bucket分辨率的问题，这里只能记录为millseconds而不是seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        elapsedTime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Since</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestStartTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Millisecond</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        counters</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">RequestCount</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        valueRecorders</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ServerLatency</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Record</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elapsedTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="log-not-implemented-yet">Log (not implemented yet)<a class="hash-link" href="#log-not-implemented-yet" title="Direct link to heading">​</a></h3><p>opentelemetry 目前还未针对go有相关的实现。</p><p>但是，假如我们的应用运行在<code>kubegems</code>上，其中的日志收集、查询功能本身就提供了相关的能力，所以在官方的标准推出之前，我们也可以先通过<code>span.SpanContext().TraceID()</code>获取<code>trace-id</code>，自行在日志中打印<code>trace-id</code>，来实现<code>trace-log</code>关联。</p><p>下面以gin 和beego框架为例，简单讲解一下：</p><p>gin可以添加个打印日志的<code>middleware</code>：</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">logMiddleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HandlerFunc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">gin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> trace</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanFromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        statusCode </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Writer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;method&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">URL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;trace-id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;code&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     statusCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;latency&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Since</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;sampled&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsSampled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StatusText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">statusCode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>beego可以添加个<code>filter</code>:</p><div class="codeBlockContainer_I0IT language-go theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-go codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    beego</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InsertFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beego</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BeforeRouter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">bcontext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> otel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetTextMapPropagator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Context</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> propagation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HeaderCarrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> span </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> tracer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;getUserFromBaggage&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">End</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithFields</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logrus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Fields</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;method&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">URL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;trace-id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TraceID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;sampled&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SpanContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsSampled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;handle request&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reqBaggage </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> baggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        span</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            attribute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reqBaggage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Member</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user.name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubegems接入opentelemetry">Kubegems接入Opentelemetry<a class="hash-link" href="#kubegems接入opentelemetry" title="Direct link to heading">​</a></h2><p>假如我们的应用程序，已经在代码层面接入了opentelemetry，我们只需要为其添加几个环境变量（为统一kubegems上应用程序的接入，不建议修改）:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_K8S_NODE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.nodeName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_K8S_POD_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_SERVICE_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.labels</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;app&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_K8S_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_RESOURCE_ATTRIBUTES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> service.name=$(OTEL_SERVICE_NAME)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">namespace=$(OTEL_K8S_NAMESPACE)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">node=$(OTEL_K8S_NODE_NAME)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pod=$(OTEL_K8S_POD_NAME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_EXPORTER_OTLP_ENDPOINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//opentelemetry</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">collector.observability</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4318</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># grpc change to 4317 port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> OTEL_EXPORTER_OTLP_INSECURE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="示例程序">示例程序<a class="hash-link" href="#示例程序" title="Direct link to heading">​</a></h3><p>我们通过示例程序 <a href="https://github.com/jojotong/otel-demo" target="_blank" rel="noopener noreferrer">otel-demo</a>来演示、使用opentelemetry基本功能，该demo功能如下：</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/image-20230209184206292.png" class="img_E7b_"></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="代码演示">代码演示<a class="hash-link" href="#代码演示" title="Direct link to heading">​</a></h3><p>获取代码并部署:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/jojotong/otel-demo.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> otel-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> build docker-build docker-push deploy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>重点：sampler, propagator, baggage使用，gorm接入</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubegems功能演示">kubegems功能演示<a class="hash-link" href="#kubegems功能演示" title="Direct link to heading">​</a></h3><p>重点：trace, metric, log 联动查询</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="应用性能">应用性能<a class="hash-link" href="#应用性能" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210180904.png" class="img_E7b_">
<img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210180918.png" class="img_E7b_">
<img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181435.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="trace详情">trace详情<a class="hash-link" href="#trace详情" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181009.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="trace---log">trace -&gt; log<a class="hash-link" href="#trace---log" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181106.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="log---monitor">log -&gt; monitor<a class="hash-link" href="#log---monitor" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/20230210181130.png" class="img_E7b_"></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/opentelemetry">opentelemetry</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/tracing">tracing</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/promtheus">promtheus</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/loki">loki</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/observability">observability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about OpenTelemetry 技术分享 Golang 篇" href="/blog/kubegems-observ"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-ai">在 KubeGems 上运行 HuggingFace 模型</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2023-01-20T00:00:00.000Z" itemprop="datePublished">2023年1月20日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/pepesi" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/pepesi.png" alt="yud"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pepesi" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">yud</span></a></div><small class="avatar__subtitle" itemprop="description">developer@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>随着众多model zoo的出现，对于我们这样不懂得高深的数学基础知识的小白来说，能体验众多业界大牛开发的模型也不再是一个遥不可及的事情了。现在唯一的成本可能就是要熟悉各种开发框架，如 Transformers，OpenMMLab 等。KubeGems 在1.23版本中加入了模型商店的功能，其主要目的就是为了让开发者快速部署和体验这些优秀的模型，当前KubeGems主要对接Huggingface 和 OpenMMLab 两个model zoo，后续我们还将不断集成其他优秀的model zoo。本文将以HuggingFace为例，简单介绍如何在KubeGems上快速体验一个视觉问答的模型任务，以及一些实现背后的技术细节。</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubegems模型商店">KubeGems模型商店<a class="hash-link" href="#kubegems模型商店" title="Direct link to heading">​</a></h2><p>KubeGems 模型商店目前的设计目的是基于它来托管和集成第三方模型和自有模型；对于自有模型，我们通过<a href="https://github.com/kubegems/modelx" target="_blank" rel="noopener noreferrer" title="modelx">modelx</a>项目来存储其模型数据。同时在某些私有化场景下，我们也可以基于modex来导入私有化部署所需的模型。对于第三方的模型，通常我们仅仅存储其模型元数据（模型名字，模型数据的url地址等)，但不会储存其模型数据本身，KubeGems 模型商店提供了一个“模型同步器&quot;，它实际上是一个简单的 spider，会将HuggingFace的模型列表和其他任务相关信息记录下来，以便KubeGems用户可以在KubeGems中筛选和检索。当然modelx 也是可以存储第三方的模型的，例如我们要将一个优秀的开源模型部署到私有化环境下的时候，也可以将第三方的模型数据导入到modex中。</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/modelx-ef360228d64d7460c5ae7da92a77bb25.jpg" class="img_E7b_"></p><blockquote><p>modelx 是一个基于 OCI 的简单、高性能、可扩展的 ML/DL 模型存储库。</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="seldon-项目">Seldon 项目<a class="hash-link" href="#seldon-项目" title="Direct link to heading">​</a></h2><p>出于快速部署任意模型的目的，我们需要一套方案来快速集成主流的模型开发框架，同时还能为模型部署提供一些额外的监控数据，经过一些筛选，我们采用的是<a href="https://github.com/SeldonIO/seldon-core" target="_blank" rel="noopener noreferrer" title="seldon">SeldonIO</a>这个项目。seldon-core 是一个用于打包、部署、监控和管理数千个生产机器学习模型的 MLOps 框架，它主要支持两个类型的推理组件 <a href="https://github.com/triton-inference-server/server" target="_blank" rel="noopener noreferrer" title="triton">Triton</a>和 <a href="https://github.com/SeldonIO/MLServer" target="_blank" rel="noopener noreferrer" title="mlserver">MLServer</a>。Triton 推理服务器是NVIDIA AI平台的一部分，是一款开源推理服务软件，可帮助标准化模型部署和执行，并在生产中提供快速且可扩展的AI服务。MLServer 是机器学习模型的推理服务器，包括对多个框架、多模型服务等的支持，同时也很容易基于它来开发一个自定义的推理运行时，它由Seldon开发，当前KubeGems集成HuggingFace 就是基于 MLServer 项目。有关更多SeldonIO 和 MLServer的信息可以在其官网找到，所以这儿就不再赘述了。</p><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/e2e-model-serving.svg" class="img_E7b_"></p><blockquote><p>一点使用心得，seldon-core 的 operator 处理 SeldonDeployment 的时候，是通过硬编码编排内容的方式来提交Resource到 Kubernetes API Server，灵活度还是有点欠缺，例如我们想调整Deployment的updateStrategy的时候，就无从下手。单从部署的角度来看，KubeVela 使用模版的办法才是一个更优雅的办法。瑕不掩瑜，这点小问题不影响它是个不错的项目。</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mlserver-项目">MLServer 项目<a class="hash-link" href="#mlserver-项目" title="Direct link to heading">​</a></h2><p>MLServer 旨在提供一种简单的方法来通过 REST 和 gRPC 接口开始为机器学习模型提供服务，它实现了 KFServing 的 <a href="https://kserve.github.io/website/modelserving/inference_api/" target="_blank" rel="noopener noreferrer">Predict Protocol V2</a> 协议规范。</p><blockquote><p>本文中，Predict Protocol V2 我们简称其为“V2协议&quot;。 V2 推理协议的目的是提供一种标准化协议来与不同的推理服务器（例如 MLServer、Triton 等）和编排框架（例如 Seldon Core、KServe 等）进行通信。 V2 推理协议的规范定义了 REST 和 gRPC 接口和请求负载数据的格式。</p></blockquote><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/content-type.svg" class="img_E7b_"></p><p>MLServer 核心由两个部分组成，他们分别是<strong>编解码器(codecs)</strong>和<strong>运行时(runtime)</strong></p><p>编解码器</p><p>MLServer 的编解码器负责将用户的输入转换成兼容 <a href="https://kserve.github.io/website/modelserving/inference_api/" target="_blank" rel="noopener noreferrer">Predict Protocol V2</a> 协议的数据格式，同时也将模型的推理输出按照V2协议进行编码返回。MLServer 实现了对V2协议的数据编码的支持，同时允许用户开发和注册自定义的编解码器。</p><p>由于V2协议是一个面向推理服务的协议，并没有对媒体类型进行支持，所以对于要求直接将图片或者音频作为输入的任务来说，就需要开发自定义的编解码器。</p><p>其中编解码器又分成两个类型，分别是<strong>RequestCodec</strong> 和 <strong>InputCodec</strong></p><p>RequestCodec 会作为整个请求的默认编码器，当payload的input字段中没有提供Content-Type的时候，就会使用默认编码器编解码，InputCodec 则是真正执行编解码的编解码，每个RequestCodec应该有一个默认的InputCodec，当payload的input字段中提供了Content-Type的时候，则会使用指定Content-Type的编解码器对数据进行编解码。</p><p>例子：</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;parameters&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;content_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pd&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;inputs&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;First Name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;datatype&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BYTES&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;parameters&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;content_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;str&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;shape&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;Joanne&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Michael&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Age&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;datatype&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;INT32&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;shape&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;data&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>以MLServer在解码这个请求输入的时候，默认使用PandasCodec对数据decode，返回一个pandas.DataFrame，但是 inputs<!-- -->[1]<!-- --> 指定了Content-Type 为<strong>str</strong>，那么这个字段将被编码成字符串。以上数据会decode为一个python字典</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;First Name&quot;: [&quot;Joanne&quot;, &quot;Michale&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Age&quot;: pandas.DataFrame([34, 22]),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="运行时">运行时<a class="hash-link" href="#运行时" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/architecture.svg" class="img_E7b_"></p><p>运行时是MLServer实现推理的核心模块，当前MLServer内置了八个推理运行时，每个推理运行时可以注册自己专有的Content-type对应的InputCodec和RequestCodec。目前已经支持的推理框架如下：</p><table><thead><tr><th align="left">Framework</th><th align="left">Package Name</th><th align="left">Implementation Class</th><th align="left">Example</th><th align="left">Documentation</th></tr></thead><tbody><tr><td align="left">Scikit-Learn</td><td align="left"><code>mlserver-sklearn</code></td><td align="left"><code>mlserver_sklearn.SKLearnModel</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/sklearn/README.html" target="_blank" rel="noopener noreferrer">Scikit-Learn example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/sklearn.html" target="_blank" rel="noopener noreferrer">MLServer SKLearn</a></td></tr><tr><td align="left">XGBoost</td><td align="left"><code>mlserver-xgboost</code></td><td align="left"><code>mlserver_xgboost.XGBoostModel</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/xgboost/README.html" target="_blank" rel="noopener noreferrer">XGBoost example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/xgboost.html" target="_blank" rel="noopener noreferrer">MLServer XGBoost</a></td></tr><tr><td align="left">HuggingFace</td><td align="left"><code>mlserver-huggingface</code></td><td align="left"><code>mlserver_huggingface.HuggingFaceRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/huggingface/README.html" target="_blank" rel="noopener noreferrer">HuggingFace example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/huggingface.html" target="_blank" rel="noopener noreferrer">MLServer HuggingFace</a></td></tr><tr><td align="left">Spark MLlib</td><td align="left"><code>mlserver-mllib</code></td><td align="left"><code>mlserver_mllib.MLlibModel</code></td><td align="left">Coming Soon</td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/mllib.html" target="_blank" rel="noopener noreferrer">MLServer MLlib</a></td></tr><tr><td align="left">LightGBM</td><td align="left"><code>mlserver-lightgbm</code></td><td align="left"><code>mlserver_lightgbm.LightGBMModel</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/lightgbm/README.html" target="_blank" rel="noopener noreferrer">LightGBM example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/lightgbm.html" target="_blank" rel="noopener noreferrer">MLServer LightGBM</a></td></tr><tr><td align="left">Tempo</td><td align="left"><code>tempo</code></td><td align="left"><code>tempo.mlserver.InferenceRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/tempo/README.html" target="_blank" rel="noopener noreferrer">Tempo example</a></td><td align="left"><a href="https://github.com/SeldonIO/tempo" target="_blank" rel="noopener noreferrer"><code>github.com/SeldonIO/tempo</code></a></td></tr><tr><td align="left">MLflow</td><td align="left"><code>mlserver-mlflow</code></td><td align="left"><code>mlserver_mlflow.MLflowRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/mlflow/README.html" target="_blank" rel="noopener noreferrer">MLflow example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/mlflow.html" target="_blank" rel="noopener noreferrer">MLServer MLflow</a></td></tr><tr><td align="left">Alibi-Detect</td><td align="left"><code>mlserver-alibi-detect</code></td><td align="left"><code>mlserver_alibi_detect.AlibiDetectRuntime</code></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/examples/alibi-detect/README.html" target="_blank" rel="noopener noreferrer">Alibi-detect example</a></td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/alibi-detect.html" target="_blank" rel="noopener noreferrer">MLServer Alibi-Detect</a></td></tr><tr><td align="left">Alibi-Explain</td><td align="left"><code>mlserver-alibi-explain</code></td><td align="left"><code>mlserver_alibi_explain.AlibiExplainRuntime</code></td><td align="left">Coming Soon</td><td align="left"><a href="https://mlserver.readthedocs.io/en/latest/runtimes/alibi-explain.html" target="_blank" rel="noopener noreferrer">MLServer Alibi-Explain</a></td></tr></tbody></table><p>此外，想要开发一个自定义的推理运行时也十分容易，仅需要继承 <code> mlserver.MLModel</code>, 然后实现  <code>load </code>和 <code>predict</code>方法即可，常见的编码器MLServer已经提供，大部分可以直接复用，如果有特殊的媒体类型，开发一个自己的Codec也十分简单。这儿以transformers库为例，其推理运行时核心代码可以简化如下:</p><div class="codeBlockContainer_I0IT language-python-repl theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-python-repl codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">class MyCustomRuntime(MLModel):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 加载模型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def load(self) -&gt; bool:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        settings = get_settings_from_env()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pp = pipeline(**settings)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self._model = pp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # 执行推理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def predict(self, *args, **kwargs):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prediction = self._model(*args, **kwargs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return self.serialize(prediction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在load方法中通过transformers库的pipeline来加载模型，在predict方法中使用模型来执行推理，返回被编码器encode之后的推理结果。</p><blockquote><p>KubeGems 的 OpenMMLab 模型推理运行时就是一个自定义的推理运行时，但是尚未支持完所有任务类型。</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署体验">部署体验<a class="hash-link" href="#部署体验" title="Direct link to heading">​</a></h2><p>我们经将HuggingFace的相关元数据存放在了KubeGems模型商店中，快速部署一个模型已经十分方便。用户可以在KubeGems模型商店内根据任务类型找到感兴趣的模型，快速部署到自己的环境中。一图胜千言，可以看接下来这两个例子。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="运行-huggingface-图片语义分割任务image-segmentation">运行 HuggingFace 图片语义分割任务（Image Segmentation）<a class="hash-link" href="#运行-huggingface-图片语义分割任务image-segmentation" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/1673932616990.png" alt="1673932616990" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="运行huggingface-视觉问答任务-visual-question-answering">运行HuggingFace 视觉问答任务 （Visual Question Answering）<a class="hash-link" href="#运行huggingface-视觉问答任务-visual-question-answering" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://kubegems.oss-cn-chengdu.aliyuncs.com/kubegems.io/1673933034799.png" alt="1673933034799" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="一些限制和问题">一些限制和问题<a class="hash-link" href="#一些限制和问题" title="Direct link to heading">​</a></h2><ol><li>HuggingFace 并非所有模型都能直接下载，部分模型是需要授权的，这类模型在部署的时候需要提供一个被授权用户的Token，KubeGems仅帮助快速部署和体验模型，使用相关模型的时候还是休要遵守HuggingFace的一些协议，许可，策略等。</li><li>HuggingFace 的模型文件虽然放在了CDN上，但是中国大陆访问的时候，还是会出现下载非常缓慢的情况，特别是十几G以上的大模型。当然，在真实部署的时候，可以通过NFS共享模型卷的方式实现缓存加速，或者实现自己的缓存加速方案，这取决于部署的基础设施情况了，KubeGems 研发团队内部已经完成了一套缓存加速管理方案（这部分并未开源）。</li><li>MLServer 当前并没有提供像openapi schema这样的东西来直接生成接口描述文件，由于其主要支持 Predict Protocol V2 协议，用户只能通过v2协议的metadata来了解输入和输出，这点对于非算法相关背景的同学来说不是很友好。所以我们也在调研其他支持媒体类型的适配器，（如 讯飞的 <a href="https://github.com/iflytek/aiges%EF%BC%89%EF%BC%8C%E4%BB%A5%E5%B0%BD%E5%8F%AF%E8%83%BD%E9%99%8D%E4%BD%8E%E4%BD%BF%E7%94%A8%E8%BF%99%E4%BA%9B%E4%BC%98%E7%A7%80%E7%9A%84%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%88%90%E6%9C%AC%E5%92%8C%E6%8E%A5%E5%85%A5%E7%9A%84%E5%BC%80%E5%8F%91%E6%88%90%E6%9C%AC%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/iflytek/aiges），以尽可能降低使用这些优秀的模型的学习成本和接入的开发成本。</a></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/mlops">mlops</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/huggingface">huggingface</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/seldon">seldon</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/mlserver">mlserver</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 在 KubeGems 上运行 HuggingFace 模型" href="/blog/kubegems-ai"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-nacos">KubeGems 启用 Nacos 配置中心</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-09-14T00:00:00.000Z" itemprop="datePublished">2022年9月14日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/LinkMaq" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/LinkMaq.png" alt="LinkMaq"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/LinkMaq" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">LinkMaq</span></a></div><small class="avatar__subtitle" itemprop="description">developer@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="nacos-介绍">Nacos 介绍<a class="hash-link" href="#nacos-介绍" title="Direct link to heading">​</a></h2><p>Nacos 是阿里云开源一款在微服务场景下用于处理应用配置发布管理和服务注册管理的服务平台。其主要提供了如下几个特性：</p><ul><li><strong>服务发现和服务健康监测</strong></li></ul><p>基于 DNS 和 RPC 的服务发现。服务提供者使用 <a href="https://nacos.io/zh-cn/docs/sdk.html" target="_blank" rel="noopener noreferrer">原生SDK</a>、<a href="https://nacos.io/zh-cn/docs/open-api.html" target="_blank" rel="noopener noreferrer">OpenAPI</a>、或一个<a href="https://nacos.io/zh-cn/docs/other-language.html" target="_blank" rel="noopener noreferrer">独立的Agent TODO</a>注册 Service 后，服务消费者可以使用<a href="https://nacos.io/zh-cn/docs/xx" target="_blank" rel="noopener noreferrer">DNS TODO</a> 或<a href="https://nacos.io/zh-cn/docs/open-api.html" target="_blank" rel="noopener noreferrer">HTTP&amp;API</a>查找和发现服务。</p><ul><li><strong>动态配置服务</strong></li></ul><p>动态配置服务可以让您以中心化、外部化和动态化的方式管理所有环境的应用配置和服务配置。</p><ul><li><strong>动态 DNS 服务</strong></li></ul><p>动态 DNS 服务支持权重路由，让您更容易地实现中间层负载均衡、更灵活的路由策略、流量控制以及数据中心内网的简单DNS解析服务。</p><ul><li><strong>服务及其元数据管理</strong></li></ul><p>Nacos 从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及最首要的 metrics 统计数据。</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kubegems-中的-nacos">KubeGems 中的 Nacos<a class="hash-link" href="#kubegems-中的-nacos" title="Direct link to heading">​</a></h4><p>KubeGems 自v1.21版本之后开启了对 Nacos 配置中心的支持，并利用了内置 Plugins CRD 实现了对 Nacos 的快速启动。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/6a57af0e23c16e58a78472ae29f4bbf7.png" class="img_E7b_"></p><p>KubeGems 中的 Nacos 安装源来至官方社区提供<a href="https://github.com/nacos-group/nacos-k8s%EF%BC%8C%E5%B9%B6%E5%9C%A8" target="_blank" rel="noopener noreferrer">https://github.com/nacos-group/nacos-k8s，并在</a> plugin crd 中来管理部署的版本。用过 Nacos 的同学可能知道，其内部的数据模型主要围绕<code>dataid</code>、<code>group</code>和<code>namespace</code>这 3 个进行操作。由于 KubeGems 的设计是一个支持多租户的平台，所以在应用 nacos 数据模型时，按照了 <code>tenant + project</code>来区分内部的命名空间。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/bb863509816423e613ed977995dd4e2b.png" class="img_E7b_">
<img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/c9f4f887d094f244dd24262e3f073b01.png" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="启用和配置插件">启用和配置插件<a class="hash-link" href="#启用和配置插件" title="Direct link to heading">​</a></h2><p>KubeGems 启用 Nacos 需要具备系统管理员的权限进行操作。管理员进入管理后台的“插件管理”，点击“启用“按钮“即可开启Nacos。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/47c194e765849b11c82c0dd020d0a54a.png" class="img_E7b_"></p><p>直到出现如下状态，代表插件运行正常</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/41020365de048594c7a8c977756d6ce4.png" class="img_E7b_"></p><p>此时，我们就可以在租户的环境中开始使用 Nacos 服务</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/7cd5bcbdd802a5e73f952461a28eff6b.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="个性化配置">个性化配置<a class="hash-link" href="#个性化配置" title="Direct link to heading">​</a></h4><p>Nacos插件的配置以 CRD 的形式存放在 <code>nacos</code>命名空间中，我们可以通过命令<code>kubectl edit plugin nacos -n nacos</code>对插件进行个性化配置。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> plugins.kubegems.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">finalizers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> plugins.kubegems.io/finalizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">generation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//github.com/nacos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">group/nacos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nacos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nacos</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">replicaCount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">repository</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">beijing.aliyuncs.com/kubegems/nacos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v2.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">plugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">repository</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.cn</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">beijing.aliyuncs.com/kubegems/nacos</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">peer</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">finder</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">persistence</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">storageClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> master</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><blockquote><p>提示：KubeGems的插件 CRD 由 <a href="https://github.com/kubegems/bundle-controller%E6%8F%90%E4%BE%9B%E6%94%AF%E6%8C%81%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener noreferrer">https://github.com/kubegems/bundle-controller提供支持，我们也可以直接使用</a> bundle-controller 在非 kubegems 集群中管理插件。</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="集群部署">集群部署<a class="hash-link" href="#集群部署" title="Direct link to heading">​</a></h4><p>Nacos集群由社区提供支持部署，kubegems 默认将 nacos 的全局运行模式设置为“cluster”，如果您需要扩展成多集群，只需修改<code>replicaCount</code>的副本数为 3 即可。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/a092ff1c77944d29af215bf903a6982c.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="开放集群外访问">开放集群外访问<a class="hash-link" href="#开放集群外访问" title="Direct link to heading">​</a></h4><p>Nacos 插件默认运行在 Kubernetes 内部，如果需要在集群外访问 Nacos 需借助网关实现。管理员可以在后台创建一条基于默认网关的 ingress 来代理 nacos api。过程如下：</p><p>第一步： 进入路由功能页面，选择 nacos 命名空间</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/fa34c978d12936cc2a469cb566e2321b.png" class="img_E7b_"></p><p>第二步：创建并提交一条路由规则，用于 nacos 的代理</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/c7522700c7fe0f5b1f280248053a40df.png" class="img_E7b_"></p><p>第三步：获取访问地址</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/17b723e385f2876158498785b1c72809.png" class="img_E7b_"></p><blockquote><p>提示：Nacos2.0版本相比1.X新增了gRPC的通信方式，因此需要增加2个端口。新增端口是在配置的主端口(server.port)基础上，进行一定偏移量自动生成</p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="使用配置中心">使用配置中心<a class="hash-link" href="#使用配置中心" title="Direct link to heading">​</a></h2><p>进入应用环境下的“应用配置”，可以点击右上角的“获取访问信息”查看当前环境下的 nacos sdk 所需的配置信息</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/97b1cffe1e6100e3d93977b1d35fbf34.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="配置管理">配置管理<a class="hash-link" href="#配置管理" title="Direct link to heading">​</a></h4><p>点击“创建配置项”就可以创建配置</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/4341eb874c2c223fef96e4ec9565b0a6.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="配置历史与回滚">配置历史与回滚<a class="hash-link" href="#配置历史与回滚" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/0a8b985cf5f1e096abba2065a6219d20.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="监听列表">监听列表<a class="hash-link" href="#监听列表" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/a9c008358d95739108e1ade1cf86322a.png" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="运行测试">运行测试<a class="hash-link" href="#运行测试" title="Direct link to heading">​</a></h2><p>我们用 <code>nacos-sdk-go/v1</code>来做一个简单的认证</p><div class="codeBlockContainer_I0IT language-golang theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-golang codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">package main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;fmt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/nacos-group/nacos-sdk-go/clients&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/nacos-group/nacos-sdk-go/common/constant&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;github.com/nacos-group/nacos-sdk-go/vo&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">func main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sc := []constant.ServerConfig{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            IpAddr: &quot;nacos.kubegems.io&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Port:   31956,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cc := constant.ClientConfig{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NamespaceId:         &quot;69f7325702bc396a8773f9a0a94eea310b21ec39&quot;, //namespace id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TimeoutMs:           5000,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NotLoadCacheAtStart: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LogDir:              &quot;/tmp/nacos/log&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CacheDir:            &quot;/tmp/nacos/cache&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LogLevel:            &quot;debug&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client, err := clients.NewConfigClient(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vo.NacosClientParam{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClientConfig:  &amp;cc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ServerConfigs: sc,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        panic(err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    content, err := client.GetConfig(vo.ConfigParam{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataId: &quot;test&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Group:  &quot;e3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt.Println(&quot;GetConfig,config :&quot; + content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err = client.ListenConfig(vo.ConfigParam{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataId: &quot;test&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Group:  &quot;e3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OnChange: func(namespace, group, dataId, data string) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fmt.Println(&quot;config changed group:&quot; + group + &quot;, dataId:&quot; + dataId + &quot;, content:&quot; + data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time.Sleep(300 * time.Second)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>以下是运行情况</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/adf3c66aa6bf8bdd4a798686a091eb89.gif" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><p>本文主要介绍了在 KubeGems 中启用并使用Nacos插件作为应用的配置中心的基本管理功能。Nacos 是一个非常棒的应用配置管理平台，KubeGems 团队将持续关注此项目，并为用户在 Kubernetes 集群提供更友好的支持。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/nacos">nacos</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about KubeGems 启用 Nacos 配置中心" href="/blog/kubegems-nacos"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-kind">使用 Kind 快速部署体验 KubeGems</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-09-05T00:00:00.000Z" itemprop="datePublished">2022年9月5日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/LinkMaq" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/LinkMaq.png" alt="LinkMaq"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/LinkMaq" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">LinkMaq</span></a></div><small class="avatar__subtitle" itemprop="description">developer@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote><p><a href="https://kind.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">Kind</a>是Kubernetes In Docker的缩写，通过使用 Docker ，它能快速的拉起一套 Kubernetes 服务。因此它在Kubernetes功能测试和二开等领域被广泛使用。</p></blockquote><blockquote><p><strong>KubeGems</strong>是一款以围绕 Kubernetes 通过自研和集成云原生项目而构建的通用性开源 PaaS 云管理平台。经过我们内部近一年的持续迭代，当前 KubeGems 的核心功能已经初步具备多云多租户场景下的统一管理。并通过插件化的方式，在用户界面中灵活控制包括 <strong>监控系统</strong>、<strong>日志系统</strong>、<strong>微服务治理</strong> 等众多插件的启用和关闭。</p></blockquote><p>本文将指导用户使用 Kind 快速部署一个 KubeGems v1.21的版本用于本地测试。</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="安装-kind">安装 Kind<a class="hash-link" href="#安装-kind" title="Direct link to heading">​</a></h2><p>在 Linux 上</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -Lo ./kind https://github.com/kubegems/kind/releases/download/v0.15.0-alpha-kubegems/kind-linux-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x ./kind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> ./kind /usr/local/bin/kind</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在 MacOS 上</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># for Intel Macs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -m</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x86_64 </span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -Lo ./kind https://github.com/kubegems/kind/releases/download/v0.15.0-alpha-kubegems/kind-darwin-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># for M1 / ARM Macs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">uname</span><span class="token variable" style="color:#36acaa"> -m</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> arm64 </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -Lo ./kind https://github.com/kubegems/kind/releases/download/v0.15.0-alpha-kubegems/kind-darwin-arm64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x ./kind</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> ./kind /some-dir-in-your-</span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token plain">/kind</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在 Windows 上</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl.exe -Lo kind-windows-amd64.exe ./kind https://github.com/kubegems/kind/releases/download/v0.15.0-alpha-kubegems/kind-windows-amd64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Move-Item .</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">kind-windows-amd64.exe c:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">some-dir-in-your-</span><span class="token environment constant" style="color:#36acaa">PATH</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">kind.exe</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="创建服务">创建服务<a class="hash-link" href="#创建服务" title="Direct link to heading">​</a></h2><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="single-cluster">Single Cluster<a class="hash-link" href="#single-cluster" title="Direct link to heading">​</a></h4><p>和创建 Kubernetes 集群一样，使用命令<code>kind create cluster</code>就能快速拉起一个 Kubernetes 服务并部署 KubeGems
<img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/3657c5205677e4e218c3af9ca78d49a8.png" alt="image-20220805141017484.png" class="img_E7b_"></p><p>由于不需要定制<code>kindest/node</code>镜像，所以 KubeGems安装全程需要连接公网下载所需的镜像。在启动完成之前会有许多 Pod 的状态为 <code>CrashLoopBackOff</code>，这是由于其依赖的服务（mysql、redis、gitea、argocd 等）还在启动中，这是正常的，请耐心等待。</p><p>kubegems 所有服务部署并启动完成后会有如下 pod</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/fb5260ef6c4a10fa34e4b3ee832c9011.png" alt="image-20220805141327441.png" class="img_E7b_"></p><p>当容器状态全部<code>Running</code>后，使用 port-forward 将 KubeGems Dashboard 服务映射到本地</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward svc/kubegems-dashboard :80 -n kubegems                           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forwarding from </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:52302 -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Forwarding from </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">::1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:52302 -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8000</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>此时，我们打开浏览器访问 <code>http://localhost:52302</code>即可访问 KubeGems，默认用户<code>admin</code> 默认密码<code>demo!@#admin</code></p><blockquote><p>使用 Kind 生成的 KubeConfig文件导入集群是，注意修改集群 Server 地址为内部地址<code>http://kubernetes.default:443</code></p></blockquote><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/750cf1eb84463f564fd6c1cf00b2bac5.png" alt="image-20220805144837887.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mutil-cluster">Mutil Cluster<a class="hash-link" href="#mutil-cluster" title="Direct link to heading">​</a></h4><p>如果您需要使用 Kind 部署一个 Kubernetes 集群，那么可以按照如下配置</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cat ./kind.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kind.x</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s.io/v1alpha4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">nodes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> control</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> control</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> control</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> worker</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>并通过命令 <code>kind create cluster --config kind.yaml</code></p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/a4cc811c69ba68cfc166887d56c8829b.png" alt="image-20220805143833694.png" class="img_E7b_"></p><p>打开 KubeGems 后台并导入集群后，我们便可以在机器列表中查看集群内主机数量</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/962f40e48dd8fcacbcf5c5259e6e2e60.png" alt="image-20220805145229274.png" class="img_E7b_"></p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="指定-kubernetes版本创建-kubegems">指定 Kubernetes版本创建 KubeGems<a class="hash-link" href="#指定-kubernetes版本创建-kubegems" title="Direct link to heading">​</a></h4><p>如果您要在指定的 Kubernetes 版本中创建 KubeGems，只需要kind 在创建过程中指定<code>kindest/node</code>镜像版本即可</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kind create cluster  --image kindest/node:v1.23.6</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="启用插件">启用插件<a class="hash-link" href="#启用插件" title="Direct link to heading">​</a></h4><p>默认情况下 KubeGems 只做了最小化安装，如果您要启用更多功能，可在管理员后台的<code>组件管理</code>中启用相关插件</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/7305b799c99f47e6dac62bc610572ce8.png" alt="image-20220805145350662.png" class="img_E7b_"></p><hr></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kind">kind</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 使用 Kind 快速部署体验 KubeGems" href="/blog/kubegems-kind"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/blog/kubegems-skywalking">基于KubeGems可视化搭建SkyWalking</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-06-23T00:00:00.000Z" itemprop="datePublished">2022年6月23日</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><span class="avatar__photo-link avatar__photo"><a href="https://github.com/liutao-east" target="_blank" rel="noopener noreferrer"><img class="image_o0gy" src="https://github.com/liutao-east.png" alt="liutao"></a></span><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/liutao-east" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">liutao</span></a></div><small class="avatar__subtitle" itemprop="description">contributor@kubegems.io</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Apache Skywalking</a> 专门为微服务架构和云原生架构系统而设计并且支持分布式链路追踪的APM系统。<a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Apache Skywalking</a> 通过加载探针的方式收集应用调用链路信息，并对采集的调用链路信息进行分析，生成应用间关系和服务间关系以及服务指标。<a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Apache Skywalking</a> 目前支持多种语言，其中包括 <a href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener noreferrer">Java</a>，<a href="https://github.com/OpenSkywalking/skywalking-netcore" target="_blank" rel="noopener noreferrer">.Net Core</a>，<a href="https://github.com/OpenSkywalking/skywalking-nodejs" target="_blank" rel="noopener noreferrer">Node.js</a> 和 <a href="https://github.com/OpenSkywalking/skywalking-go" target="_blank" rel="noopener noreferrer">Go</a> 语言。本文将从以 KubeGems 应用商店出发，来快速搭建一套Skywalking，希望能够帮助到大家。</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="安装skywalking-oap">安装SkyWalking OAP<a class="hash-link" href="#安装skywalking-oap" title="Direct link to heading">​</a></h2><blockquote><p>KubeGems应用商店(HelmChart)是一个描述Kubernetes相关资源的文件集合，单个应用可以用来部署某些复杂的HTTP服务器以及Web全栈应用、数据库、缓存等</p></blockquote><ol><li><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="elasticsearch安装">Elasticsearch安装<a class="hash-link" href="#elasticsearch安装" title="Direct link to heading">​</a></h3></li></ol><p>在KubeGems应用商店中找到Elasticsearch</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/12ad60c8cc85f5045a1ee8a8f445261d.png" class="img_E7b_"></p><p>选择部署7.13.2版本，填写必要的【项目】、【环境】等信息</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/223d171147da56a82cb509968568f858.png" alt="img" class="img_E7b_"></p><p>为方便演示，Master、ES副本数都配置为1，可根据实际需要配置参数，还可以修改 <code>Values</code> 中的配置</p><p>SkyWalking 初始化 ElasticSearch index 的是默认规则是 1 副本 1 分片，实际在使用中ElasticSearch 的实例数最好大于 2 个</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/ab6bec19080bfa2eaf357c5aa5adee8b.png" alt="img" class="img_E7b_"></p><p>点击部署，ES服务搭建完成。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/5732a57c4733b7001c28dbee0cec1bf9.png" alt="img" class="img_E7b_"></p><ol><li><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalking安装">SkyWalking安装<a class="hash-link" href="#skywalking安装" title="Direct link to heading">​</a></h3></li></ol><p>同样在应用商店找到skywalking应用，填写基本信息，进入详细配置页，将数据设置为ES应用名称与端口</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/f8c24482817f6d19af4db47e08b06544.png" alt="img" class="img_E7b_"></p><p>点击部署，可以看到skywalking-oap、skywalking-ui服务已经部署完成</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/a0bde3d10539ffb239e0772921c84f85.png" alt="img" class="img_E7b_"></p><p>在KubeGems控制台，找到容器服务--&gt;运行时--&gt;路由，创建路由，将skywalking-ui服务地址进行域名映射。我这里直接采用随机域名，用户可以根据自己公司内的域名手动配置。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/4ea6c436becd2f6c9e6ec6d0f16c5d78.png" alt="img" class="img_E7b_"></p><p>在浏览器中打开路由访问地址，已经能正常看skywalking-ui的页面了</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/5c93cd6a4ac9c193f61edb3c92b156db.png" alt="img" class="img_E7b_"></p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/212b4f67b1839059813b35704ff9ad0c.png" alt="img" class="img_E7b_"></p><p>skywalking服务搭建完成啦，是不是非常的快速方便，哈哈哈哈哈😄</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalking-agent">SkyWalking Agent<a class="hash-link" href="#skywalking-agent" title="Direct link to heading">​</a></h2><blockquote><p>所谓Agent是指SkyWalking从各个平台(Java Python等)收集监控数据的代理，此处我们以为Java应用为例，收集Java应用产生的各种监控数据</p></blockquote><p>SkyWalking的数据采集主要是通过<strong>业务探针(Agent)</strong>来实现的，针对不同的编程语言SkyWalking提供了对应的Agent实现。Java微服务接入SkyWalking可以使用“SkyWalking Java Agent”来上报监控数据。</p><p>这就需要Java微服务在部署启动的过程中需要获取 <strong>SkyWalking Java Agent</strong> 探针包，并在启动参数中通过<code>--javaagent:xxx</code>进行参数指定。而具体的集成方式大致有以下四种：</p><ul><li><p>使用官方提供的基础镜像；</p></li><li><p>将agent包构建到已存在的基础镜像中；</p></li><li><p>将agent包放到共享volume中;</p></li><li><p>通过sidecar 模式挂载agent；</p></li></ul><p>其中前两种方式主要是通过在构建Docker镜像的过程中将Agent依赖打包集成到Java服务的Docker镜像中，而sidecar模式则是利用k8s的相关特性来实现在<strong>容器启动时挂载Agent</strong>相关依赖。</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="为什么选择sidecar">为什么选择sidecar<a class="hash-link" href="#为什么选择sidecar" title="Direct link to heading">​</a></h3><p>Sidecard主要原理是通过Kubernetes的初始化容器<code>initContainers</code>来实现的，<code>initContainers</code>是一种专用容器，它应用容器启动之前运行，可以用于完成应用启动前的必要初始化工作。如果微服务是直接部署在 Kubernetes 集群，那么采用 sidecar 模式来使用 SkyWalking Agent会更加方便，因为这种方式<strong>不需要修改原来的基础镜像，也不需要重新构建新的服务镜像</strong>，而是会以sidecar模式，通过共享的volume将agent所需的相关文件直接挂载到已经存在的服务镜像中。</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="初始化容器initcontainers">初始化容器InitContainers<a class="hash-link" href="#初始化容器initcontainers" title="Direct link to heading">​</a></h3><p>InitContainers 就是用来做初始化工作的容器，可以是一个或者多个，如果有多个的话，这些容器会按定义的顺序依次执行，只有所有的initContainers执行完后，主容器才会被启动。我们知道一个Pod里面的所有容器是共享数据卷和网络命名空间的，所以<code>initContainers</code>里面产生的数据可以被主容器使用到的</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="自定义skywalking-agent镜像"><strong>自定义SkyWalking Agent镜像</strong><a class="hash-link" href="#自定义skywalking-agent镜像" title="Direct link to heading">​</a></h3><ul><li>下载SkyWalking官方发行包，并解压到指定目录</li></ul><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#下载skywalking-8.6.0 for es7版本的发布包，与部署的skywalking后端版本一致</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ wget https://archive.apache.org/dist/skywalking/8.6.0/apache-skywalking-apm-8.6.0.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#将下载的发布包解压到当前目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tar -zxvf apache-skywalking-apm-es7-8.6.0.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>修改配置，编辑config/agent.config文件，以下只列出部分配置项</li></ul><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># The agent namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># agent.namespace=${SW_AGENT_NAMESPACE:default-namespace}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 表示提供相同功能/逻辑的逻辑组的服务名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">agent.service_name=${SW_AGENT_NAME:Your_ApplicationName}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># OAP服务地址，修改默认地址为skywalking-oap服务名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collector.backend_service=${SW_AGENT_COLLECTOR_BACKEND_SERVICES:skywalking-oap:11800}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 日志文件名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging.file_name=${SW_LOGGING_FILE_NAME:skywalking-api.log}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 日志级别：TRACE、DEBUG、INFO、WARN、ERROR、OFF。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging.level=${SW_LOGGING_LEVEL:INFO}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 最大历史日志文件。发生翻转时，如果日志文件超过此数量，则最旧的文件将被删除。默认情况下，负数或零表示关闭。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging.max_history_files=${SW_LOGGING_MAX_HISTORY_FILES:10}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 挂载插件的特定文件夹。安装文件夹中的插件可以工作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin.mount=${SW_MOUNT_FOLDERS:plugins,activations,bootstrap-plugins}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 排除插件目录中定义的一些插件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># plugin.exclude_plugins=${SW_EXCLUDE_PLUGINS:}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>构建skywalking-agent sidecar 镜像并push至hub私有镜像仓库</li></ul><p>在前面步骤中解压的skywalking发行包，进入agent目录编写Dockerfile文件</p><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">FROM busybox:latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN set -eux &amp;&amp; mkdir -p /usr/skywalking/agent/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COPY . /usr/skywalking/agent/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>完成Docker文件编写后，执行镜像构建命令：</li></ul><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain"># 构建镜像，注意最后一个.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t &lt;your-registry&gt;/skywalking-agent-sidecar:8.6.0 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 镜像推送至私有Harbor仓库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker push &lt;your-registry&gt;/skywalking-agent-sidecar:8.6.0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="sidecar挂载">sidecar挂载<a class="hash-link" href="#sidecar挂载" title="Direct link to heading">​</a></h3><p>在KubeGems中找到 【工作负载】，编辑更新工作负载进入到容器镜像页面</p><p><strong>设置SW环境变量</strong>，编辑工作容器 </p><ul><li>SW_AGENT_NAME=\&lt;YourApplicationName<!-- -->&gt;</li><li>JAVA_TOOL_OPTIONS=-javaagent:/usr/skywalking/agent/skywalking-agent.jar</li></ul><p><strong>添加容器镜像</strong>，选择初始化容器将skywalking-agent-sidecard镜像进行挂载，并添加启动命令</p><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">sh -c /usr/skywalking/agent/* /skywalking/agent</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/cad0e71470d041f2ef2dbf86da258abc.png" alt="img" class="img_E7b_"></p><p><strong>挂载emptyDir卷</strong></p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/e34455919c3c6dbd6334609aad32bd26.png" alt="img" class="img_E7b_"></p><p>点击确定保存工作负载信息，自动重启后进入应用容器，可以看到agent目标已经加载到容器中了</p><div class="codeBlockContainer_I0IT language-Bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-Bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">root@pod-7bc77468ff-7b4xt:/# cd /usr/skywalking/agent/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@pod-7bc77468ff-7b4xt:/usr/skywalking/agent# ll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 17716</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxrwxrwx 9 root root      194 May 19 08:14 ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 3 root root       27 May 19 08:14 ../</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root      114 May 19 08:14 Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root     4096 May 19 08:14 activations/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       85 May 19 08:14 bootstrap-plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       64 May 19 08:14 config/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       32 May 19 08:14 logs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root     4096 May 19 08:14 optional-plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root       45 May 19 08:14 optional-reporter-plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 2 root root     4096 May 19 08:14 plugins/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 18121582 May 19 08:14 skywalking-agent.jar</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>此时打开skywalking-ui，已经可以看到监控数据了</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/144d7ab53fc6553098b3e70193f2a74d.png" alt="img" class="img_E7b_"></p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalking动态配置">SkyWalking动态配置<a class="hash-link" href="#skywalking动态配置" title="Direct link to heading">​</a></h2><p>SkyWalking配置主要是通过<code>application.yml</code>操作系统环境变量设置的，其中一些还支持来自上游管理系统的动态设置。上游服务支持包括Zookeeper、Etcd、Consul、Apollo、Nacos、K8s-configmap等。</p><p>目前SkyWalking支持以下动态配置</p><table><thead><tr><th align="center">配置</th><th align="left">说明</th></tr></thead><tbody><tr><td align="center">agent-analyzer.default.slowDBAccessThreshold</td><td align="left"><code>receiver-trace/default/slowDBAccessThreshold</code>慢数据库语句的阈值，覆盖<code>application.yml</code>.</td></tr><tr><td align="center">agent-analyzer.default.uninstrumentedGateways</td><td align="left">未检测的网关覆盖<code>gateways.yml</code>.</td></tr><tr><td align="center">alarm.default.alarm-settings</td><td align="left">警报设置将覆盖<code>alarm-settings.yml</code>。</td></tr><tr><td align="center">core.default.apdexThreshold</td><td align="left">apdex 阈值设置，将覆盖<code>service-apdex-threshold.yml</code>.</td></tr><tr><td align="center">core.default.endpoint-name-grouping</td><td align="left">端点名称分组设置，将覆盖<code>endpoint-name-grouping.yml</code>.</td></tr><tr><td align="center">agent-analyzer.default.sampleRate</td><td align="left">跟踪采样，覆盖<code>receiver-trace/default/sampleRate</code>.<code>application.yml</code></td></tr><tr><td align="center">agent-analyzer.default.slowTraceSegmentThreshold</td><td align="left">设置这个关于延迟的阈值将使慢跟踪段在花费更多时间时被采样，即使采样机制被激活。默认值为<code>-1</code>，这意味着不会对慢速跟踪进行采样。单位，毫秒。的覆盖<code>receiver-trace/default/slowTraceSegmentThreshold</code>。<code>application.yml</code></td></tr><tr><td align="center">configuration-discovery.default.agentConfigurations</td><td align="left">ConfigurationDiscovery 设置</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="k8s-configmap">k8s-configmap<a class="hash-link" href="#k8s-configmap" title="Direct link to heading">​</a></h3><blockquote><p>很多应用在其初始化或运行期间要依赖一些配置信息。大多数时候， 存在要调整配置参数所设置的数值的需求。 ConfigMap 是 Kubernetes 用来向应用 Pod 中注入配置数据的方法。</p></blockquote><p>本文介绍如何通过KubGems平台动态配置SkyWalking参数</p><ul><li>KubGems工作台 --&gt; 配置中心 --&gt; 配置 --&gt; 创建配置</li><li>添加参数及告警规则配置</li></ul><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/ae9fc31a7b36272e16f1ecaa7a686a4b.png" alt="img" class="img_E7b_"></p><ul><li>编辑yaml，添加修改app、compoent标签值</li></ul><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: skywalking-dynamic-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: &#x27;2022-05-16T11:14:23Z&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    component: oap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  agent-analyzer.default.sampleRate: &#x27;7000&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  agent-analyzer.default.slowDBAccessThreshold: default:250,mongodb:100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  alarm.default.alarm-settings: &gt;-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Rule unique name, must be ended with `_rule`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service_resp_time_rule:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metrics-name: service_resp_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        op: &quot;&gt;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threshold: 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        period: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        silence-period: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        message: 最近3分钟内服务 {name} 的平均响应时间超过2秒</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>修改skywalking-oap环境变量信息，使用k8s-configmap配置</li></ul><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: skywalking-oap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: skywalking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/instance: skywalking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: SW_CLUSTER_K8S_LABEL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: app=skywalking,component=oap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: SW_CONFIGURATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value: k8s-configmap</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><blockquote><p><code>SW_CONFIGURATION= k8s-configmap</code>，动态配置采用k8s-configmap
<code>SW_CLUSTER_K8S_LABEL= app=collector,release=skywalking</code>，根据这个值自动选择合适的configmap</p></blockquote><ul><li>重启skywalking-oap，配置生效</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="skywalking配置优化">SkyWalking配置优化<a class="hash-link" href="#skywalking配置优化" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="oap优化">OAP优化<a class="hash-link" href="#oap优化" title="Direct link to heading">​</a></h3><p> skywalking写入ES的操作是使用了ES的批量写入接口，我们要做的是调整相关参数尽量降低ES索引的写入频率。 参数调整主要是针对skywalking的配置文件`<code>application.yml</code>，相关参数如下：  </p><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">storage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elasticsearch:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:4000} # Execute the bulk every 2000 requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bulkSize: ${SW_STORAGE_ES_BULK_SIZE:40} # flush the bulk every 20mb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:30} # flush the bulk every 10 seconds whatever the number of requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:4} # the number of concurrent requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadataQueryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:8000}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>调整 bulkActions 默认2000次请求批量写入一次改到4000次；</p><ul><li><p>bulkSize批量刷新从20M一次到40M一次；</p></li><li><p>flushInterval每10秒刷新一次堆改为每30秒刷新；</p></li><li><p>concurrentRequests查询的最大数量由5000改为8000。</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="过滤不需要监控的接口">过滤不需要监控的接口<a class="hash-link" href="#过滤不需要监控的接口" title="Direct link to heading">​</a></h3><ul><li><p>制作agent镜像时，将<code>apm-trace-ignore-plugin-8.6.0.jar</code>复制到<code>\plugins</code>下面</p></li><li><p>config目录下新建一个配置文件 <code>apm-trace-ignore-plugin.config</code>，文件内容为： </p></li></ul><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">trace.ignore_path=${SW_AGENT_TRACE_IGNORE_PATH:/actuator,/actuator/**,/admin/**,/nacos/**}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="设置采样率">设置采样率<a class="hash-link" href="#设置采样率" title="Direct link to heading">​</a></h3><p> 在默认情况下，SkyWalking会采集所有追踪的数据。但是如果系统比较复杂，采集的端点比较多的时候，可能存储压力比较大，这个时候我们可以修改配置，只存储部分的调用链路信息。比如：50%。 设置采样率的时候并不会影响相关指标的计算。包括服务，服务实例，端点，拓扑图等相关指标的计算还是使用完整的数据计算的。 </p><p>在k8s-configmap中，添加配置项，设置采样率为70%:</p><div class="codeBlockContainer_I0IT language-YAML theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-YAML codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">agent-analyzer.default.sampleRate: &#x27;7000&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><p>本文用于指导用于在 KubeGems 中快速部署并运行 SkyWalking服务，用户可在研发环境中快速启用此功能来验证 APM 相关功能。更多关于KubeGems 与 SkyWalking 的配置优化，我们会持续更新，敬请关注。</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/tracing">tracing</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/observability">observability</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/kubegems">kubegems</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about 基于KubeGems可视化搭建SkyWalking" href="/blog/kubegems-skywalking"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer" id="footer"><div class="row"><div class="col col--2"><img src="/img/logo.svg" style="margin-top:35px"></div><div class="col col--7"><div class="row"><div class="col col--2"></div><div class="col col--10"><div class="footer__div_HPxS"><div class="footer__link_e9CW">文档</div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/installation/kubegems-install/offline">离线安装</a></div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/installation/kubegems-install/self-hosted">快速安装</a></div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/category/快速入门">快速入门</a></div><div><a class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700" href="/docs/category/开发指南">API文档</a></div></div><div class="footer__div_HPxS"><div class="footer__link_e9CW">社区</div><div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/github-icon.svg">Github</a></div><div><a href="https://kubegems.slack.com/" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/slack-icon.svg">Slack</a></div><div><a href="https://twitter.com/KubeGems" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/twitter.svg">Twitter</a></div><div><a href="https://www.youtube.com/@LinkMaq1" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/youtube-icon.svg">YouTube</a></div><div><a href="https://space.bilibili.com/316793859" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px"><img width="16px" style="margin-right:5px" src="/img/page/bilibili.png">Bilibili</a></div></div><div class="footer__div_HPxS"><div class="footer__link_e9CW">更多</div><div><a class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px" href="/blog">Blog</a></div><div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2 footer__link__font_id2E" style="margin-bottom:30px">Github</a></div><div><a href="mailto:support@kubegems.io" target="_blank" rel="noopener noreferrer" class="footer__link__color_f_j2" style="margin-bottom:30px;font-weight:700">联系我们</a></div></div></div></div></div><div class="col col--1" style="margin-top:20px"><img src="/img/page/qrcode.png"></div><div class="col col--2" style="margin-top:20px"><div><div>Web: https://kubegems.io</div><div>Email: support@kubegems.io</div></div><div style="margin-top:5px"><div class="footer__title_ryMd">更便捷的云原生管理平台</div><div>Simplify your cloud native journey</div></div></div></div><div class="text--center" style="margin-top:30px">Copyright © 2023 kubegems.io .</div></footer></div>
<script src="/assets/js/runtime~main.3344d940.js"></script>
<script src="/assets/js/main.7e3053f7.js"></script>
</body>
</html>